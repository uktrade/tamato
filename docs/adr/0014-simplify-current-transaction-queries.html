
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>14. Simplification of current transaction queries &#8212; TaMaTo 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Business Rules" href="../business_rules/index.html" />
    <link rel="prev" title="13. Import TARIC nomenclature updates" href="0013-import-taric-nomenclature-updates.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../business_rules/index.html" title="Business Rules"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0013-import-taric-nomenclature-updates.html" title="13. Import TARIC nomenclature updates"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TaMaTo 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../project.html" >Project Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Architectural Decision Records</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">14. Simplification of current transaction queries</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="simplification-of-current-transaction-queries">
<h1>14. Simplification of current transaction queries<a class="headerlink" href="#simplification-of-current-transaction-queries" title="Permalink to this headline">¶</a></h1>
<p>Date: 2021-09-27</p>
<section id="status">
<h2>Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p>Approved</p>
</section>
<section id="context">
<h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">¶</a></h2>
<p>The TaMaTo application keeps a version history of the UK tariff, with each
version of a record having a version ID and an associated transaction ID.
TaMaTo enables users to create draft edits to the tariff, and these are
stored in the database as unpublished versions.</p>
<p>When querying the database, either to display the current UK tariff details, or
to check business rules are not violated, those queries must specify the
“current” transaction to fetch only the versions of records that are pertinent.
This is further complicated by the need to fetch unpublished versions when
querying data that has been modified in the user’s current session.</p>
<p>This complication affects several aspects of the application:</p>
<ol class="arabic simple">
<li><p>Data entry. When users enter data into forms, the options they are presented
with are retrieved from the database. These options must be only those that
are valid at the time of the request, and must not include any historical
versions.</p></li>
<li><p>Business rules. The current workbasket contains versions of database records
which are not yet considered fact, but must be included in business rule
queries to check that when they are published in the tariff they will not
violate those rules.</p></li>
</ol>
</section>
<section id="alternatives-considered">
<h2>Alternatives considered<a class="headerlink" href="#alternatives-considered" title="Permalink to this headline">¶</a></h2>
<section id="thread-local-storage">
<h3>Thread-local storage<a class="headerlink" href="#thread-local-storage" title="Permalink to this headline">¶</a></h3>
<p>We store the current transaction in thread-local storage as a sort of global variable
that provides the context to all queries in the current thread - this avoids
interference with other concurrent requests to the application. <a class="reference external" href="https://django-crum.readthedocs.io/en/latest/">Django-CRUM</a> provides an
API to managing thread-local storage.</p>
<p>Some Django form fields (eg <code class="docutils literal notranslate"><span class="pre">ModelChoiceField</span></code>) take a queryset as an initialisation
argument and execute the query at render-time. In this case, we want to construct a
queryset that retrieves the current transaction at execution time and not at
initialisation. To ensure we fetch the current transaction ID value at query execution
time, we can use a dynamic <a class="reference external" href="https://docs.djangoproject.com/en/dev/ref/models/expressions/#value-expressions"><code class="docutils literal notranslate"><span class="pre">Value</span></code></a> object, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">crum</span> <span class="kn">import</span> <span class="n">get_current_request</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">IntegerField</span><span class="p">,</span> <span class="n">Value</span>

<span class="kn">from</span> <span class="nn">workbaskets.models</span> <span class="kn">import</span> <span class="n">WorkBasket</span>


<span class="k">class</span> <span class="nc">CurrentTransactionId</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;output_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
        <span class="c1"># skip Value constructor which assigns to self.value</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">get_current_request</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">:</span>
            <span class="n">transaction</span> <span class="o">=</span> <span class="n">WorkBasket</span><span class="o">.</span><span class="n">get_current_transaction</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">transaction</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">transaction</span><span class="o">.</span><span class="n">id</span>

        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>This allows us to construct a queryset that fetches the current transaction at query
execution time:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Footnotes</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">transaction_id</span><span class="o">=</span><span class="n">CurrentTransactionId</span><span class="p">())</span>
</pre></div>
</div>
<p>Using these dynamic <code class="docutils literal notranslate"><span class="pre">Value</span></code> objects, we can refactor <code class="docutils literal notranslate"><span class="pre">latest_approved</span></code> and
<code class="docutils literal notranslate"><span class="pre">approved_up_to_transaction</span></code> as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">latest_approved</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">transaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Transaction</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrackedModelQuerySet</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the approved versions of the model, or the latest draft versions if they</span>
<span class="sd">    exist within a transaction preceding (and including) the given transaction in</span>
<span class="sd">    the workbasket of the given transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">transaction</span><span class="p">:</span>
        <span class="n">current_workbasket_id</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">workbasket</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">output_field</span><span class="o">=</span><span class="n">IntegerField</span><span class="p">())</span>
        <span class="n">transaction_order</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">order</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># dynamic values defined similarly to CurrentTransactionId above</span>
        <span class="n">current_workbasket_id</span> <span class="o">=</span> <span class="n">CurrentWorkBasketId</span><span class="p">()</span>
        <span class="n">transaction_order</span> <span class="o">=</span> <span class="n">CurrentTransactionOrder</span><span class="p">()</span>

    <span class="n">is_current_version</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">is_current__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">in_current_workbasket</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
        <span class="n">transaction__workbasket_id</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;current_workbasket_id&quot;</span><span class="p">),</span>
        <span class="n">transaction__order__lte</span><span class="o">=</span><span class="n">transaction_order</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">versions_in_workbasket</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
        <span class="n">version_group__versions__transaction__workbasket_id</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;current_workbasket_id&quot;</span><span class="p">),</span>
        <span class="n">version_group__versions__transaction__order__lte</span><span class="o">=</span><span class="n">transaction_order</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">latest_version_id</span> <span class="o">=</span> <span class="n">Max</span><span class="p">(</span>
        <span class="s2">&quot;version_group__versions&quot;</span><span class="p">,</span>
        <span class="nb">filter</span><span class="o">=</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">current_workbasket_id__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">versions_in_workbasket</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">unapproved_if_no_workbasket</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">current_workbasket_id__isnull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_current__isnull</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">older_versions_in_workbasket</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">current_workbasket_id__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">latest</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>

    <span class="n">deletions</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">update_type</span><span class="o">=</span><span class="n">UpdateType</span><span class="o">.</span><span class="n">DELETE</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">current_workbasket_id</span><span class="o">=</span><span class="n">current_workbasket_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_current_version</span> <span class="o">|</span> <span class="n">in_current_workbasket</span><span class="p">)</span>
        <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">latest</span><span class="o">=</span><span class="n">latest_version_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">unapproved_if_no_workbasket</span><span class="p">)</span>
        <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">older_versions_in_workbasket</span><span class="p">)</span>
        <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">deletions</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>This allows initialising (for example) a <code class="docutils literal notranslate"><span class="pre">ModelChoiceField</span></code> with a queryset that uses the current
transaction at form render time:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">measure_type</span> <span class="o">=</span> <span class="n">ModelChoiceField</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">MeasureType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">latest_approved</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="temporal-database-extension">
<h3>Temporal database extension<a class="headerlink" href="#temporal-database-extension" title="Permalink to this headline">¶</a></h3>
<p>We extend the Postgres database with a temporal tables extension, which handles the
versioning of data so that we do not have to do it in our code. Compiled extensions may
not be permitted to install on our hosted database servers, so <a class="reference external" href="https://github.com/nearform/temporal_tables">nearform/temporal_tables</a>
could be used instead as it is implemented in PL/SQL.</p>
<p>This approach, while moving a lot of complexity in queries out of the
application and into the database extension, would still require keeping track
of the current transaction in the application, possibly using the thread-local
storage solution above.</p>
</section>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">¶</a></h2>
<p>For the purposes of making our Django ORM queries simpler, we will make use of
<a class="reference external" href="https://django-crum.readthedocs.io/en/latest/">Django-CRUM</a> and thread-local storage to automate fetching the current
transaction from the request (if it exists) and filtering querysets using it.</p>
</section>
<section id="consequences">
<h2>Consequences<a class="headerlink" href="#consequences" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Easier to read and invoke queries that must filter by the current transaction</p></li>
<li><p>An added dependency to maintain</p></li>
<li><p>Slightly “magical” code may make maintenance more difficult</p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">14. Simplification of current transaction queries</a><ul>
<li><a class="reference internal" href="#status">Status</a></li>
<li><a class="reference internal" href="#context">Context</a></li>
<li><a class="reference internal" href="#alternatives-considered">Alternatives considered</a><ul>
<li><a class="reference internal" href="#thread-local-storage">Thread-local storage</a></li>
<li><a class="reference internal" href="#temporal-database-extension">Temporal database extension</a></li>
</ul>
</li>
<li><a class="reference internal" href="#decision">Decision</a></li>
<li><a class="reference internal" href="#consequences">Consequences</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="0013-import-taric-nomenclature-updates.html"
                        title="previous chapter">13. Import TARIC nomenclature updates</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../business_rules/index.html"
                        title="next chapter">Business Rules</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/docs/adr/0014-simplify-current-transaction-queries.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../business_rules/index.html" title="Business Rules"
             >next</a> |</li>
        <li class="right" >
          <a href="0013-import-taric-nomenclature-updates.html" title="13. Import TARIC nomenclature updates"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TaMaTo 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../project.html" >Project Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Architectural Decision Records</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">14. Simplification of current transaction queries</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, DIT.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.0+.
    </div>
  </body>
</html>