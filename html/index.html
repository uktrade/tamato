<!DOCTYPE html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Tariff Management Tool - DIT Tariff Management Tool</title>
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/javascripts/_analytics.js"></script>
    <script src="_static/javascripts/_govuk/govuk-frontend-3.10.2.min.js"></script>
    <script src="_static/javascripts/_govuk/modules.js"></script>
    <script src="_static/javascripts/_modules/anchored-headings.js"></script>
    <script src="_static/javascripts/_modules/collapsible-navigation.js"></script>
    <script src="_static/javascripts/_modules/in-page-navigation.js"></script>
    <script src="_static/javascripts/_modules/navigation.js"></script>
    <script src="_static/javascripts/_modules/page-expiry.js"></script>
    <script src="_static/javascripts/_modules/table-of-contents.js"></script>
    <script src="_static/javascripts/_start_modules.js"></script>
    <script src="_static/javascripts/_vendor/fixedsticky.js"></script>
    <script src="_static/javascripts/_vendor/lodash.js"></script>
    <script src="_static/javascripts/_vendor/modernizer.js"></script>
    <script src="_static/javascripts/govuk_tech_docs.js"></script>
    <script src="_static/javascripts/theme.js"></script>
    <link href="_static/stylesheets/manifest.css" rel="stylesheet" />
    <link href="_static/stylesheets/theme.css" rel="stylesheet" />
    <link rel="shortcut icon" href="_static//favicon.ico"/>
  </head>
  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>
        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
          <div class="govuk-header__container govuk-header__container--full-width">

            <div class="govuk-header__logo">
  <a href="#" class="govuk-header__link govuk-header__link--homepage">
    <span class="govuk-header__logotype">
      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-header__logotype-crown"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 132 97"
        height="30"
        width="36"
        >
        <path
          fill="currentColor" fill-rule="evenodd"
          d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
          ></path>
        <image src="_static/assets/govuk/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
      </svg>
      
      <span class="govuk-header__logotype-text">DIT</span>
    </span>
    <span class="govuk-header__product-name">Tariff Management Tool</span>
  </a><strong class="govuk-tag">Alpha</strong></div>
            <div class="govuk-header__content" role="navigation">
  <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
  <nav>
    <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
      <li class="govuk-header__navigation-item">
        <a class="govuk-header__link" href="https://github.com/uktrade/tamato">GitHub</a>
        </li>
    </ul>
  </nav>
</div>

          </div>
        </header>
      </div>
      <div id="toc-heading" class="toc-show fixedsticky">
        <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
        Table of contents <span class="toc-show__icon"></span>
        </a>
      </div>
      <div class="app-pane__body" data-module="in-page-navigation">

        <div class="app-pane__toc" role="navigation">
  <div class="toc" data-module="table-of-contents">
    <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>

    <div class="search" data-module="search">
  <form action="search.html" method="get" role="search">
    <label class="govuk-label search__label" for="search">Search</label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
</div>

    <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">

      
      <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tariff Management Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="envvars.html">Environment variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="adr/index.html">Architectural Decision Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="business_rules/index.html">Business Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="taric/index.html">TARIC3 Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture/index.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="importer/index.html">The Importer</a></li>
<li class="toctree-l1"><a class="reference internal" href="exporter/index.html">The Exporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="training/gherkin.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="CODE_OF_CONDUCT.html">Contributor Covenant Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
</ul>

      <hr size="1">

      
      <h1>On this page</h1>
      <ul>
<li><a class="reference internal" href="#">Tariff Management Tool</a><ul>
<li><a class="reference internal" href="#development-environment-setup">Development environment setup</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#database">Database</a></li>
<li><a class="reference internal" href="#installing">Installing</a></li>
<li><a class="reference internal" href="#running">Running</a></li>
<li><a class="reference internal" href="#testing">Testing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pre-commit-hooks">Pre-commit hooks</a><ul>
<li><a class="reference internal" href="#install">Install</a></li>
<li><a class="reference internal" href="#update">Update</a></li>
<li><a class="reference internal" href="#uninstall">Uninstall</a></li>
<li><a class="reference internal" href="#run-the-hooks-without-committing">Run the hooks without committing</a></li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dockerisation">Dockerisation</a><ul>
<li><a class="reference internal" href="#fully-dockerised-service">Fully dockerised service</a></li>
<li><a class="reference internal" href="#hybrid-host-container-approach">Hybrid host + container approach</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-the-importer">Using the importer</a></li>
<li><a class="reference internal" href="#using-the-taric-parser-currently-referenced-importer-v2">Using the TARIC parser (currently referenced importer v2)</a></li>
<li><a class="reference internal" href="#reference-document-data-import">Reference document data import</a></li>
<li><a class="reference internal" href="#using-the-exporter">Using the exporter</a><ul>
<li><a class="reference internal" href="#running-the-exporter">Running the exporter</a></li>
<li><a class="reference internal" href="#manually-trigger-the-upload-to-s3">Manually trigger the upload to s3</a></li>
<li><a class="reference internal" href="#dump-transactions">Dump transactions</a></li>
<li><a class="reference internal" href="#mocking-s3-upload-with-minio">Mocking s3 upload with minio</a></li>
<li><a class="reference internal" href="#virus-scan-and-running-locally">Virus Scan and running locally</a></li>
</ul>
</li>
<li><a class="reference internal" href="#application-maintenance-mode">Application maintenance mode</a></li>
<li><a class="reference internal" href="#how-to-contribute">How to contribute</a></li>
<li><a class="reference internal" href="#how-to-deploy">How to deploy</a><ul>
<li><a class="reference internal" href="#accessing-databases-in-gov-uk-paas">Accessing databases in GOV.UK PaaS</a></li>
</ul>
</li>
</ul>
</li>
</ul>


    </nav>
  </div>
</div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings" role="main">

            
  <div class="toctree-wrapper compound">
</div>
<section id="tariff-management-tool">
<h1>Tariff Management Tool<a class="headerlink" href="#tariff-management-tool" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://codecov.io/gh/uktrade/tamato"><img alt="codecov" src="https://codecov.io/gh/uktrade/tamato/branch/master/graph/badge.svg" /></a></p>
<p>The Tariff Management Tool (TaMaTo) is a web application that enables Tariff Managers to
browse and make changes to the UK Global Tariff, and submit these changes to HMRC.</p>
<p>The tool is available at <a class="reference external" href="https://www.manage-trade-tariffs.trade.gov.uk/">https://www.manage-trade-tariffs.trade.gov.uk/</a></p>
<section id="development-environment-setup">
<h2>Development environment setup<a class="headerlink" href="#development-environment-setup" title="Permalink to this headline">¶</a></h2>
<section id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h3>
<p>The following dependencies are required to run this app:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://python.org/">Python</a> 3.9.x</p></li>
<li><p><a class="reference external" href="https://nodejs.org/">Node.js</a> 20.10.0 (LTS)</p></li>
<li><p><a class="reference external" href="https://postgresql.org/">PostgreSQL</a> 12</p></li>
<li><p><a class="reference external" href="https://redis.io/">Redis</a> 5.x</p></li>
</ul>
<p>The app requires an AWS S3 bucket or a compatible implementation, such as <a class="reference external" href="https://min.io/">MinIO</a></p>
<p>If using MacOS then libmagic is required:</p>
<blockquote>
<div><p>$ brew install libmagic</p>
</div></blockquote>
</section>
<section id="database">
<h3>Database<a class="headerlink" href="#database" title="Permalink to this headline">¶</a></h3>
<p>Create a database instance and user:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>su<span class="w"> </span>-<span class="w"> </span>postgres
postgres<span class="w"> </span>$<span class="w"> </span>createdb<span class="w"> </span>tamato
postgres<span class="w"> </span>$<span class="w"> </span>psql<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;CREATE USER &lt;username&gt; SUPERUSER PASSWORD &#39;&lt;password&gt;&#39;;&quot;</span>
</pre></div>
</div>
<p>Make a note of the <code class="docutils literal notranslate"><span class="pre">&lt;username&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;password&gt;</span></code> for use in the
<span class="target" id="index-0"></span><a class="reference internal" href="envvars.html#envvar-DATABASE_URL"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">DATABASE_URL</span></code></a> environment variable.</p>
<p>Import from a dump of the database:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>postgres<span class="w"> </span>$<span class="w"> </span>psql<span class="w"> </span>-d<span class="w"> </span>tamato<span class="w"> </span>-f<span class="w"> </span>/tmp/tamato-db-dump.sql
</pre></div>
</div>
<p>To get a database dump, please contact the TAP team.</p>
</section>
<section id="installing">
<h3>Installing<a class="headerlink" href="#installing" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:uktrade/tamato
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>tamato
$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>venv
$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>venv/bin/activate
$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>pip
$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>wheel<span class="w"> </span>-r<span class="w"> </span>requirements-dev.txt
$<span class="w"> </span>npm<span class="w"> </span>install
$<span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>build
</pre></div>
</div>
</section>
<section id="running">
<h3>Running<a class="headerlink" href="#running" title="Permalink to this headline">¶</a></h3>
<p>Create a <code class="docutils literal notranslate"><span class="pre">.env</span></code> file containing <a class="reference internal" href="envvars.html"><span class="doc">environment variables</span></a></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cp<span class="w"> </span>sample.env<span class="w"> </span>.env
</pre></div>
</div>
<p>Open another terminal and Compile SCSS and Javascripts:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span>collectstatic
</pre></div>
</div>
<p>To be able to login to the app, you will first need to create a Django user with
superuser access:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span>createsuperuser
</pre></div>
</div>
<p>Then run the app:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span>runserver
</pre></div>
</div>
<p>Then you can browse to <a class="reference external" href="http://localhost:8000/">http://localhost:8000/</a> to view the app.
To access the Django admin page, browse to <a class="reference external" href="http://localhost:8000/admin/">http://localhost:8000/admin/</a>.</p>
<p>In order to define or override developer-specific Django settings in a local
developement environment, then you may wish to create a
<cite>settings/dev_override.py</cite> file.</p>
</section>
<section id="testing">
<h3>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h3>
<p>To run tests use the following command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>For more detailed information on running tests, see <a class="reference internal" href="testing.html"><span class="doc">Testing</span></a></p>
</section>
</section>
<section id="pre-commit-hooks">
<h2>Pre-commit hooks<a class="headerlink" href="#pre-commit-hooks" title="Permalink to this headline">¶</a></h2>
<p>This project uses pre-commit hooks to update formatting and identify potential sensitive data before
it is committed to the public repo.</p>
<p>note: The python package pre-commit is a requirement within requirements-dev.txt and should be installed
to meet development requirements</p>
<section id="install">
<h3>Install<a class="headerlink" href="#install" title="Permalink to this headline">¶</a></h3>
<p>To initially setup the pre-commit hooks you can run the following command.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pre-commit<span class="w"> </span>install
</pre></div>
</div>
<p>Once installed, when committing it will first run all the predefined processes to clean up code formatting
and notify about any detected sensitive strings found that are not in pii exclude files.</p>
<p>Note: the first commit or run of the pre-commit hooks after installing may take a few minutes for setup the
dependent packages for the first time. This is normal, and will be faster on subsequent commits.</p>
</section>
<section id="update">
<h3>Update<a class="headerlink" href="#update" title="Permalink to this headline">¶</a></h3>
<p>The packages used to perform the pre-commit process are regularly updated. Periodically its advised
you run the following command to keep the dependencies updated.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pre-commit<span class="w"> </span>autoupdate
</pre></div>
</div>
<p>This will verify that the dependencies are updated based on requirements.</p>
</section>
<section id="uninstall">
<h3>Uninstall<a class="headerlink" href="#uninstall" title="Permalink to this headline">¶</a></h3>
<p>The pre-commit hooks can be uninstalled with the following command</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pre-commit<span class="w"> </span>uninstall
</pre></div>
</div>
</section>
<section id="run-the-hooks-without-committing">
<h3>Run the hooks without committing<a class="headerlink" href="#run-the-hooks-without-committing" title="Permalink to this headline">¶</a></h3>
<p>You may at times want to run the pre-commit hooks before committing. This can be done with
the following command. This command will run the hooks on all changed files.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pre-commit<span class="w"> </span>run
</pre></div>
</div>
<p>If you would like to run the hooks over all files you can run the following command</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pre-commit<span class="w"> </span>run<span class="w"> </span>-a
</pre></div>
</div>
<p>or</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pre-commit<span class="w"> </span>run<span class="w"> </span>--all-files
</pre></div>
</div>
</section>
<section id="troubleshooting">
<h3>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h3>
<p>If you encounter issues with the pre-commit hooks there are a number of things you can
clear the cached pre-committed files using this command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pre-commit<span class="w"> </span>clean
</pre></div>
</div>
<p>If that fails you can try updating the dependencies for the hooks</p>
<p>If the above fails, uninstall and then install again.</p>
</section>
</section>
<section id="dockerisation">
<h2>Dockerisation<a class="headerlink" href="#dockerisation" title="Permalink to this headline">¶</a></h2>
<section id="fully-dockerised-service">
<h3>Fully dockerised service<a class="headerlink" href="#fully-dockerised-service" title="Permalink to this headline">¶</a></h3>
<dl class="simple">
<dt>Prerequisites:</dt><dd><ul class="simple">
<li><p>A local instance of the tool can be run using <a class="reference external" href="https://www.docker.com/">Docker</a>.</p></li>
<li><p>A database dump - contact the TAP team for a database snapshot.</p></li>
</ul>
</dd>
</dl>
<p>Guidance for running tamato via docker in Pycharm (follow initial set up below first)
<a href="#id2"><span class="problematic" id="id3">`Docker in PyCharm https://www.jetbrains.com/help/pycharm/using-docker-as-a-remote-interpreter.html#run`__</span></a>.</p>
<p><a class="reference external" href="https://testdriven.io/blog/django-debugging-pycharm/">https://testdriven.io/blog/django-debugging-pycharm/</a></p>
<p>Download the codebase:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:uktrade/tamato
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>tamato
</pre></div>
</div>
<p>Build and Run for the first time:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cp<span class="w"> </span>sample.env<span class="w"> </span>.env
<span class="w">    </span><span class="c1"># Not used will be used for specific local docker stuff</span>
<span class="w">    </span><span class="c1"># cp docker-compose.override.yml.example docker-compose.override.yml</span>

<span class="c1"># to overwrite default db dump name pass in DB_DUMP=tamato_db.sql</span>
$<span class="w"> </span>make<span class="w"> </span>docker-first-use
<span class="w">    </span><span class="c1"># take a tea break to import the db dump then</span>
<span class="w">    </span><span class="c1"># enter super user details when prompted</span>
<span class="w">    </span><span class="c1"># and visit localhost:8000/ when the containers are up</span>
</pre></div>
</div>
<p>Run the tamato app every other time:</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>make<span class="w"> </span>docker-build
$<span class="w"> </span>make<span class="w"> </span>docker-up
</pre></div>
</div>
</div></blockquote>
<p>Go to <a class="reference external" href="http://localhost:8000/">http://localhost:8000/</a> in your web browser to view the app</p>
<p>Import from a dump of the database:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># to overwrite defaults</span>
<span class="c1">#   DB_DUMP=tamato_db.sql</span>
<span class="c1">#   DB_NAME=tamato</span>
<span class="c1">#   DB_USER=postgres</span>
<span class="c1">#   TEMPLATE_NAME={DB_NAME}_{DATE}</span>
<span class="c1"># this overwrites the default file set in the makefile variable</span>
<span class="c1"># docker-import-new-db will create a new template with the provided DB dump</span>
<span class="c1"># can override the name of the template at TEMPLATE_NAME</span>
$<span class="w"> </span>make<span class="w"> </span>docker-import-new-db

<span class="c1"># Will restore the db DB_NAME with the provided TEMPLATE_NAME</span>
$<span class="w"> </span>make<span class="w"> </span>docker-restore-db
</pre></div>
</div>
<p>Sometimes docker gets clogged up and we need to clean it:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># cleans up images &amp; volumes</span>
$<span class="w"> </span>make<span class="w"> </span>docker-clean
<span class="c1"># cleans up everything including the cache which can get filled up because of db dumps</span>
$<span class="w"> </span>make<span class="w"> </span>docker-deep-clean
</pre></div>
</div>
<p>Run database migrations:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>make<span class="w"> </span>docker-migrate
</pre></div>
</div>
<p>Create a superuser, to enable logging in to the app:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>make<span class="w"> </span>docker-superuser
</pre></div>
</div>
<p>Run tests from within a docker container:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>make<span class="w"> </span>docker-test
$<span class="w"> </span>make<span class="w"> </span>docker-test-fast
</pre></div>
</div>
<p>DOCKER_RUN=run –rm by default but can be set to exec if you have containers up and running
General commands:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>make<span class="w"> </span>docker-down<span class="w"> </span><span class="c1"># brings down containers</span>
$<span class="w"> </span>make<span class="w"> </span>docker-up-db<span class="w"> </span><span class="c1"># brings up db in the background</span>
$<span class="w"> </span>make<span class="w"> </span>docker-makemigrations<span class="w"> </span><span class="c1"># runs django makemigrations</span>
$<span class="w"> </span>make<span class="w"> </span>docker-checkmigrations<span class="w"> </span><span class="c1"># runs django checkmigrations</span>
$<span class="w"> </span>make<span class="w"> </span>docker-bash<span class="w"> </span><span class="c1"># bash shell in tamato container</span>
$<span class="w"> </span>make<span class="w"> </span>docker-django-shell<span class="w"> </span><span class="c1"># django shell in tamato container</span>
</pre></div>
</div>
</section>
<section id="hybrid-host-container-approach">
<h3>Hybrid host + container approach<a class="headerlink" href="#hybrid-host-container-approach" title="Permalink to this headline">¶</a></h3>
<p>You may prefer a hybrid approach to running Tamato, say, executing the Redis
service and Celery workers in containers and the remaining services in the host
environment. To do so, create a <cite>docker-compose.override.yml</cite> file to allow
loading environment settings that are specific to this configuration:</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>version: &#39;3&#39;

services:
celery:
    env_file:
    - .env
    - settings/envs/docker.env
    - settings/envs/docker.override.env

rule-check-celery:
    env_file:
    - .env
    - settings/envs/docker.env
    - settings/envs/docker.override.env
</pre></div>
</div>
<p>Create a <cite>docker.override.env</cite> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Point containerised services at the host environment hosted DB.</span>
<span class="n">DATABASE_URL</span><span class="o">=</span><span class="n">postgres</span><span class="p">:</span><span class="o">//</span><span class="n">host</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">internal</span><span class="p">:</span><span class="mi">5432</span><span class="o">/</span><span class="n">tamato</span>
</pre></div>
</div>
<p>Now start dockerised instances of Redis and the Celery worker services:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>docker-compose<span class="w"> </span>up<span class="w"> </span>-d<span class="w"> </span>celery-redis<span class="w"> </span>celery<span class="w"> </span>rule-check-celery
</pre></div>
</div>
</section>
</section>
<section id="using-the-importer">
<h2>Using the importer<a class="headerlink" href="#using-the-importer" title="Permalink to this headline">¶</a></h2>
<p>The Tariff Management Tool (TaMaTo) needs to import TARIC3 XML data from
both the EU (for historical data) and from HMRC (for VAT measures).</p>
<p>TaMaTo provides an import which parses TARIC3 XML and inserts the data
into the TAMATO database.</p>
<p>Run the script to see the command line arguments:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span>import_taric<span class="w"> </span>--help
</pre></div>
</div>
<p>This command is broken into two stages:</p>
<ol class="arabic">
<li><p>Chunking the file and loading into the DB. If a file is greater than
50MB it is broken into chunks and those chunks saved into the
database. This can be run in isolation using the command</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span>chunk_taric
</pre></div>
</div>
</li>
<li><p>Passing the chunks through the importer system into TrackedModels.
This can be run in isolation using the command</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span>run_import_batch
</pre></div>
</div>
</li>
</ol>
</section>
<section id="using-the-taric-parser-currently-referenced-importer-v2">
<h2>Using the TARIC parser (currently referenced importer v2)<a class="headerlink" href="#using-the-taric-parser-currently-referenced-importer-v2" title="Permalink to this headline">¶</a></h2>
<p>There are no command line tools available for this tool.</p>
<p>This tool is available as an importer alternative found within the web front end in the footer menu under “New TARIC parser”.</p>
<p>This tool addresses several short falls that the current importer has.</p>
</section>
<section id="reference-document-data-import">
<h2>Reference document data import<a class="headerlink" href="#reference-document-data-import" title="Permalink to this headline">¶</a></h2>
<p>WARNING: this feature is in alpha : do not use in production until this feature has been
fully tested.</p>
<p>In order to populate the reference document data from extracted data from an external tool
you can use the management command ref_doc_csv_importer</p>
<p>Example:</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span>ref_doc_csv_importer<span class="w"> </span><span class="s2">&quot;/absolute/path/to/duties.csv&quot;</span><span class="w"> </span><span class="s2">&quot;/absolute/path/to/quotas.csv&quot;</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="using-the-exporter">
<h2>Using the exporter<a class="headerlink" href="#using-the-exporter" title="Permalink to this headline">¶</a></h2>
<p>The Tariff Management Tool (TaMaTo) exports data to HMRC.</p>
<p>During normal operation uploads trigger the <code class="docutils literal notranslate"><span class="pre">upload_transactions</span></code> task
which uploads transactions as XML to the HMRC bucket.</p>
<section id="running-the-exporter">
<h3>Running the exporter<a class="headerlink" href="#running-the-exporter" title="Permalink to this headline">¶</a></h3>
<p>The exporter pushes data to a queue, which one or more asynchronous worker
processes monitor and perform the upload to S3, so as not to block the web
server.</p>
<p>To run the exporter queue process, run the following command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>celery<span class="w"> </span>-A<span class="w"> </span>common.celery<span class="w"> </span>beat<span class="w"> </span>--loglevel<span class="o">=</span>info
</pre></div>
</div>
<p>Open another terminal and start a Celery worker:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>celery<span class="w"> </span>-A<span class="w"> </span>common.celery<span class="w"> </span>worker<span class="w"> </span>--loglevel<span class="o">=</span>info<span class="w"> </span>-Q<span class="w"> </span>standard,rule-check
<span class="c1"># The celery worker can be run as two workers for each queue</span>
celery<span class="w"> </span>-A<span class="w"> </span>common.celery<span class="w"> </span>worker<span class="w"> </span>--loglevel<span class="o">=</span>info<span class="w"> </span>-Q<span class="w"> </span>standard
celery<span class="w"> </span>-A<span class="w"> </span>common.celery<span class="w"> </span>worker<span class="w"> </span>--loglevel<span class="o">=</span>info<span class="w"> </span>-Q<span class="w"> </span>rule-check
</pre></div>
</div>
<p>To monitor celery workers or individual tasks run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>celery<span class="w"> </span>flower
</pre></div>
</div>
<p>See <a class="reference external" href="https://flower.readthedocs.io/en/latest/">flower docs</a> for more details</p>
</section>
<section id="manually-trigger-the-upload-to-s3">
<h3>Manually trigger the upload to s3<a class="headerlink" href="#manually-trigger-the-upload-to-s3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>celery<span class="w"> </span>-A<span class="w"> </span>common.celery<span class="w"> </span>call<span class="w"> </span>exporter.tasks.upload_transactions
</pre></div>
</div>
<p>The celery job UUID is output and the command quits. To see output
switch to the celery workers console. A more ergonomic way of launching
the celery job is to launch the management command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span>upload_transactions
</pre></div>
</div>
</section>
<section id="dump-transactions">
<h3>Dump transactions<a class="headerlink" href="#dump-transactions" title="Permalink to this headline">¶</a></h3>
<p>Transactions waiting to be uploaded to the HMRC S3 bucket can be saved
to a file or output to stdout using a management command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span>dump_transactions<span class="w"> </span><span class="o">[</span>-o<span class="w"> </span>filename<span class="o">]</span>
</pre></div>
</div>
<p>Output defaults to stdout if filename is <code class="docutils literal notranslate"><span class="pre">-</span></code> or is not supplied.</p>
</section>
<section id="mocking-s3-upload-with-minio">
<h3>Mocking s3 upload with minio<a class="headerlink" href="#mocking-s3-upload-with-minio" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Follow <a class="reference external" href="https://min.io/docs/minio/macos/index.html">instructions</a> to install minio server</p></li>
<li><p>Export MINIO_ROOT_USER and MINIO_ROOT_PASSWORD variables of your choice</p></li>
<li><p>Run server with:</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>minio<span class="w"> </span>server<span class="w"> </span>--quiet<span class="w"> </span>--address<span class="w"> </span><span class="m">0</span>.0.0.0:9003<span class="w"> </span>~/data
</pre></div>
</div>
<ol class="arabic" start="4">
<li><p>Navigate to <a class="reference external" href="http://localhost:9003/">http://localhost:9003/</a> and login using root user and password credentials just
created. Create a bucket and an access key via the console.</p></li>
<li><p>Export environment variables for any storages you wish to dummy (e.g. for sqlite dump export
this will be SQLITE_STORAGE_BUCKET_NAME, SQLITE_S3_ACCESS_KEY_ID, SQLITE_S3_SECRET_ACCESS_KEY,
SQLITE_S3_ENDPOINT_URL, and SQLITE_STORAGE_DIRECTORY), setting s3 endpoint url to
<a class="reference external" href="http://localhost:9003/">http://localhost:9003/</a></p></li>
<li><p>Alternatively, export all environment variables temporarily to an environment such as Bash
(useful when running a local development instance of a Celery worker):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="w"> </span>-a<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>.env<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">set</span><span class="w"> </span>+a
</pre></div>
</div>
</li>
</ol>
</section>
<section id="virus-scan-and-running-locally">
<h3>Virus Scan and running locally<a class="headerlink" href="#virus-scan-and-running-locally" title="Permalink to this headline">¶</a></h3>
<p>We use a shared service accross the department for virus scanning to run locally set up the following:
1. Follow set up <a class="reference external" href="https://github.com/uktrade/dit-clamav-rest">instructions</a> and run it
2. set SKIP_CLAM_AV_FILE_UPLOAD to False and CLAM_USE_HTTP True
3. add CLAM_AV_DOMAIN without http(s)://
4. set CLAM_AV_USERNAME,CLAM_AV_PASSWORD as the username and password found in the config.py in the dit-clamav-rest project</p>
</section>
</section>
<section id="application-maintenance-mode">
<h2>Application maintenance mode<a class="headerlink" href="#application-maintenance-mode" title="Permalink to this headline">¶</a></h2>
<p>The application can be put into a “maintenance mode” type of operation. By doing
so, all user web access is routed to a maintenance view and the default database
route removes the application’s access to the database. This prevents
inadvertent changes by users, via the application UI, to application data while
in maintenance mode. Note, however, that this would not restrict other forms of
data update, such as active Celery tasks - Celery and other similar processes
need to be scaled down separately.</p>
<p>The process for transitioning the application into and back out of maintenance
mode is as follows:</p>
<ol class="arabic simple">
<li><p>Set the application’s <cite>MAINTENANCE_MODE</cite> environment variable to <cite>True</cite>.</p></li>
<li><p>Restart the application so that it picks up the new value of <cite>MAINTENANCE_MODE</cite>.</p></li>
<li><p>Complete maintenance activities.</p></li>
<li><p>Set the value of the <cite>MAINTENANCE_MODE</cite> environment variable to <cite>False</cite>.</p></li>
<li><p>Restart the application.</p></li>
</ol>
</section>
<section id="how-to-contribute">
<h2>How to contribute<a class="headerlink" href="#how-to-contribute" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference internal" href="CONTRIBUTING.html#contributing"><span class="std std-ref">How to contribute</span></a></p>
</section>
<section id="how-to-deploy">
<h2>How to deploy<a class="headerlink" href="#how-to-deploy" title="Permalink to this headline">¶</a></h2>
<p>The app is deployed with Jenkins via the <cite>Tariffs/TaMaTo</cite> job. The <code class="docutils literal notranslate"><span class="pre">master</span></code> branch
may be deployed to <code class="docutils literal notranslate"><span class="pre">development</span></code>, <code class="docutils literal notranslate"><span class="pre">staging</span></code>, <code class="docutils literal notranslate"><span class="pre">uat</span></code>, <code class="docutils literal notranslate"><span class="pre">training</span></code> or
<code class="docutils literal notranslate"><span class="pre">production</span></code> environments by selecting the environment name from the <strong>ENV</strong>
dropdown on the <cite>Build with Parameters</cite> page.</p>
<section id="accessing-databases-in-gov-uk-paas">
<h3>Accessing databases in GOV.UK PaaS<a class="headerlink" href="#accessing-databases-in-gov-uk-paas" title="Permalink to this headline">¶</a></h3>
<p>To access databases hosted in GOV.UK PaaS directly, you will need a PaaS
login and the <a class="reference external" href="https://docs.cloudfoundry.org/cf-cli/install-go-cli.html">cf CLI
tool</a>.</p>
<p>You will need to install the <a class="reference external" href="https://github.com/alphagov/paas-cf-conduit">conduit plugin</a>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cf<span class="w"> </span>install-plugin<span class="w"> </span>conduit
</pre></div>
</div>
<p>Then you need to login to the DIT GOV.UK PaaS:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cf<span class="w"> </span>login<span class="w"> </span>--sso<span class="w"> </span>-s<span class="w"> </span>&lt;space&gt;
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">&lt;space&gt;</span></code> is one of <code class="docutils literal notranslate"><span class="pre">tariffs-dev</span></code>, <code class="docutils literal notranslate"><span class="pre">tariffs-staging</span></code>,
<code class="docutils literal notranslate"><span class="pre">tariffs-training</span></code> or <code class="docutils literal notranslate"><span class="pre">tariffs-uat</span></code>.</p>
<p>Once you are logged in, you can list the services hosted in the space with</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cf<span class="w"> </span>services
</pre></div>
</div>
<p>You can access <code class="docutils literal notranslate"><span class="pre">postgres</span></code> services with the following command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cf<span class="w"> </span>conduit<span class="w"> </span>&lt;name&gt;<span class="w"> </span>--<span class="w"> </span>psql
</pre></div>
</div>
<p>So if you are logged in to the <code class="docutils literal notranslate"><span class="pre">tariffs-dev</span></code> space, you could access the dev
environment database with <code class="docutils literal notranslate"><span class="pre">cf</span> <span class="pre">conduit</span> <span class="pre">tamato-dev-db</span> <span class="pre">--</span> <span class="pre">psql</span></code>.</p>
</section>
</section>
</section>



          </main>

          <aside>
  <ul class="contribution-banner">
    
    <li><a href="https://github.com/uktrade/tamato/blob/main/docs/index.rst">View source</a></li>
    <li><a href="https://github.com/uktrade/tamato/issues/new?labels=bug&amp;title=Re:%20'index.rst'&amp;body=Problem%20with%20'index.rst'%20(docs/)">Report problem</a></li>
    <li><a href="https://github.com/uktrade/tamato">GitHub Repo</a></li>
    
  </ul>
</aside>
          <footer class="govuk-footer app-footer" role="contentinfo">
<div class="govuk-footer__meta">
  <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">
    <ul class="govuk-footer__inline-list">
      <li class="govuk-footer__inline-list-item">
        <a class="govuk-footer__link" href="accessibility.html">Accessibility</a>
      </li>
      <li class="govuk-footer__inline-list-item">
        Built with <a class="govuk-footer__link" href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0 using the <a class="govuk-footer__link" href="https://www.github.com/ukgovdatascience/govuk-tech-docs-sphinx-theme">GOV.UK Tech Docs Sphinx Theme</a>.
      </li>
    </ul>
    <svg
      aria-hidden="true"
      focusable="false"
      class="govuk-footer__licence-logo"
      xmlns="http://www.w3.org/2000/svg"
      viewbox="0 0 483.2 195.7"
      height="17"
      width="41"
      >
      <path
        fill="currentColor"
        d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
    </svg>
    <span class="govuk-footer__licence-description">
    All content is available under the
    <a
      class="govuk-footer__link"
      href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
      rel="license"
      >Open Government Licence v3.0</a>, except where otherwise stated
    </span>
  </div>
  <div class="govuk-footer__meta-item">
    <a
      class="govuk-footer__link govuk-footer__copyright-logo"
      href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
  </div>
</div>
</footer>

        </div>
      </div>
    </div>
  </body>
</html>