{% from "components/details/macro.njk" import govukDetails %}

{% set exclusions %}
    {% for exclusion in object.geographical_exclusions %}
        <a href="{{ url('geo_area-ui-detail', args=[exclusion.sid]) }}" class="govuk-link">{{ exclusion.area_id }} - {{ exclusion.get_description().description }}</a>
        {% if not loop.last %}, {% endif %}
    {% endfor %}
{% endset %}

{% set origins %}
    {% for origin in object.quotaordernumberorigin_set.current() %}
        {% set geo_area_name -%}{{origin.geographical_area.area_id}} - {{origin.geographical_area.get_description().description}}{% endset %}
        {% set origin_link -%}
            <a href="{{ url('geo_area-ui-detail', args=[origin.geographical_area.sid]) }}" class="govuk-link">{{ geo_area_name }}</a>
        {% endset %}
        {% set end_date -%}
        {{"{:%d %b %Y}".format(object.valid_between.upper) if object.valid_between.upper else "â€”"}}
        {% endset %}
        {% set validity -%}
        {{"{:%d %b %Y}".format(object.valid_between.lower) ~ " " ~ end_date }}
        {% endset %}
        {% set summary_list %}
            {{ govukSummaryList({
                "rows": [
                    {
                        "key": {"text": "Geographical area"},
                        "value": {"text": origin_link},
                        "actions": {"items": []},
                    },
                    {
                        "key": {"text": "Geographical area exclusions"},
                        "value": {"text": exclusions if object.geographical_exclusions else "-"},
                        "actions": {"items": []},
                    },
                    {
                        "key": {"text": "Validity"},
                        "value": {"text": validity},
                        "actions": {"items": []},
                    },
                ]
            })
            }}
        {% endset %}
        {{ govukDetails({
            "summaryText": geo_area_name,
            "html": summary_list
            }) }}
    {% endfor %}
{% endset %}

<div class="quota__core-data govuk-grid-row">
    <div class="quota__core-data__content govuk-grid-column-three-quarters">
        <h2 class="govuk-heading-l">Details</h2>
        {{ govukSummaryList({
            "rows": [
            {
                "key": {"text": "Order Number"},
                "value": {"text": object.order_number},
                "actions": {"items": []}
            },
            {
                "key": {"text": "Origins"},
                "value": {"text": origins if object.origins.all() else "-"},
                "actions": {"items": []}
            },
            {
                "key": {"text": "Start date"},
                "value": {"text":  "{:%d %b %Y}".format(object.valid_between.lower)},
                "actions": {"items": []}
            },
            {
                "key": {"text": "End date"},
                "value": {"text":  "{:%d %b %Y}".format(object.valid_between.upper) if object.valid_between.upper else "-"},
                "actions": {"items": []}
            },
            {
                "key": {"text": "Category"},
                "value": {"text": object.get_category_display()},
                "actions": {"items": []}
            },
            {
                "key": {"text": "Mechanism"},
                "value": {"text": object.get_mechanism_display()},
                "actions": {"items": []}
            },
            {
                "key": {"text": "Required certificates"},
                "value": {"text": object.required_certificates.all()|join(", ") if object.is_origin_quota else "-"},
                "actions": {"items": []}
            },
            ]
        })}}
    </div>
    {% include "includes/quotas/actions.jinja"%}
</div>
