
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Architecture &#8212; TaMaTo 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="The Importer" href="../importer/index.html" />
    <link rel="prev" title="Code Documentation" href="../code.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../importer/index.html" title="The Importer"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../code.html" title="Code Documentation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TaMaTo 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../code.html" accesskey="U">Code Documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Architecture</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="architecture">
<h1>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h1>
<p>This page describes the high-level architecture of TaMaTo. If you want to
familiarize yourself with the code base, you are in just the right place!</p>
<div class="section" id="bird-s-eye-view">
<h2>Bird’s Eye View<a class="headerlink" href="#bird-s-eye-view" title="Permalink to this headline">¶</a></h2>
<img alt="../../_images/birds-eye.svg" src="../../_images/birds-eye.svg" /><p>TaMaTo is a data storage and management system that acts as the single source of
truth for the UK customs tariff. Its role is to represent trade policy as
designed by HM Government’s policy teams in the data domain and transmit this
downstream to border systems and other third-party users. It takes data in
various formats, validates it, and outputs it in various other formats.</p>
<p>The general principle for UK tariff data is to have border services working from
this single source of tariff data as much as possible. This avoids border
service delivery teams from having to manually interpret complex tariff policy
and configure their services accordingly. In general, we are trying to maximise
data flow from the source in policy to use at the border.</p>
<p>Policy teams forming trade policy have a number of levers to use in achieving
their aims. New or updated policies will change the tariff rates and controls
that are applied, and these changes then need to be reflected in the UK tariff
stored in TaMaTo. The main “format” used to do this is the user interface being
operated by a domain-aware tariff operations manager, who interprets and applies
the policy on behalf of all downstream consumers. Future work will consider more
input interfaces, such as the ability of policy teams to control the data
directly.</p>
<p>HMRC’s Customs Declaration Services (CDS) system is a primary consumer of data
from TaMaTo. There are also a number of other consumers: the Jersey and Guernsey
border systems Caesar and GEMS, policy-makers via DIT’s Data Workspace and other
third parties via open data.</p>
</div>
<div class="section" id="concepts">
<h2>Concepts<a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h2>
<div class="section" id="taric">
<h3>TARIC<a class="headerlink" href="#taric" title="Permalink to this headline">¶</a></h3>
<p>Most UK border systems were previously designed to take customs tariff updates
from the European Union. For this reason the tariff domain model and output
interfaces match those still used by the EU. This standard is called TARIC
(TARif Intégré Communautaire, or Integrated Tariff of the European Communities).</p>
<p>TARIC is a data exchange specification – the models, fields and formats that are
used to communicate the tariff are thus pre-specified and are difficult to
change. Primarily an XML format is used which follows a TARIC XSD.</p>
<p>TARIC was designed to communicate <em>changes</em> about the tariff – hence there are a
number of features that exist specifically to do this. Most notably, the TARIC
specification models the tariff as an ever changing <em>transaction stream</em> where
each transaction represents a change to a model to be applied.</p>
<p>The streaming nature means that the entire state of the system is decided by the
sum total of all of the transactions that have currently been applied – any
future transactions are not yet visible. This has an architectural implication
that TaMaTo must be able to read data and apply business rules as of a certain
transaction as opposed to just considering all data that is present (including
e.g. draft data). More detail on what practical difference this makes is in the
documentation on <a class="reference internal" href="../adr/0012-ordering-of-tariff-transactions.html#ordering-of-tariff-transactions"><span class="std std-ref">12. Ordering of tariff transactions</span></a>.</p>
</div>
<div class="section" id="validity-dates-as-version-control">
<h3>Validity dates as version control<a class="headerlink" href="#validity-dates-as-version-control" title="Permalink to this headline">¶</a></h3>
<p>The domain model implements a version control system that specifies which models
of the tariff are live on the border on a given day. This allows a tariff update
to be sent to border systems in advance and take effect correctly at some future
time. Most models use a pair of validity dates, implemented using the
<a class="reference internal" href="#common.models.mixins.ValidityMixin" title="common.models.mixins.ValidityMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">ValidityMixin</span></code></a>.</p>
<dl class="py class">
<dt id="common.models.mixins.ValidityMixin">
<em class="property"><span class="pre">class</span> </em><code class="sig-prename descclassname"><span class="pre">common.models.mixins.</span></code><code class="sig-name descname"><span class="pre">ValidityMixin</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/common/models/mixins.html#ValidityMixin"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#common.models.mixins.ValidityMixin" title="Permalink to this definition">¶</a></dt>
<dd><p>The model is live after the validity start date
(<code class="xref py py-attr docutils literal notranslate"><span class="pre">valid_between.lower</span></code>) and before the validity end date
(<code class="xref py py-attr docutils literal notranslate"><span class="pre">valid_between.upper</span></code>).</p>
<p>Start and end validity dates are inclusive – meaning that the model is live
from the beginning of the start date to the end of the end date. A model
with the same start and end date is therefore live for 1 day. If the
validity end date is blank (<code class="xref py py-attr docutils literal notranslate"><span class="pre">valid_between.upper_inf</span></code>) then the model
is live indefinitely after the start date.</p>
<p>Validity dates can be modified with a new version of a model, so a model
that initially has a blank end date can be updated to subsequently add one.</p>
<dl class="py method">
<dt id="common.models.mixins.ValidityMixin.objects_with_validity_field">
<em class="property"><span class="pre">classmethod</span> </em><code class="sig-name descname"><span class="pre">objects_with_validity_field</span></code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/common/models/mixins.html#ValidityMixin.objects_with_validity_field"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#common.models.mixins.ValidityMixin.objects_with_validity_field" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a QuerySet which will have this model’s validity date field (as
specified by <a class="reference internal" href="#common.models.mixins.ValidityMixin.validity_field_name" title="common.models.mixins.ValidityMixin.validity_field_name"><code class="xref py py-attr docutils literal notranslate"><span class="pre">validity_field_name</span></code></a>) present on the returned
models.</p>
<p>The need for this is that some models (e.g.
<code class="xref py py-class docutils literal notranslate"><span class="pre">Measure</span></code>) use a validity date that is computed
on demand as part of a database query and hence is not present on the
default queryset.</p>
</dd></dl>

<dl class="py attribute">
<dt id="common.models.mixins.ValidityMixin.validity_field_name">
<code class="sig-name descname"><span class="pre">validity_field_name</span></code><em class="property"><span class="pre">:</span> <span class="pre">str</span></em><em class="property"> <span class="pre">=</span> <span class="pre">'valid_between'</span></em><a class="headerlink" href="#common.models.mixins.ValidityMixin.validity_field_name" title="Permalink to this definition">¶</a></dt>
<dd><p>The name of the field that should be used for validity date checking.</p>
</dd></dl>

</dd></dl>

<p>Description models have a requirement that there must always be one live
description at any time. For this reason, descriptions do not have end dates and
only have start dates. The description is live up until the start date of the
next description record.</p>
</div>
<div class="section" id="tracked-models-as-version-control">
<h3>Tracked models as version control<a class="headerlink" href="#tracked-models-as-version-control" title="Permalink to this headline">¶</a></h3>
<p>The TARIC data exchange communicates about models in terms of what changes are
being made to them. Hence, it is not enough for a TARIC-aware system to just
have the latest data applied and stored – the system must also keep track of
previous versions of models and be able to describe the changes that have been
done to them.</p>
<p>Each model will exist multiple times in the database, with each row representing
a new version of that model. This is implemented using the
<a class="reference internal" href="#common.models.records.TrackedModel" title="common.models.records.TrackedModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">TrackedModel</span></code></a> system.</p>
<dl class="py class">
<dt id="common.models.records.TrackedModel">
<em class="property"><span class="pre">class</span> </em><code class="sig-prename descclassname"><span class="pre">common.models.records.</span></code><code class="sig-name descname"><span class="pre">TrackedModel</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">polymorphic_ctype</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transaction</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">update_type</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version_group</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/common/models/records.html#TrackedModel"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#common.models.records.TrackedModel" title="Permalink to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt id="common.models.records.TrackedModel.identifying_fields">
<code class="sig-name descname"><span class="pre">identifying_fields</span></code><em class="property"><span class="pre">:</span> <span class="pre">Iterable</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></em><em class="property"> <span class="pre">=</span> <span class="pre">('sid',)</span></em><a class="headerlink" href="#common.models.records.TrackedModel.identifying_fields" title="Permalink to this definition">¶</a></dt>
<dd><p>The fields which together form a composite unique key for each model.</p>
<p>The system ID (or SID) field is normally the unique identifier of a TARIC
model, but in places where this does not exist models can declare their own.
(Note that because mutliple versions of each model will exist this does not
actually equate to a <code class="docutils literal notranslate"><span class="pre">UNIQUE</span></code> constraint in the database.)</p>
</dd></dl>

<dl class="py attribute">
<dt id="common.models.records.TrackedModel.record_code">
<code class="sig-name descname"><span class="pre">record_code</span></code><em class="property"><span class="pre">:</span> <span class="pre">int</span></em><a class="headerlink" href="#common.models.records.TrackedModel.record_code" title="Permalink to this definition">¶</a></dt>
<dd><p>The type id of this model’s type family in the TARIC specification.</p>
<p>This number groups together a number of different models into ‘records’.
Where two models share a record code, they are conceptually expressing
different properties of the same logical model.</p>
<p>In theory each <code class="xref py py-class docutils literal notranslate"><span class="pre">Transaction</span></code> should only contain
models with a single <a class="reference internal" href="#common.models.records.TrackedModel.record_code" title="common.models.records.TrackedModel.record_code"><code class="xref py py-attr docutils literal notranslate"><span class="pre">record_code</span></code></a> (but differing
<a class="reference internal" href="#common.models.records.TrackedModel.subrecord_code" title="common.models.records.TrackedModel.subrecord_code"><code class="xref py py-attr docutils literal notranslate"><span class="pre">subrecord_code</span></code></a>.)</p>
</dd></dl>

<dl class="py attribute">
<dt id="common.models.records.TrackedModel.subrecord_code">
<code class="sig-name descname"><span class="pre">subrecord_code</span></code><em class="property"><span class="pre">:</span> <span class="pre">int</span></em><a class="headerlink" href="#common.models.records.TrackedModel.subrecord_code" title="Permalink to this definition">¶</a></dt>
<dd><p>The type id of this model in the TARIC specification. The
<a class="reference internal" href="#common.models.records.TrackedModel.subrecord_code" title="common.models.records.TrackedModel.subrecord_code"><code class="xref py py-attr docutils literal notranslate"><span class="pre">subrecord_code</span></code></a> when combined with the <a class="reference internal" href="#common.models.records.TrackedModel.record_code" title="common.models.records.TrackedModel.record_code"><code class="xref py py-attr docutils literal notranslate"><span class="pre">record_code</span></code></a> uniquely
identifies the type within the specification.</p>
<p>The subrecord code gives the intended order for models in a transaction,
with comparatively smaller subrecord codes needing to come before larger
ones.</p>
</dd></dl>

<dl class="py attribute">
<dt id="common.models.records.TrackedModel.update_type">
<code class="sig-name descname"><span class="pre">update_type</span></code><em class="property"><span class="pre">:</span> <span class="pre">common.validators.UpdateType</span></em><a class="headerlink" href="#common.models.records.TrackedModel.update_type" title="Permalink to this definition">¶</a></dt>
<dd><p>The change that was made to the model when this version of the model was
authored.</p>
<p>The first version should always have <code class="xref py py-data docutils literal notranslate"><span class="pre">CREATE</span></code>,
subsequent versions will have <code class="xref py py-data docutils literal notranslate"><span class="pre">UPDATE</span></code> and the
final version will have <code class="xref py py-data docutils literal notranslate"><span class="pre">DELETE</span></code>. Deleted
models that reappear for the same <a class="reference internal" href="#common.models.records.TrackedModel.identifying_fields" title="common.models.records.TrackedModel.identifying_fields"><code class="xref py py-attr docutils literal notranslate"><span class="pre">identifying_fields</span></code></a> will have a new
<a class="reference internal" href="#common.models.records.TrackedModel.version_group" title="common.models.records.TrackedModel.version_group"><code class="xref py py-attr docutils literal notranslate"><span class="pre">version_group</span></code></a> created.</p>
</dd></dl>

<dl class="py attribute">
<dt id="common.models.records.TrackedModel.version_group">
<code class="sig-name descname"><span class="pre">version_group</span></code><a class="headerlink" href="#common.models.records.TrackedModel.version_group" title="Permalink to this definition">¶</a></dt>
<dd><p>Each version group contains all of the versions of the same logical model.</p>
<p>When a new version of a model is authored (e.g. to
<code class="xref py py-data docutils literal notranslate"><span class="pre">DELETE</span></code> it) a new model row is created and
added to the same version group as the existing model being changed.</p>
<p>Models are identified logically by their <a class="reference internal" href="#common.models.records.TrackedModel.identifying_fields" title="common.models.records.TrackedModel.identifying_fields"><code class="xref py py-attr docutils literal notranslate"><span class="pre">identifying_fields</span></code></a>, so
within one version group all of the models should have the same values for
these fields.</p>
</dd></dl>

</dd></dl>

<p>Note that which version of a model is the “current” one depends in general on
what transactions have been applied. Each row is pinned to a specific
transaction in order to allow working out which model is the current version as
of a certain transaction. As TaMaTo will also deal with draft data, what is
“current” is somewhat dependent on what draft data is being considered.</p>
<p>In general, the system will consider any version that has been “approved” to be
eligible to be “current”, such that the version from the most recent transaction
that is not draft is considered to be “current”.</p>
<p>There are a number of convenience methods for finding “current” models.</p>
<dl class="py class">
<dt id="common.models.records.TrackedModelQuerySet">
<em class="property"><span class="pre">class</span> </em><code class="sig-prename descclassname"><span class="pre">common.models.records.</span></code><code class="sig-name descname"><span class="pre">TrackedModelQuerySet</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/common/models/records.html#TrackedModelQuerySet"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#common.models.records.TrackedModelQuerySet" title="Permalink to this definition">¶</a></dt>
<dd><dl class="py method">
<dt id="common.models.records.TrackedModelQuerySet.approved_up_to_transaction">
<code class="sig-name descname"><span class="pre">approved_up_to_transaction</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">transaction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> &#x2192; <span class="pre">django.db.models.query.QuerySet</span><a class="reference internal" href="../../_modules/common/models/records.html#TrackedModelQuerySet.approved_up_to_transaction"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#common.models.records.TrackedModelQuerySet.approved_up_to_transaction" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the approved versions of the model being queried unless there exists
a version of the model in a draft state within a transaction preceding
(and including) the given transaction in the workbasket of the given
transaction.</p>
<p>The generated SQL is equivalent to:</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span>SELECT *,
       Max(t3.&quot;id&quot;) filter (
           WHERE (
               t3.&quot;transaction_id&quot; = {TRANSACTION_ID}
            OR (&quot;common_transaction&quot;.&quot;order&quot; &lt; {TRANSACTION_ORDER} AND &quot;common_transaction&quot;.&quot;workbasket_id&quot; = {WORKBASKET_ID})
            OR (&quot;workbaskets_workbasket&quot;.&quot;approver_id&quot; IS NOT NULL AND &quot;workbaskets_workbasket&quot;.&quot;status&quot; IN (APPROVED_STATUSES))
           )
       ) AS &quot;latest&quot;
  FROM &quot;common_trackedmodel&quot;
 INNER JOIN &quot;common_versiongroup&quot;
    ON &quot;common_trackedmodel&quot;.&quot;version_group_id&quot; = &quot;common_versiongroup&quot;.&quot;id&quot;
  LEFT OUTER JOIN &quot;common_trackedmodel&quot; t3
    ON &quot;common_versiongroup&quot;.&quot;id&quot; = t3.&quot;version_group_id&quot;
  LEFT OUTER JOIN &quot;common_transaction&quot;
    ON t3.&quot;transaction_id&quot; = &quot;common_transaction&quot;.&quot;id&quot;
  LEFT OUTER JOIN &quot;workbaskets_workbasket&quot;
    ON &quot;common_transaction&quot;.&quot;workbasket_id&quot; = &quot;workbaskets_workbasket&quot;.&quot;id&quot;
 WHERE NOT &quot;common_trackedmodel&quot;.&quot;update_type&quot; = 2
 GROUP BY &quot;common_trackedmodel&quot;.&quot;id&quot;
HAVING max(t3.&quot;id&quot;) filter (
           WHERE (
               t3.&quot;transaction_id&quot; = {TRANSACTION_ID}
            OR (&quot;common_transaction&quot;.&quot;order&quot; &lt; {TRANSACTION_ORDER} AND &quot;common_transaction&quot;.&quot;workbasket_id&quot; = {WORKBASKET_ID})
            OR (&quot;workbaskets_workbasket&quot;.&quot;approver_id&quot; IS NOT NULL AND &quot;workbaskets_workbasket&quot;.&quot;status&quot; IN (APPROVED_STATUSES))
           )
) = &quot;common_trackedmodel&quot;.&quot;id&quot;
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt id="common.models.records.TrackedModelQuerySet.latest_approved">
<code class="sig-name descname"><span class="pre">latest_approved</span></code><span class="sig-paren">(</span><span class="sig-paren">)</span> &#x2192; <span class="pre">django.db.models.query.QuerySet</span><a class="reference internal" href="../../_modules/common/models/records.html#TrackedModelQuerySet.latest_approved"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#common.models.records.TrackedModelQuerySet.latest_approved" title="Permalink to this definition">¶</a></dt>
<dd><p>Get all the latest versions of the model being queried which have been
approved.</p>
<p>This will specifically fetch the most recent approved row pertaining to an object.
If a row is unapproved, or has subsequently been rejected after approval, it should
not be included in the returned QuerySet. Likewise any objects which have never been
approved (are in draft as an initial create step) should not appear in the queryset.
Any row marked as deleted will also not be fetched.</p>
<p>If done from the TrackedModel this will return the objects for all tracked models.</p>
</dd></dl>

</dd></dl>

</div>
</div>
<div class="section" id="domain-modules">
<h2>Domain Modules<a class="headerlink" href="#domain-modules" title="Permalink to this headline">¶</a></h2>
<p>The tariffs domain model is implemented across a number of <strong>domain modules</strong>,
each itself a Django App. Each module is responsible for one family of tariff
objects.</p>
<div class="section" id="module-measures">
<span id="measures"></span><h3><a class="reference internal" href="#module-measures" title="measures"><code class="xref py py-mod docutils literal notranslate"><span class="pre">measures</span></code></a><a class="headerlink" href="#module-measures" title="Permalink to this headline">¶</a></h3>
<p>Measures are the fundamental building blocks of the tariff, they link
everything together, and each piece of trade legislation that impacts the trade
of goods must be translated into one or more measures.</p>
</div>
<div class="section" id="module-commodities">
<span id="commodities"></span><h3><a class="reference internal" href="#module-commodities" title="commodities"><code class="xref py py-mod docutils literal notranslate"><span class="pre">commodities</span></code></a><a class="headerlink" href="#module-commodities" title="Permalink to this headline">¶</a></h3>
<p>Commodity codes are 10-digit codes that refer to specific products. Traders must
put these codes on their declaration forms when importing or exporting goods.</p>
<p>Nomenclature, also known as goods classification, goods nomenclature or
commodity code classification, is the name for the full list of products in the
UK Tariff.</p>
</div>
<div class="section" id="module-additional_codes">
<span id="additional-codes"></span><h3><a class="reference internal" href="#module-additional_codes" title="additional_codes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">additional_codes</span></code></a><a class="headerlink" href="#module-additional_codes" title="Permalink to this headline">¶</a></h3>
<p>Additional codes are used when the 10-digit commodity code is not enough to
identify the context for the trade.</p>
<p>For example, for trade remedy purposes most additional codes identify the
companies that the trade is coming from.</p>
</div>
<div class="section" id="module-quotas">
<span id="quotas"></span><h3><a class="reference internal" href="#module-quotas" title="quotas"><code class="xref py py-mod docutils literal notranslate"><span class="pre">quotas</span></code></a><a class="headerlink" href="#module-quotas" title="Permalink to this headline">¶</a></h3>
<p>Quotas are used to control quantities of particular goods being imported.</p>
</div>
<div class="section" id="module-certificates">
<span id="certificates"></span><h3><a class="reference internal" href="#module-certificates" title="certificates"><code class="xref py py-mod docutils literal notranslate"><span class="pre">certificates</span></code></a><a class="headerlink" href="#module-certificates" title="Permalink to this headline">¶</a></h3>
<p>Certificates, licenses, and non-paper conditions are sometimes required to bring
goods through customs.</p>
<p>A certificate is not a representation of the actual document itself – the
database stores only a certificate code (4 digits) and a description of that
code.</p>
</div>
<div class="section" id="module-geo_areas">
<span id="geo-areas"></span><h3><a class="reference internal" href="#module-geo_areas" title="geo_areas"><code class="xref py py-mod docutils literal notranslate"><span class="pre">geo_areas</span></code></a><a class="headerlink" href="#module-geo_areas" title="Permalink to this headline">¶</a></h3>
<p>Geographical areas represent areas to which goods can be imported or exported.</p>
<p>All measures and quotas apply to a geographical area which may contain single or
multiple countries.</p>
</div>
<div class="section" id="module-regulations">
<span id="regulations"></span><h3><a class="reference internal" href="#module-regulations" title="regulations"><code class="xref py py-mod docutils literal notranslate"><span class="pre">regulations</span></code></a><a class="headerlink" href="#module-regulations" title="Permalink to this headline">¶</a></h3>
<p>Regulations represent peices of legislation that empower tariff measures.</p>
</div>
<div class="section" id="module-footnotes">
<span id="footnotes"></span><h3><a class="reference internal" href="#module-footnotes" title="footnotes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">footnotes</span></code></a><a class="headerlink" href="#module-footnotes" title="Permalink to this headline">¶</a></h3>
<p>Footnotes are used to give more human-readable information about measures or
the use of commodity codes.</p>
</div>
</div>
<div class="section" id="inside-domain-modules">
<h2>Inside Domain Modules<a class="headerlink" href="#inside-domain-modules" title="Permalink to this headline">¶</a></h2>
<p>Each domain module has a similar layout, some of which is inherited from the
Django system. Inside each domain module, you might expect to see the following,
either as modules themselves or single files.</p>
<div class="section" id="models">
<h3><code class="docutils literal notranslate"><span class="pre">models</span></code><a class="headerlink" href="#models" title="Permalink to this headline">¶</a></h3>
<p>Classes representing domain models. With again a few exceptions, most models
correspond directly to an element in the TARIC specification. Most of these will
inherit from <a class="reference internal" href="#common.models.records.TrackedModel" title="common.models.records.TrackedModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">TrackedModel</span></code></a> which represents a
model for whom history is being tracked.</p>
<p>(The main exception is
<code class="xref py py-class docutils literal notranslate"><span class="pre">GoodsNomenclatureIndentNode</span></code> which is really just a
cache of the commodity code tree stored in the database and is not updated
independently of related models.)</p>
<p>The most notable places where the database schema has diverged from the TARIC
specification is on descriptions, which have been flattened into a single model
that represents both the description and the description period on the
assumption that we will only support English as a language, and for
<a class="reference internal" href="#module-regulations" title="regulations"><code class="xref py py-mod docutils literal notranslate"><span class="pre">regulations</span></code></a>, where the UK legislative model is considerably simpler than
its European counterpart.</p>
</div>
<div class="section" id="business-rules">
<h3><code class="docutils literal notranslate"><span class="pre">business_rules</span></code><a class="headerlink" href="#business-rules" title="Permalink to this headline">¶</a></h3>
<p>Classes that implement business logic checking on models. Most of the business
rules are defined by the TARIC specification. There are also some places where
new business rules have been written either based on observation of how
downstream systems react to certain situations or through a desire to more
tightly control the function of the system.</p>
<p>Business rules from the TARIC specification are named for the business rule code
used in that spec (e.g. <a class="reference internal" href="../business_rules/measures.html#measures.business_rules.ME32" title="measures.business_rules.ME32"><code class="xref py py-class docutils literal notranslate"><span class="pre">ME32</span></code></a>) and business
rules that have been added to the system are given descriptive names. Each
business rule has a docstring that describes the rule.</p>
</div>
<div class="section" id="patterns">
<h3><code class="docutils literal notranslate"><span class="pre">patterns</span></code><a class="headerlink" href="#patterns" title="Permalink to this headline">¶</a></h3>
<p>Objects that implement an operation on the data taking into account the
high-level domain logic around how the tariff actually works. These are
responsible for providing a simple interface to create data that will pass the
more complex business rules around relationships between models and for encoding
how certain situations are handled.</p>
<p>For example, “origin quotas” are a special kind of quota that require a proof of
origin certificate, and the <code class="xref py py-class docutils literal notranslate"><span class="pre">MeasureCreationPattern</span></code>
has a specific argument to its
<code class="xref py py-meth docutils literal notranslate"><span class="pre">create()</span></code> method that will set up
the measure conditions correctly to handle this use case. There is nothing in
the business rules that specifies how origin quotas should be handled (and hence
it may change in the future), but at the moment they are always implemented in a
specific way and the pattern encodes that implementation.</p>
<p>So where the tariff works a certain way as the result of a business decision as
opposed to a constraint in the data, that decision should be implemented as a
pattern.</p>
</div>
<div class="section" id="serializers">
<h3><code class="docutils literal notranslate"><span class="pre">serializers</span></code><a class="headerlink" href="#serializers" title="Permalink to this headline">¶</a></h3>
<p>Classes that implement serialization logic. Most are derived from Django REST
Framework’s serializer base class. The serializers are mostly used to output
TARIC3 XML and for this they rely on XML templates written in the Jinja2
templating language.</p>
</div>
<div class="section" id="import-parsers-and-import-handlers">
<h3><code class="docutils literal notranslate"><span class="pre">import_parsers</span></code> and <code class="docutils literal notranslate"><span class="pre">import_handlers</span></code><a class="headerlink" href="#import-parsers-and-import-handlers" title="Permalink to this headline">¶</a></h3>
<p>These are classes that extract data from TARIC XML and process that data into
complete models with all linked dependencies respectively.</p>
<p>See the documentation on <a class="reference internal" href="../importer/index.html#the-importer"><span class="std std-ref">the importer</span></a> for a full
description.</p>
</div>
<div class="section" id="validators">
<h3><code class="docutils literal notranslate"><span class="pre">validators</span></code><a class="headerlink" href="#validators" title="Permalink to this headline">¶</a></h3>
<p>Classes that implement model-specific validation routines. These mostly
implement rules around the correct formatting of data (e.g. if the code of a
model has the correct number of digits) compared to the business rules which
check correctness of fields and relationships between models.</p>
</div>
<div class="section" id="querysets">
<h3><code class="docutils literal notranslate"><span class="pre">querysets</span></code><a class="headerlink" href="#querysets" title="Permalink to this headline">¶</a></h3>
<p>Implementations of custom Django QuerySet classes that represent complex
database queries. In some places it is desirable to more tightly control how the
system fetches it’s data – for example, to efficiently generate a new field using
aggregates.</p>
<p>The <a class="reference internal" href="#common.models.records.TrackedModelQuerySet" title="common.models.records.TrackedModelQuerySet"><code class="xref py py-class docutils literal notranslate"><span class="pre">TrackedModelQuerySet</span></code></a> is one of the most used
as it implements selecting the correct versions from the version control system.</p>
</div>
<div class="section" id="parsers">
<h3><code class="docutils literal notranslate"><span class="pre">parsers</span></code><a class="headerlink" href="#parsers" title="Permalink to this headline">¶</a></h3>
<p>Classes that implement custom parsers for use in translating from simple strings
in the user interface or spreadsheets into model objects (or sets of them).
These do not generally follow a specific implementation pattern.</p>
</div>
<div class="section" id="filters">
<h3><code class="docutils literal notranslate"><span class="pre">filters</span></code><a class="headerlink" href="#filters" title="Permalink to this headline">¶</a></h3>
<p>Django-style filter objects used by the search interfaces.</p>
</div>
<div class="section" id="views">
<h3><code class="docutils literal notranslate"><span class="pre">views</span></code><a class="headerlink" href="#views" title="Permalink to this headline">¶</a></h3>
<p>Django-style view objects used by the user interface.</p>
</div>
</div>
<div class="section" id="cross-cutting-modules">
<h2>Cross-Cutting Modules<a class="headerlink" href="#cross-cutting-modules" title="Permalink to this headline">¶</a></h2>
<p>As well as domain modules, there are also a number of modules that provide
cross-cutting concerns to the rest of the system.</p>
<div class="section" id="module-importer">
<span id="importer"></span><h3><a class="reference internal" href="#module-importer" title="importer"><code class="xref py py-mod docutils literal notranslate"><span class="pre">importer</span></code></a><a class="headerlink" href="#module-importer" title="Permalink to this headline">¶</a></h3>
<p>Implements a scalable and robust system for extracting data from TARIC XML seed
and delta files and storing them correctly in TaMaTo.</p>
<p>See the documentation on the <a class="reference internal" href="../importer/nursery.html#module-importer.nursery" title="importer.nursery"><code class="xref py py-mod docutils literal notranslate"><span class="pre">nursery</span></code></a>,
<a class="reference internal" href="../importer/handlers.html#module-importer.handlers" title="importer.handlers"><code class="xref py py-mod docutils literal notranslate"><span class="pre">handlers</span></code></a>, <a class="reference internal" href="../importer/parsers_and_namespaces.html#module-importer.parsers" title="importer.parsers"><code class="xref py py-mod docutils literal notranslate"><span class="pre">parsers</span></code></a>, <a class="reference internal" href="../importer/parsers_and_namespaces.html#module-importer.namespaces" title="importer.namespaces"><code class="xref py py-mod docutils literal notranslate"><span class="pre">namespaces</span></code></a>
and <a class="reference internal" href="../importer/taric.html#module-importer.taric" title="importer.taric"><code class="xref py py-mod docutils literal notranslate"><span class="pre">taric</span></code></a> for more information.</p>
</div>
<div class="section" id="module-exporter">
<span id="exporter"></span><h3><a class="reference internal" href="#module-exporter" title="exporter"><code class="xref py py-mod docutils literal notranslate"><span class="pre">exporter</span></code></a><a class="headerlink" href="#module-exporter" title="Permalink to this headline">¶</a></h3>
<p>Classes for exposing a number of different output data formats.</p>
<p>Most notably, the exporter module implements the correct output of the
transaction stream into TARIC XML envelopes and handles the process by which
these envelopes are marshalled to CDS.</p>
<p>This module also makes available the objects in the system as an <a class="reference external" href="https://www.w3.org/TR/activitypub/">ActivityPub</a> endpoint.</p>
</div>
<div class="section" id="module-hmrc_sdes">
<span id="hmrc-sdes"></span><h3><a class="reference internal" href="#module-hmrc_sdes" title="hmrc_sdes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">hmrc_sdes</span></code></a><a class="headerlink" href="#module-hmrc_sdes" title="Permalink to this headline">¶</a></h3>
<p>Provides the ability to communicate with HMRC’s Secure Data Exchange Service
(SDES).</p>
<p>When TaMaTo wants to send tariff updates to CDS, it must first make an
<code class="xref py py-class docutils literal notranslate"><span class="pre">Envelope</span></code> file available from an SFTP endpoint. It must
then notify SDES via an HTTPS API that a file is ready to be downloaded. This
module makes available the API client library to make the call.</p>
<p>More information about SDES is available from <a class="reference external" href="https://developer.service.hmrc.gov.uk/api-documentation/docs/api/service/secure-data-exchange-notifications/1.0">the HMRC developer hub</a>.</p>
</div>
<div class="section" id="id1">
<h3><a class="reference internal" href="#module-taric" title="taric"><code class="xref py py-mod docutils literal notranslate"><span class="pre">taric</span></code></a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-taric"></span><p>Implements models used by the <a class="reference internal" href="#module-exporter" title="exporter"><code class="xref py py-mod docutils literal notranslate"><span class="pre">exporter</span></code></a> to keep track of which
envelopes the system has generated and which transactions they contained.</p>
</div>
<div class="section" id="module-workbaskets">
<span id="workbaskets"></span><h3><a class="reference internal" href="#module-workbaskets" title="workbaskets"><code class="xref py py-mod docutils literal notranslate"><span class="pre">workbaskets</span></code></a><a class="headerlink" href="#module-workbaskets" title="Permalink to this headline">¶</a></h3>
<p>Provides classes and models for tracking draft data and implements the
workflow that data must go through before publication.</p>
<dl class="py class">
<dt id="workbaskets.models.WorkBasket">
<em class="property"><span class="pre">class</span> </em><code class="sig-prename descclassname"><span class="pre">workbaskets.models.</span></code><code class="sig-name descname"><span class="pre">WorkBasket</span></code><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../_modules/workbaskets/models.html#WorkBasket"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#workbaskets.models.WorkBasket" title="Permalink to this definition">¶</a></dt>
<dd><p>A WorkBasket groups tariff edits which will be applied at the same time.</p>
<p>WorkBasket status is controlled by a state machine:
See <a class="reference external" href="https://uktrade.atlassian.net/wiki/spaces/TARIFFSALPHA/pages/953581609/a.+Workbasket+workflow">https://uktrade.atlassian.net/wiki/spaces/TARIFFSALPHA/pages/953581609/a.+Workbasket+workflow</a></p>
</dd></dl>

</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Architecture</a><ul>
<li><a class="reference internal" href="#bird-s-eye-view">Bird’s Eye View</a></li>
<li><a class="reference internal" href="#concepts">Concepts</a><ul>
<li><a class="reference internal" href="#taric">TARIC</a></li>
<li><a class="reference internal" href="#validity-dates-as-version-control">Validity dates as version control</a></li>
<li><a class="reference internal" href="#tracked-models-as-version-control">Tracked models as version control</a></li>
</ul>
</li>
<li><a class="reference internal" href="#domain-modules">Domain Modules</a><ul>
<li><a class="reference internal" href="#module-measures"><code class="xref py py-mod docutils literal notranslate"><span class="pre">measures</span></code></a></li>
<li><a class="reference internal" href="#module-commodities"><code class="xref py py-mod docutils literal notranslate"><span class="pre">commodities</span></code></a></li>
<li><a class="reference internal" href="#module-additional_codes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">additional_codes</span></code></a></li>
<li><a class="reference internal" href="#module-quotas"><code class="xref py py-mod docutils literal notranslate"><span class="pre">quotas</span></code></a></li>
<li><a class="reference internal" href="#module-certificates"><code class="xref py py-mod docutils literal notranslate"><span class="pre">certificates</span></code></a></li>
<li><a class="reference internal" href="#module-geo_areas"><code class="xref py py-mod docutils literal notranslate"><span class="pre">geo_areas</span></code></a></li>
<li><a class="reference internal" href="#module-regulations"><code class="xref py py-mod docutils literal notranslate"><span class="pre">regulations</span></code></a></li>
<li><a class="reference internal" href="#module-footnotes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">footnotes</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#inside-domain-modules">Inside Domain Modules</a><ul>
<li><a class="reference internal" href="#models"><code class="docutils literal notranslate"><span class="pre">models</span></code></a></li>
<li><a class="reference internal" href="#business-rules"><code class="docutils literal notranslate"><span class="pre">business_rules</span></code></a></li>
<li><a class="reference internal" href="#patterns"><code class="docutils literal notranslate"><span class="pre">patterns</span></code></a></li>
<li><a class="reference internal" href="#serializers"><code class="docutils literal notranslate"><span class="pre">serializers</span></code></a></li>
<li><a class="reference internal" href="#import-parsers-and-import-handlers"><code class="docutils literal notranslate"><span class="pre">import_parsers</span></code> and <code class="docutils literal notranslate"><span class="pre">import_handlers</span></code></a></li>
<li><a class="reference internal" href="#validators"><code class="docutils literal notranslate"><span class="pre">validators</span></code></a></li>
<li><a class="reference internal" href="#querysets"><code class="docutils literal notranslate"><span class="pre">querysets</span></code></a></li>
<li><a class="reference internal" href="#parsers"><code class="docutils literal notranslate"><span class="pre">parsers</span></code></a></li>
<li><a class="reference internal" href="#filters"><code class="docutils literal notranslate"><span class="pre">filters</span></code></a></li>
<li><a class="reference internal" href="#views"><code class="docutils literal notranslate"><span class="pre">views</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#cross-cutting-modules">Cross-Cutting Modules</a><ul>
<li><a class="reference internal" href="#module-importer"><code class="xref py py-mod docutils literal notranslate"><span class="pre">importer</span></code></a></li>
<li><a class="reference internal" href="#module-exporter"><code class="xref py py-mod docutils literal notranslate"><span class="pre">exporter</span></code></a></li>
<li><a class="reference internal" href="#module-hmrc_sdes"><code class="xref py py-mod docutils literal notranslate"><span class="pre">hmrc_sdes</span></code></a></li>
<li><a class="reference internal" href="#id1"><code class="xref py py-mod docutils literal notranslate"><span class="pre">taric</span></code></a></li>
<li><a class="reference internal" href="#module-workbaskets"><code class="xref py py-mod docutils literal notranslate"><span class="pre">workbaskets</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../code.html"
                        title="previous chapter">Code Documentation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../importer/index.html"
                        title="next chapter">The Importer</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/docs/architecture/index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../importer/index.html" title="The Importer"
             >next</a> |</li>
        <li class="right" >
          <a href="../code.html" title="Code Documentation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TaMaTo 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../code.html" >Code Documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Architecture</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, DIT.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.1.
    </div>
  </body>
</html>