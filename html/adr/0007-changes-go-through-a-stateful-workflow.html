<!DOCTYPE html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>7. Changes go through a stateful workflow - DBT Tariff Management Tool</title>
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/javascripts/_analytics.js"></script>
    <script src="../_static/javascripts/_govuk/govuk-frontend-3.10.2.min.js"></script>
    <script src="../_static/javascripts/_govuk/modules.js"></script>
    <script src="../_static/javascripts/_modules/anchored-headings.js"></script>
    <script src="../_static/javascripts/_modules/collapsible-navigation.js"></script>
    <script src="../_static/javascripts/_modules/in-page-navigation.js"></script>
    <script src="../_static/javascripts/_modules/navigation.js"></script>
    <script src="../_static/javascripts/_modules/page-expiry.js"></script>
    <script src="../_static/javascripts/_modules/table-of-contents.js"></script>
    <script src="../_static/javascripts/_start_modules.js"></script>
    <script src="../_static/javascripts/_vendor/fixedsticky.js"></script>
    <script src="../_static/javascripts/_vendor/lodash.js"></script>
    <script src="../_static/javascripts/_vendor/modernizer.js"></script>
    <script src="../_static/javascripts/govuk_tech_docs.js"></script>
    <script src="../_static/javascripts/theme.js"></script>
    <link href="../_static/stylesheets/manifest.css" rel="stylesheet" />
    <link href="../_static/stylesheets/theme.css" rel="stylesheet" />
    <link rel="shortcut icon" href="../_static//favicon.ico"/>
  </head>
  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>
        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
          <div class="govuk-header__container govuk-header__container--full-width">

            <div class="govuk-header__logo">
  <a href="../index.html" class="govuk-header__link govuk-header__link--homepage">
    <span class="govuk-header__logotype"><image src="../_static/tudor-crown-logo.svg" xlink:href="" class="govuk-header__logotype-crown" height="30" width="36"></image>
      
      <span class="govuk-header__logotype-text">DBT</span>
    </span>
    <span class="govuk-header__product-name">Tariff Management Tool</span>
  </a><strong class="govuk-tag">Alpha</strong></div>
            <div class="govuk-header__content" role="navigation">
  <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
  <nav>
    <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
      <li class="govuk-header__navigation-item">
        <a class="govuk-header__link" href="https://github.com/uktrade/tamato">GitHub</a>
        </li>
    </ul>
  </nav>
</div>

          </div>
        </header>
      </div>
      <div id="toc-heading" class="toc-show fixedsticky">
        <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
        Table of contents <span class="toc-show__icon"></span>
        </a>
      </div>
      <div class="app-pane__body" data-module="in-page-navigation">

        <div class="app-pane__toc" role="navigation">
  <div class="toc" data-module="table-of-contents">
    <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>

    <div class="search" data-module="search">
  <form action="../search.html" method="get" role="search">
    <label class="govuk-label search__label" for="search">Search</label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
</div>

    <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">

      
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tariff Management Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../envvars.html">Environment variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Architectural Decision Records</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="0001-record-architecture-decisions.html">1. Record architecture decisions</a></li>
<li class="toctree-l2"><a class="reference internal" href="0002-use-pytest-bdd-for-bdd-testing.html">2. Use pytest-bdd for BDD testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="0003-use-django-rest-framework.html">3. Use Django REST Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="0004-xml-export-and-import.html">4. XML Import and Export</a></li>
<li class="toctree-l2"><a class="reference internal" href="0005-use-model-tracking-and-workbaskets.html">5. Use tracked models and workbaskets</a></li>
<li class="toctree-l2"><a class="reference internal" href="0006-use-django-polymorphic.html">6. Use Django Polymorphic for Multi-Table Inheritance</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">7. Changes go through a stateful workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="#consequences">Consequences</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="0008-simplify-workflow-states.html">8. Simplify workflow states</a></li>
<li class="toctree-l2"><a class="reference internal" href="0009-record-generated-envelopes.html">9. Generate envelope files</a></li>
<li class="toctree-l2"><a class="reference internal" href="0010-convert-the-importer-to-a-pipeline.html">10. Convert the XML importer to a pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="0011-store-and-check-preference-codes.html">11. Store and check business rules around preference codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="0012-ordering-of-tariff-transactions.html">12. Ordering of tariff transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="0013-import-taric-nomenclature-updates.html">13. Import TARIC nomenclature updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="0014-simplify-current-transaction-queries.html">14. Simplification of current transaction queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="0015-make-reverse-relations-aware-of-versions.html">15. Make reverse relations aware of versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="0016-split-transactions-into-partitions-to-simplify-global-transaction-ordering.html">Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="0016-split-transactions-into-partitions-to-simplify-global-transaction-ordering.html#context">Context</a></li>
<li class="toctree-l2"><a class="reference internal" href="0016-split-transactions-into-partitions-to-simplify-global-transaction-ordering.html#transaction-types">Transaction Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="0016-split-transactions-into-partitions-to-simplify-global-transaction-ordering.html#grouping-concepts">Grouping Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="0016-split-transactions-into-partitions-to-simplify-global-transaction-ordering.html#problems">Problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="0016-split-transactions-into-partitions-to-simplify-global-transaction-ordering.html#decision">Decision</a></li>
<li class="toctree-l2"><a class="reference internal" href="0016-split-transactions-into-partitions-to-simplify-global-transaction-ordering.html#caveats">Caveats</a></li>
<li class="toctree-l2"><a class="reference internal" href="0016-split-transactions-into-partitions-to-simplify-global-transaction-ordering.html#getting-data-into-the-correct-partition">Getting data into the correct partition</a></li>
<li class="toctree-l2"><a class="reference internal" href="0016-split-transactions-into-partitions-to-simplify-global-transaction-ordering.html#consequences">Consequences</a></li>
<li class="toctree-l2"><a class="reference internal" href="0016-split-transactions-into-partitions-to-simplify-global-transaction-ordering.html#conclusion-what-is-not-covered">Conclusion, what is not covered</a></li>
<li class="toctree-l2"><a class="reference internal" href="0016-split-transactions-into-partitions-to-simplify-global-transaction-ordering.html#implementation">Implementation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../business_rules/index.html">Business Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../taric/index.html">TARIC3 Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../importer/index.html">The Importer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exporter/index.html">The Exporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/gherkin.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CODE_OF_CONDUCT.html">Contributor Covenant Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

      <hr size="1">

      
      <h1>On this page</h1>
      <ul>
<li><a class="reference internal" href="#">7. Changes go through a stateful workflow</a><ul>
<li><a class="reference internal" href="#status">Status</a></li>
<li><a class="reference internal" href="#context">Context</a></li>
<li><a class="reference internal" href="#decision">Decision</a></li>
<li><a class="reference internal" href="#consequences">Consequences</a></li>
</ul>
</li>
</ul>


    </nav>
  </div>
</div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings" role="main">

            
  <section id="changes-go-through-a-stateful-workflow">
<span id="id1"></span><h1>7. Changes go through a stateful workflow<a class="headerlink" href="#changes-go-through-a-stateful-workflow" title="Permalink to this headline">¶</a></h1>
<p>Date: 2020-06-02</p>
<section id="status">
<h2>Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p>Approved, partially superseded by
<a class="reference external" href="./0008-simplify-workflow-states">ADR-0008</a>.</p>
</section>
<section id="context">
<h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">¶</a></h2>
<p>When a change is made to data in the Tariff Management Tool there are
various actions that must take place before it becomes live in border
systems. E.g.</p>
<ol class="arabic simple">
<li><p>A user makes changes.</p></li>
<li><p>The change must be approved by an authorised user.</p></li>
<li><p>The change must be exported as XML and sent to CDS.</p></li>
<li><p>CDS systems must approve the change and return a receipt of validity.</p></li>
<li><p>The changes are published.</p></li>
</ol>
<p>We must keep track of the position of a change in this workflow.
Previous ADRs have introduced <a class="reference external" href="./0004-use-model-tracking-and-workbaskets">a Finite State Machine style
system</a> for workbaskets
and a <a class="reference external" href="./0005-use-django-polymorphic">live/draft flags style system</a>
for tracked models.</p>
<p>We have realised that there are two concepts of “liveness” that arise
because we must keep track of changes to a TARIC-style database, which
itself is also a versioning system:</p>
<ul class="simple">
<li><p><strong>Database liveness</strong> which is where a row is the most current
version of a certain domain object.</p></li>
<li><p><strong>Operational liveness</strong> which is where a domain object is actually
being applied at the border.</p></li>
</ul>
<p>Database liveness is dependent on context. Sometimes we will need to see
the latest version of something based on a workbasket, or we will need
to take into account what has been approved and sent to CDS, or only
what has been published. So the mechanism which selects which are the
“most current” rows must vary based on the state of the workbasket, and
not just a single flag.</p>
<p>Once exposed transactions must be immutable so as to power a
change-based API. This means that once a user can download a transaction
it cannot be changed, thus the user never has to download it again. We
need to take into account that workbaskets will not be approved in
order, and CDS may error some transactions and not others, again not in
order.</p>
<p>We should also retain the history of all approved transactions which
have been sent to CDS as a minimum. This is for both audit and debugging
purposes.</p>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">¶</a></h2>
<p><img alt="Schema of TrackedModels and Workbaskets" src="../_images/tracked_model_workbasket_schema_updated.png" /></p>
<p>We will adopt the terms “database-live” and “operationally-live” as per
the definitions above in future documentation.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code> will no longer have a <code class="docutils literal notranslate"><span class="pre">live</span></code> or <code class="docutils literal notranslate"><span class="pre">draft</span></code> flag –
instead for this we use the state of the workbasket.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">predecessor</span></code> column on the TrackedModel will be nullable and this
is (along with the <code class="docutils literal notranslate"><span class="pre">update_type</span></code>) is how we know if a record is
created or updated.</p>
<p>To get the database-live rows, we can perform a query that selects only
the model without a <code class="docutils literal notranslate"><span class="pre">predecessor</span></code> for a given <code class="docutils literal notranslate"><span class="pre">sid</span></code>. With suitable
indexes this has been shown to be fast. We can control the context of
the query by joining to the <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code> model and filtering based on
the <code class="docutils literal notranslate"><span class="pre">state</span></code>.</p>
<p>We will adopt the states as found in the <a class="reference external" href="https://github.com/uktrade/trade-tariff-management/blob/master/app/models/workbaskets/workbasket.rb#L31">existing management
software</a>
because we don’t yet know enough to remove states that we don’t think
are needed.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 47%" />
<col style="width: 53%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>State</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>NEW_IN_PROGRESS</p></td>
<td><p>Newly started, but not yet
submitted into workflow</p></td>
</tr>
<tr class="row-odd"><td><p>EDITING</p></td>
<td><p>Existing item, already on CDS,
being edited but not yet submitted
into workflow</p></td>
</tr>
<tr class="row-even"><td><p>AWAITING_APPROVAL</p></td>
<td><p>Submitted for approval, pending
response from Approver</p></td>
</tr>
<tr class="row-odd"><td><p>APPROVAL_REJECTED</p></td>
<td><p>Was not approved, returned to
submitter</p></td>
</tr>
<tr class="row-even"><td><p>READY_FOR_EXPORT</p></td>
<td><p>Approved but not yet scheduled for
sending to CDS</p></td>
</tr>
<tr class="row-odd"><td><p>AWAITING_CDS_UPLOAD_CREATE_NEW</p></td>
<td><p>New item approved and scheduled
for sending to CDS</p></td>
</tr>
<tr class="row-even"><td><p>AWAITING_CDS_UPLOAD_EDIT</p></td>
<td><p>Edited item approved and scheduled
for sending to CDS, existing
version will be end-dated and
replaced</p></td>
</tr>
<tr class="row-odd"><td><p>AWAITING_CDS_UPLOAD_OVERWRITE</p></td>
<td><p>Edited item approved and scheduled
for sending to CDS, existing
version will be updated</p></td>
</tr>
<tr class="row-even"><td><p>AWAITING_CDS_UPLOAD_DELETE</p></td>
<td><p>Delete instruction approved and
scheduled for sending to CDS</p></td>
</tr>
<tr class="row-odd"><td><p>SENT_TO_CDS</p></td>
<td><p>Sent to CDS, waiting for response</p></td>
</tr>
<tr class="row-even"><td><p>SENT_TO_CDS_DELETE</p></td>
<td><p>Delete instruction sent to CDS,
waiting for response</p></td>
</tr>
<tr class="row-odd"><td><p>PUBLISHED</p></td>
<td><p>On CDS, may or may not have taken
effect</p></td>
</tr>
<tr class="row-even"><td><p>CDS_ERROR</p></td>
<td><p>Sent to CDS, but CDS returned an
error</p></td>
</tr>
</tbody>
</table>
<p>The workbasket contains a <code class="docutils literal notranslate"><span class="pre">transaction_id</span></code> that is set when the state
changes from <code class="docutils literal notranslate"><span class="pre">EDITING</span></code> to <code class="docutils literal notranslate"><span class="pre">AWAITING_APPROVAL</span></code>, and the states
<code class="docutils literal notranslate"><span class="pre">APPROVAL_REJECTED</span></code>, <code class="docutils literal notranslate"><span class="pre">CDS_ERROR</span></code> and <code class="docutils literal notranslate"><span class="pre">PUBLISHED</span></code> are all final.
Sending a workbasket back to the editing stage is done by cloning the
workbasket and its data.</p>
</section>
<section id="consequences">
<h2>Consequences<a class="headerlink" href="#consequences" title="Permalink to this headline">¶</a></h2>
<p>Workbaskets are only given a <code class="docutils literal notranslate"><span class="pre">transaction_id</span></code> when they are approved
and start on their journey to being published. This means transactions
will always have an increasing ID, allowing external users to remember a
single transaction ID to request more data next time.</p>
<p>Transactions on the external interfaces will be immutable and sequential
but discontinuous – there will be some blank transactions representing
transactions that were rejected or errored.</p>
<p>This assumes that HMRC don’t require resubmission of failed transactions
and that CDS will process all of the things we send it in a single
envelope (so that it’s not possible to get transaction 2 in the
<code class="docutils literal notranslate"><span class="pre">PUBLISHED</span></code> state and an earlier transaction 1 in the <code class="docutils literal notranslate"><span class="pre">SENT_TO_CDS</span></code>
state – but CDS <em>can</em> still safely error transactions out of order).</p>
<p>If either of these assumptions is false, we can re-use transaction IDs
internally if required and/or have separate IDs for published
transactions on the external interfaces.</p>
<p>This does mean it will be hard to implement database constraints looking
at a single table because there’s no mechanism in the object table to
detect which row is current, so we will implement these in software.
This is for good reason as there are going to have to be some in
software anyway and it also means that we can run them across different
contexts e.g. the database-live rows + a certain workbasket.</p>
</section>
</section>



          </main>

          <aside>
  <ul class="contribution-banner">
    
    <li><a href="https://github.com/uktrade/tamato/blob/main/docs/adr/0007-changes-go-through-a-stateful-workflow.rst">View source</a></li>
    <li><a href="https://github.com/uktrade/tamato/issues/new?labels=bug&amp;title=Re:%20'adr/0007-changes-go-through-a-stateful-workflow.rst'&amp;body=Problem%20with%20'adr/0007-changes-go-through-a-stateful-workflow.rst'%20(docs/)">Report problem</a></li>
    <li><a href="https://github.com/uktrade/tamato">GitHub Repo</a></li>
    
  </ul>
</aside>
          <footer class="govuk-footer app-footer" role="contentinfo">
<div class="govuk-footer__meta">
  <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">
    <ul class="govuk-footer__inline-list">
      <li class="govuk-footer__inline-list-item">
        <a class="govuk-footer__link" href="../accessibility.html">Accessibility</a>
      </li>
      <li class="govuk-footer__inline-list-item">
        Built with <a class="govuk-footer__link" href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0 using the <a class="govuk-footer__link" href="https://www.github.com/ukgovdatascience/govuk-tech-docs-sphinx-theme">GOV.UK Tech Docs Sphinx Theme</a>.
      </li>
    </ul>
    <svg
      aria-hidden="true"
      focusable="false"
      class="govuk-footer__licence-logo"
      xmlns="http://www.w3.org/2000/svg"
      viewbox="0 0 483.2 195.7"
      height="17"
      width="41"
      >
      <path
        fill="currentColor"
        d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
    </svg>
    <span class="govuk-footer__licence-description">
    All content is available under the
    <a
      class="govuk-footer__link"
      href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
      rel="license"
      >Open Government Licence v3.0</a>, except where otherwise stated
    </span>
  </div>
  <div class="govuk-footer__meta-item">
    <a
      class="govuk-footer__link govuk-footer__copyright-logo"
      href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
  </div>
</div>
</footer>

        </div>
      </div>
    </div>
  </body>
</html>