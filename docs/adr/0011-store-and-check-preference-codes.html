
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>11. Store and check business rules around preference codes &#8212; TaMaTo 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="12. Ordering of tariff transactions" href="0012-ordering-of-tariff-transactions.html" />
    <link rel="prev" title="10. Convert the XML importer to a pipeline" href="0010-convert-the-importer-to-a-pipeline.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="0012-ordering-of-tariff-transactions.html" title="12. Ordering of tariff transactions"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0010-convert-the-importer-to-a-pipeline.html" title="10. Convert the XML importer to a pipeline"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TaMaTo 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../project.html" >Project Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Architectural Decision Records</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">11. Store and check business rules around preference codes</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="store-and-check-business-rules-around-preference-codes">
<span id="store-and-check-preference-codes"></span><h1>11. Store and check business rules around preference codes<a class="headerlink" href="#store-and-check-business-rules-around-preference-codes" title="Permalink to this headline">¶</a></h1>
<p>Date: 2021-02-11</p>
<div class="section" id="status">
<h2>Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p>Proposed</p>
</div>
<div class="section" id="context">
<h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">¶</a></h2>
<p>There are many different mechanisms in the tariff to give traders preferential
access to the market. For example, the same trader might have available to them
a non-preferential (WTO) quota whilst also having access to a preferential rate
from a free trade agreement. The trader also may not wish to use the latter
because of the extra compliance required around rules of origin. In general,
customs systems cannot (and should not) try and apply the “best” tariff.</p>
<p>Traders therefore require some way to specify at the point of declaration what
their preferred treatment is. This is specified using <a class="reference external" href="https://www.gov.uk/government/publications/uk-trade-tariff-imports-and-community-transport-inwards/uk-trade-tariff-imports-and-community-transport-inwards#box-36---preference">Box 36 of the SAD form</a>.
Traders write a 3-digit preference code in box 36 to specify their desired
treatment, and declaration systems apply the treatment if it is available or
return an error if it is not.</p>
<p>Preference codes are not specified as part of the tariff file. Instead, a
separate correlation table is used that maps preference codes to the measure
types that should be applied. For example, specifying preference code “100”
selects measure type 103 for the Erga Omnes third-country duty.</p>
<p>This mechanism has three extra purposes.</p>
<div class="section" id="it-controls-when-additional-duties-get-applied">
<h3>It controls when additional duties get applied<a class="headerlink" href="#it-controls-when-additional-duties-get-applied" title="Permalink to this headline">¶</a></h3>
<p>Any measure type specified against the preference code in the correlation table
is “added on” to the final tariff. So in addition to the third-country duty
(103) specified for preference code “100”, safeguard duties (696),
representative price securities (651) and additional CIF duties (652) are also
present. This means that those additional duties (if present) will also be
charged. This is the means by which safeguard quotas can “switch off” the normal
safeguard duty because the preference code for non-preferential quotas does not
include 696 measures.</p>
</div>
<div class="section" id="it-controls-requirements-around-presence-of-supporting-measures">
<h3>It controls requirements around presence of supporting measures<a class="headerlink" href="#it-controls-requirements-around-presence-of-supporting-measures" title="Permalink to this headline">¶</a></h3>
<p>Some preference codes are only valid when two measure types are found together.
For example, the preference code “323” covers preferential tariff quotas subject
to end-use. There are two ways for this preference code to be activated:</p>
<ul class="simple">
<li><p>by the presence of an end-use preferential quota (146),</p></li>
<li><p>by the presence of a normal preferential quota (143) and a declaration of
subheading submitted to end-use provisions measure (464).</p></li>
</ul>
<p>The presence of these two measure types in the same table represents an “option”
because 143 and 146 both come from the same measure type series which has its
combination field set to zero, so only one can apply.</p>
</div>
<div class="section" id="it-specifies-regulation-groups">
<h3>It specifies regulation groups<a class="headerlink" href="#it-specifies-regulation-groups" title="Permalink to this headline">¶</a></h3>
<p>For each preference code and measure type, the correlation table can specify a
list of regulation groups. The measure generating regulation must then sit in
one of those groups for the preference code to be applicable. For example,
preference code “120” is only applicable when there is a measure with type 122
and regulation group KON. This means that any non-preferential tariff quotas
must always be linked to a regulation in the correct group.</p>
</div>
</div>
<div class="section" id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">¶</a></h2>
<p>Tables of the current preference code correlation data will be stored in TaMaTo
using the following schema:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PreferenceCode</span><span class="p">(</span><span class="n">TrackedModel</span><span class="p">,</span> <span class="n">ValidityMixin</span><span class="p">):</span>
    <span class="n">identifying_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;sid&quot;</span><span class="p">,)</span>

    <span class="n">sid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
      <span class="n">max_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
      <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;The code used in Box 36 of the SAD form.&quot;</span><span class="p">,</span>
      <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">RegexValidator</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[0-9]</span><span class="si">{3}</span><span class="s2">&quot;</span><span class="p">)],</span>
    <span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
      <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;A short description of the policy mechanism</span>
<span class="s2">        the trader will use through the use of this code.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
      <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;A detailed description of the general treatment</span>
<span class="s2">        the trader will receive through the use of this code or more</span>
<span class="s2">        information on the circumstances in which this code applies.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">PreferenceCodeMapping</span><span class="p">(</span><span class="n">TrackedModel</span><span class="p">,</span> <span class="n">ValidityMixin</span><span class="p">):</span>
    <span class="n">identifying_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;sid&quot;</span><span class="p">,)</span>

    <span class="n">sid</span> <span class="o">=</span> <span class="n">SignedIntSID</span><span class="p">()</span>

    <span class="n">preference_code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">PreferenceCode</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;mappings&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">measure_types</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="s2">&quot;measures.MeasureType&quot;</span><span class="p">,</span>
        <span class="n">through</span><span class="o">=</span><span class="s2">&quot;PreferenceCodeMappingMeasureType&quot;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;The measure types required for this mapping to apply.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">regulation_groups</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="s2">&quot;regulations.Group&quot;</span><span class="p">,</span>
        <span class="n">through</span><span class="o">=</span><span class="s2">&quot;PreferenceCodeMappingRegulationGroup&quot;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The regulation groups that the generating regulation of</span>
<span class="s2">        a measure must have for this mapping to apply to that measure.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">condition_codes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="s2">&quot;measures.MeasureConditionCode&quot;</span><span class="p">,</span>
        <span class="n">through</span><span class="o">=</span><span class="s2">&quot;PreferenceCodeMappingConditionCode&quot;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The condition codes that the measure condition must have</span>
<span class="s2">        one of for this mapping to apply to that measure.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">choice_of_types</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BoolField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;True when any of the attached measure types can be</span>
<span class="s2">            present, False when all of the attached measure types must be present.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">PreferenceCodeMappingMeasureType</span><span class="p">(</span><span class="n">TrackedModel</span><span class="p">):</span>
    <span class="n">identifying_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;mapping__id&quot;</span><span class="p">,</span> <span class="s2">&quot;measure_type__sid&quot;</span><span class="p">)</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">PreferenceCodeMapping</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;measure_types&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">measure_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;measures.MeasureType&quot;</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;preference_code_mappings&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">PreferenceCodeMappingRegulationGroup</span><span class="p">(</span><span class="n">TrackedModel</span><span class="p">):</span>
    <span class="n">identifying_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;mapping__id&quot;</span><span class="p">,</span> <span class="s2">&quot;regulation_group__group_id&quot;</span><span class="p">)</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">PreferenceCodeMapping</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;regulation_groups&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">regulation_group</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;regulations.Group&quot;</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;preference_code_mappings&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">PreferenceCodeMappingConditionCode</span><span class="p">(</span><span class="n">TrackedModel</span><span class="p">):</span>
    <span class="n">identifying_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;mapping__id&quot;</span><span class="p">,</span> <span class="s2">&quot;condition_code__code&quot;</span><span class="p">)</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">PreferenceCodeMapping</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;condition_codes&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">condition_code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;measures.MeasureConditionCode&quot;</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;preference_code_mappings&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The following business rules will apply to preference codes:</p>
<ul class="simple">
<li><p>PC1: The validity start date of a preference code cannot be after the validity
end date, if defined.</p></li>
</ul>
<p>The following business rules will apply to preference code mappings:</p>
<ul class="simple">
<li><p>PCM1: The preference code referenced by the preference code mapping must exist.</p></li>
<li><p>PCM2: The validity period of the preference code must span the validity period
of the preference code mapping.</p></li>
<li><p>PCM3: The validity start date of a preference code mapping cannot be after the
validity end date, if defined.</p></li>
<li><p>PCM4: Where a preference code mapping references a measure type, the validity
period of the measure type must span the validity period of the preference
code mapping.</p></li>
<li><p>PCM5: Where a preference code mapping references a regulation group, the
validity period of the regulation group must span the validity period of the
preference code mapping.</p></li>
<li><p>PCM6: Where a preference code mapping references a condition code, the
validity period of the condition code must span the validity period of the
preference code mapping.</p></li>
<li><p>PCM6: If a preference code mapping references a measure type along with a
regulation group, all other preference code mappings (even for other
preference codes) that reference that measure type must also declare a
regulation group.</p></li>
</ul>
<p>The following business rule will apply to measures:</p>
<ul class="simple">
<li><p>ME120: Where a measure’s type is used in any preference code mapping, then at
least one preference code must apply to that measure. This business rule is
only applicable for measures with start date after 2021-02-11.</p></li>
</ul>
<p>A preference code “applies to” a measure if the following are all true:</p>
<ul class="simple">
<li><p>If the preference code has a mapping that mentions the measure’s type.</p></li>
<li><p>If the mapping has a False choice field, there
exist measures for all of the other measure types for the same goods
nomenclature, geographical area, order number, additional code, reduction
indicator for the validity period of the measure.</p></li>
<li><p>If the mapping declares regulation groups, the regulation group of the
measure’s generating regulation must be one of the declared groups.</p></li>
<li><p>If the mapping declares condition codes, the measure must have conditions that
use one of the declared condition codes. If the mapping does not declare any
condition codes then the measure may have any or no conditions.</p></li>
</ul>
</div>
<div class="section" id="consequences">
<h2>Consequences<a class="headerlink" href="#consequences" title="Permalink to this headline">¶</a></h2>
<p>The main motivation for storing preference code tables is to implement ME120.
With this rule, users are prevented from creating measures that traders are
unable to actually declare because there is no valid preference code for them.</p>
<p>The additional motive is that it would allow exposing these tables as
part of citizen-facing services. For the first time it would be possible to
derive what preference codes would be required to use a given measure, if any.
For this reason the human-readable text from the table is also included.</p>
<p>Even though preference codes are not contained in the tariff file and there is
currently no way of communicating desired changes to them, any changes do
need to be tracked and have the usual date-based validity rules apply. This is
because if one day the correlation is changed ME120 will still need to be
able to refer to previous versions of the table for use against old measures. It
is clear from the text version of the correlation table that changes to both the
codes and the mappings are possible independently.</p>
<p>Note that the interaction with condition codes is currently not very interesting
because in the current version of the table there are no measure types with
conditions that do not also have a counterpart without conditions – hence from
an ME120 perspective the conditions make no difference.</p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">11. Store and check business rules around preference codes</a><ul>
<li><a class="reference internal" href="#status">Status</a></li>
<li><a class="reference internal" href="#context">Context</a><ul>
<li><a class="reference internal" href="#it-controls-when-additional-duties-get-applied">It controls when additional duties get applied</a></li>
<li><a class="reference internal" href="#it-controls-requirements-around-presence-of-supporting-measures">It controls requirements around presence of supporting measures</a></li>
<li><a class="reference internal" href="#it-specifies-regulation-groups">It specifies regulation groups</a></li>
</ul>
</li>
<li><a class="reference internal" href="#decision">Decision</a></li>
<li><a class="reference internal" href="#consequences">Consequences</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="0010-convert-the-importer-to-a-pipeline.html"
                        title="previous chapter">10. Convert the XML importer to a pipeline</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="0012-ordering-of-tariff-transactions.html"
                        title="next chapter">12. Ordering of tariff transactions</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/docs/adr/0011-store-and-check-preference-codes.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="0012-ordering-of-tariff-transactions.html" title="12. Ordering of tariff transactions"
             >next</a> |</li>
        <li class="right" >
          <a href="0010-convert-the-importer-to-a-pipeline.html" title="10. Convert the XML importer to a pipeline"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TaMaTo 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../project.html" >Project Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Architectural Decision Records</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">11. Store and check business rules around preference codes</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, DIT.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.1.
    </div>
  </body>
</html>