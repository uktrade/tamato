{% extends "layouts/layout.jinja" %}
{% from "components/breadcrumbs.jinja" import breadcrumbs %}
{% from "components/button/macro.njk" import govukButton %}
{% from "tasks/macros/display_details.jinja" import display_status %}

{% set page_title = "Step: " ~ object.title %}

{% macro display_assignees(assignees) %}
  {% if not assignees %}
    <div class="govuk-!-margin-bottom-3">
      None
    </div>
  {% else %}
    {% for assignee in assignees %}
      <div class="govuk-!-margin-bottom-3">
      {{ assignee.name }}{% if not loop.last %}, {% endif %}
      </div>
    {% endfor %}
  {% endif %}
{% endmacro %}

{% block breadcrumb %}
  {% if ticket_number %}
    {{ breadcrumbs(request, [
        {"text": ticket_number, "href": url('workflow:task-workflow-ui-detail', kwargs={'pk': ticket_number})},
        {"text": page_title}
      ],
      with_workbasket=False,
    ) }}
  {%else %}
    {{ breadcrumbs(request, [
        {"text": page_title}
      ],
      with_workbasket=False,
    )}}
  {% endif %}
{% endblock %}

{% set workbasket_link %}
  {% if object.workbasket %}
    <a
      class="govuk-link"
      href="{{ url('workbaskets:workbasket-ui-detail', kwargs={'pk': object.workbasket.pk}) }}"
    > Review workbasket {{ object.workbasket.pk }})</a>
  {% else %}
    No workbasket set
  {% endif %}
{% endset %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    {{ticket_title}}
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-three-quarters">
        <h1 class="govuk-heading-xl govuk-!-margin-bottom-4">
            {{ page_title }}
        </h1>
      </div>
      <div class="govuk-grid-column-one-quarter">
        {{ govukButton({
        "text": "Delete step",
        "href": url("workflow:task-ui-delete", kwargs={"pk": object.pk}),
        "classes": "govuk-button--warning govuk-!-margin-top-2 delete_step_button"
        }) }}
      </div>
    </div>
  </div>
</div>

{% if ticket_number%}
  <a href="{{ url('workflow:task-workflow-ui-detail', kwargs={'pk': object.taskitem.workflow.pk}) }}" class="govuk-link govuk-back-link govuk-!-margin-bottom-8">Back to ticket</a>
{%endif%}
<h2 class="govuk-heading-m">Details</h2>

<dl class="govuk-summary-list govuk-!-margin-bottom-8">

  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Status
    </dt>
    <dd class="govuk-summary-list__value">
      {{ display_status(object.progress_state.__str__()) }}
    </dd>
    <dd class="govuk-summary-list__actions">
      <a class="govuk-link" href="{{ edit_url }}">Change<span class="govuk-visually-hidden"> status</span></a>
    </dd>
  </div>

  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Assignees
    </dt>
    <dd class="govuk-summary-list__value">
      <div id="assigned-users-content">
        {{ display_assignees(current_assignees) }}
      </div>
    </dd>
    <dd class="govuk-summary-list__actions">
      <ul class="govuk-summary-list__actions-list">
        <li class="govuk-summary-list__actions-list-item">
          <a
            id="assign-users"
            class="govuk-link"
            href="{{ url('workflow:task-ui-assign-users', kwargs={'pk': object.pk}) }}"
          >Assign<span class="govuk-visually-hidden"> users</span></a>
        </li>
        {% if current_assignees %}
        <li class="govuk-summary-list__actions-list-item">
          <a
            id="unassign-users"
            class="govuk-link"
            href="{{ url('workflow:task-ui-unassign-users', kwargs={'pk': object.pk}) }}"
          >Unassign<span class="govuk-visually-hidden"> users</span></a>
        </li>
        {% endif %}
      </ul>
    </dd>
  </div>

  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Created date
    </dt>
    <dd class="govuk-summary-list__value">
      {{ "{:%d %b %Y}".format(object.created_at) }}
    </dd>
    <dd class="govuk-summary-list__actions">
      <!-- Empty for column alignment -->
    </dd>
  </div>

  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Description
    </dt>
    <dd class="govuk-summary-list__value">
      {{ object.description }}
    </dd>
    <dd class="govuk-summary-list__actions">
      <a class="govuk-link" href="{{ edit_url }}">Change<span class="govuk-visually-hidden"> description</span></a>
    </dd>
  </div>
</dl>


<h2 class="govuk-heading-m">Actions</h2>
{{workbasket_link}}



{% set assign_users_link = url("workflow:task-ui-assign-users", kwargs={"pk": object.pk}) %}
{% set unassign_users_link = url("workflow:task-ui-unassign-users", kwargs={"pk": object.pk}) %}

<script nonce="{{ request.csp_nonce }}">
  const CSRF_TOKEN = "{{ csrf_token }}";

  const currentAssignees = {{ current_assignees|safe }};
  const assignableUsers = {{ assignable_users|safe }};

  const assignUsersUrl = "{{ assign_users_link }}";
  const unassignUsersUrl = "{{ unassign_users_link }}";
</script>
{% endblock %}
