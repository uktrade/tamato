<!DOCTYPE html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>14. Simplification of current transaction queries - DIT Tariff Management Tool</title>
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/javascripts/_analytics.js"></script>
    <script src="../_static/javascripts/_govuk/govuk-frontend-3.10.2.min.js"></script>
    <script src="../_static/javascripts/_govuk/modules.js"></script>
    <script src="../_static/javascripts/_modules/anchored-headings.js"></script>
    <script src="../_static/javascripts/_modules/collapsible-navigation.js"></script>
    <script src="../_static/javascripts/_modules/in-page-navigation.js"></script>
    <script src="../_static/javascripts/_modules/navigation.js"></script>
    <script src="../_static/javascripts/_modules/page-expiry.js"></script>
    <script src="../_static/javascripts/_modules/table-of-contents.js"></script>
    <script src="../_static/javascripts/_start_modules.js"></script>
    <script src="../_static/javascripts/_vendor/fixedsticky.js"></script>
    <script src="../_static/javascripts/_vendor/lodash.js"></script>
    <script src="../_static/javascripts/_vendor/modernizer.js"></script>
    <script src="../_static/javascripts/govuk_tech_docs.js"></script>
    <script src="../_static/javascripts/theme.js"></script>
    <link href="../_static/stylesheets/manifest.css" rel="stylesheet" />
    <link href="../_static/stylesheets/theme.css" rel="stylesheet" />
    <link rel="shortcut icon" href="../_static//favicon.ico"/>
  </head>
  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>
        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
          <div class="govuk-header__container govuk-header__container--full-width">

            <div class="govuk-header__logo">
  <a href="../index.html" class="govuk-header__link govuk-header__link--homepage">
    <span class="govuk-header__logotype">
      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-header__logotype-crown"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 132 97"
        height="30"
        width="36"
        >
        <path
          fill="currentColor" fill-rule="evenodd"
          d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
          ></path>
        <image src="../_static/assets/govuk/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
      </svg>
      
      <span class="govuk-header__logotype-text">DIT</span>
    </span>
    <span class="govuk-header__product-name">Tariff Management Tool</span>
  </a><strong class="govuk-tag">Alpha</strong></div>
            <div class="govuk-header__content" role="navigation">
  <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
  <nav>
    <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
      <li class="govuk-header__navigation-item">
        <a class="govuk-header__link" href="https://github.com/uktrade/tamato">GitHub</a>
        </li>
    </ul>
  </nav>
</div>

          </div>
        </header>
      </div>
      <div id="toc-heading" class="toc-show fixedsticky">
        <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
        Table of contents <span class="toc-show__icon"></span>
        </a>
      </div>
      <div class="app-pane__body" data-module="in-page-navigation">

        <div class="app-pane__toc" role="navigation">
  <div class="toc" data-module="table-of-contents">
    <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>

    <div class="search" data-module="search">
  <form action="../search.html" method="get" role="search">
    <label class="govuk-label search__label" for="search">Search</label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
</div>

    <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">

      
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tariff Management Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../envvars.html">Environment variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Architectural Decision Records</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="0001-record-architecture-decisions.html">1. Record architecture decisions</a></li>
<li class="toctree-l2"><a class="reference internal" href="0002-use-pytest-bdd-for-bdd-testing.html">2. Use pytest-bdd for BDD testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="0003-use-django-rest-framework.html">3. Use Django REST Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="0004-xml-export-and-import.html">4. XML Import and Export</a></li>
<li class="toctree-l2"><a class="reference internal" href="0005-use-model-tracking-and-workbaskets.html">5. Use tracked models and workbaskets</a></li>
<li class="toctree-l2"><a class="reference internal" href="0006-use-django-polymorphic.html">6. Use Django Polymorphic for Multi-Table Inheritance</a></li>
<li class="toctree-l2"><a class="reference internal" href="0007-changes-go-through-a-stateful-workflow.html">7. Changes go through a stateful workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="0008-simplify-workflow-states.html">8. Simplify workflow states</a></li>
<li class="toctree-l2"><a class="reference internal" href="0009-record-generated-envelopes.html">9. Generate envelope files</a></li>
<li class="toctree-l2"><a class="reference internal" href="0010-convert-the-importer-to-a-pipeline.html">10. Convert the XML importer to a pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="0011-store-and-check-preference-codes.html">11. Store and check business rules around preference codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="0012-ordering-of-tariff-transactions.html">12. Ordering of tariff transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="0013-import-taric-nomenclature-updates.html">13. Import TARIC nomenclature updates</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">14. Simplification of current transaction queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="#alternatives-considered">Alternatives considered</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#thread-local-storage">Thread-local storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#temporal-database-extension">Temporal database extension</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="#consequences">Consequences</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="0015-make-reverse-relations-aware-of-versions.html">15. Make reverse relations aware of versions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../business_rules/index.html">Business Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../taric/index.html">TARIC3 Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../importer/index.html">The Importer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exporter/index.html">The Exporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CODE_OF_CONDUCT.html">Contributor Covenant Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

      <hr size="1">

      
      <h1>On this page</h1>
      <ul>
<li><a class="reference internal" href="#">14. Simplification of current transaction queries</a><ul>
<li><a class="reference internal" href="#status">Status</a></li>
<li><a class="reference internal" href="#context">Context</a></li>
<li><a class="reference internal" href="#alternatives-considered">Alternatives considered</a><ul>
<li><a class="reference internal" href="#thread-local-storage">Thread-local storage</a></li>
<li><a class="reference internal" href="#temporal-database-extension">Temporal database extension</a></li>
</ul>
</li>
<li><a class="reference internal" href="#decision">Decision</a></li>
<li><a class="reference internal" href="#consequences">Consequences</a></li>
</ul>
</li>
</ul>


    </nav>
  </div>
</div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings" role="main">

            
  <section id="simplification-of-current-transaction-queries">
<h1>14. Simplification of current transaction queries<a class="headerlink" href="#simplification-of-current-transaction-queries" title="Permalink to this headline">¶</a></h1>
<p>Date: 2021-09-27</p>
<section id="status">
<h2>Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p>Approved</p>
</section>
<section id="context">
<h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">¶</a></h2>
<p>The TaMaTo application keeps a version history of the UK tariff, with each
version of a record having a version ID and an associated transaction ID.
TaMaTo enables users to create draft edits to the tariff, and these are
stored in the database as unpublished versions.</p>
<p>When querying the database, either to display the current UK tariff details, or
to check business rules are not violated, those queries must specify the
“current” transaction to fetch only the versions of records that are pertinent.
This is further complicated by the need to fetch unpublished versions when
querying data that has been modified in the user’s current session.</p>
<p>This complication affects several aspects of the application:</p>
<ol class="arabic simple">
<li><p>Data entry. When users enter data into forms, the options they are presented
with are retrieved from the database. These options must be only those that
are valid at the time of the request, and must not include any historical
versions.</p></li>
<li><p>Business rules. The current workbasket contains versions of database records
which are not yet considered fact, but must be included in business rule
queries to check that when they are published in the tariff they will not
violate those rules.</p></li>
</ol>
</section>
<section id="alternatives-considered">
<h2>Alternatives considered<a class="headerlink" href="#alternatives-considered" title="Permalink to this headline">¶</a></h2>
<section id="thread-local-storage">
<h3>Thread-local storage<a class="headerlink" href="#thread-local-storage" title="Permalink to this headline">¶</a></h3>
<p>We store the current transaction in thread-local storage as a sort of global variable
that provides the context to all queries in the current thread - this avoids
interference with other concurrent requests to the application. <a class="reference external" href="https://django-crum.readthedocs.io/en/latest/">Django-CRUM</a> provides an
API to managing thread-local storage.</p>
<p>Some Django form fields (eg <code class="docutils literal notranslate"><span class="pre">ModelChoiceField</span></code>) take a queryset as an initialisation
argument and execute the query at render-time. In this case, we want to construct a
queryset that retrieves the current transaction at execution time and not at
initialisation. To ensure we fetch the current transaction ID value at query execution
time, we can use a dynamic <a class="reference external" href="https://docs.djangoproject.com/en/dev/ref/models/expressions/#value-expressions"><code class="docutils literal notranslate"><span class="pre">Value</span></code></a> object, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">crum</span> <span class="kn">import</span> <span class="n">get_current_request</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">IntegerField</span><span class="p">,</span> <span class="n">Value</span>

<span class="kn">from</span> <span class="nn">workbaskets.models</span> <span class="kn">import</span> <span class="n">WorkBasket</span>


<span class="k">class</span> <span class="nc">CurrentTransactionId</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;output_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
        <span class="c1"># skip Value constructor which assigns to self.value</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">get_current_request</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">:</span>
            <span class="n">transaction</span> <span class="o">=</span> <span class="n">WorkBasket</span><span class="o">.</span><span class="n">get_current_transaction</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">transaction</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">transaction</span><span class="o">.</span><span class="n">id</span>

        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>This allows us to construct a queryset that fetches the current transaction at query
execution time:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Footnotes</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">transaction_id</span><span class="o">=</span><span class="n">CurrentTransactionId</span><span class="p">())</span>
</pre></div>
</div>
<p>Using these dynamic <code class="docutils literal notranslate"><span class="pre">Value</span></code> objects, we can refactor <code class="docutils literal notranslate"><span class="pre">latest_approved</span></code> and
<code class="docutils literal notranslate"><span class="pre">approved_up_to_transaction</span></code> as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">latest_approved</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">transaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Transaction</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrackedModelQuerySet</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the approved versions of the model, or the latest draft versions if they</span>
<span class="sd">    exist within a transaction preceding (and including) the given transaction in</span>
<span class="sd">    the workbasket of the given transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">transaction</span><span class="p">:</span>
        <span class="n">current_workbasket_id</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">workbasket</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">output_field</span><span class="o">=</span><span class="n">IntegerField</span><span class="p">())</span>
        <span class="n">transaction_order</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">order</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># dynamic values defined similarly to CurrentTransactionId above</span>
        <span class="n">current_workbasket_id</span> <span class="o">=</span> <span class="n">CurrentWorkBasketId</span><span class="p">()</span>
        <span class="n">transaction_order</span> <span class="o">=</span> <span class="n">CurrentTransactionOrder</span><span class="p">()</span>

    <span class="n">is_current_version</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">is_current__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">in_current_workbasket</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
        <span class="n">transaction__workbasket_id</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;current_workbasket_id&quot;</span><span class="p">),</span>
        <span class="n">transaction__order__lte</span><span class="o">=</span><span class="n">transaction_order</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">versions_in_workbasket</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span>
        <span class="n">version_group__versions__transaction__workbasket_id</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;current_workbasket_id&quot;</span><span class="p">),</span>
        <span class="n">version_group__versions__transaction__order__lte</span><span class="o">=</span><span class="n">transaction_order</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">latest_version_id</span> <span class="o">=</span> <span class="n">Max</span><span class="p">(</span>
        <span class="s2">&quot;version_group__versions&quot;</span><span class="p">,</span>
        <span class="nb">filter</span><span class="o">=</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">current_workbasket_id__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">versions_in_workbasket</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">unapproved_if_no_workbasket</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">current_workbasket_id__isnull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_current__isnull</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">older_versions_in_workbasket</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">current_workbasket_id__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">latest</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>

    <span class="n">deletions</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">update_type</span><span class="o">=</span><span class="n">UpdateType</span><span class="o">.</span><span class="n">DELETE</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">current_workbasket_id</span><span class="o">=</span><span class="n">current_workbasket_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_current_version</span> <span class="o">|</span> <span class="n">in_current_workbasket</span><span class="p">)</span>
        <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">latest</span><span class="o">=</span><span class="n">latest_version_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">unapproved_if_no_workbasket</span><span class="p">)</span>
        <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">older_versions_in_workbasket</span><span class="p">)</span>
        <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">deletions</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>This allows initialising (for example) a <code class="docutils literal notranslate"><span class="pre">ModelChoiceField</span></code> with a queryset that uses the current
transaction at form render time:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">measure_type</span> <span class="o">=</span> <span class="n">ModelChoiceField</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">MeasureType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">latest_approved</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="temporal-database-extension">
<h3>Temporal database extension<a class="headerlink" href="#temporal-database-extension" title="Permalink to this headline">¶</a></h3>
<p>We extend the Postgres database with a temporal tables extension, which handles the
versioning of data so that we do not have to do it in our code. Compiled extensions may
not be permitted to install on our hosted database servers, so <a class="reference external" href="https://github.com/nearform/temporal_tables">nearform/temporal_tables</a>
could be used instead as it is implemented in PL/SQL.</p>
<p>This approach, while moving a lot of complexity in queries out of the
application and into the database extension, would still require keeping track
of the current transaction in the application, possibly using the thread-local
storage solution above.</p>
</section>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">¶</a></h2>
<p>For the purposes of making our Django ORM queries simpler, we will make use of
<a class="reference external" href="https://django-crum.readthedocs.io/en/latest/">Django-CRUM</a> and thread-local storage to automate fetching the current
transaction from the request (if it exists) and filtering querysets using it.</p>
</section>
<section id="consequences">
<h2>Consequences<a class="headerlink" href="#consequences" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Easier to read and invoke queries that must filter by the current transaction</p></li>
<li><p>An added dependency to maintain</p></li>
<li><p>Slightly “magical” code may make maintenance more difficult</p></li>
</ul>
</section>
</section>



          </main>

          <aside>
  <ul class="contribution-banner">
    
    <li><a href="https://github.com/uktrade/tamato/blob/main/docs/adr/0014-simplify-current-transaction-queries.rst">View source</a></li>
    <li><a href="https://github.com/uktrade/tamato/issues/new?labels=bug&amp;title=Re:%20'adr/0014-simplify-current-transaction-queries.rst'&amp;body=Problem%20with%20'adr/0014-simplify-current-transaction-queries.rst'%20(docs/)">Report problem</a></li>
    <li><a href="https://github.com/uktrade/tamato">GitHub Repo</a></li>
    
  </ul>
</aside>
          <footer class="govuk-footer app-footer" role="contentinfo">
<div class="govuk-footer__meta">
  <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">
    <ul class="govuk-footer__inline-list">
      <li class="govuk-footer__inline-list-item">
        <a class="govuk-footer__link" href="../accessibility.html">Accessibility</a>
      </li>
      <li class="govuk-footer__inline-list-item">
        Built with <a class="govuk-footer__link" href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0 using the <a class="govuk-footer__link" href="https://www.github.com/ukgovdatascience/govuk-tech-docs-sphinx-theme">GOV.UK Tech Docs Sphinx Theme</a>.
      </li>
    </ul>
    <svg
      aria-hidden="true"
      focusable="false"
      class="govuk-footer__licence-logo"
      xmlns="http://www.w3.org/2000/svg"
      viewbox="0 0 483.2 195.7"
      height="17"
      width="41"
      >
      <path
        fill="currentColor"
        d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
    </svg>
    <span class="govuk-footer__licence-description">
    All content is available under the
    <a
      class="govuk-footer__link"
      href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
      rel="license"
      >Open Government Licence v3.0</a>, except where otherwise stated
    </span>
  </div>
  <div class="govuk-footer__meta-item">
    <a
      class="govuk-footer__link govuk-footer__copyright-logo"
      href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
  </div>
</div>
</footer>

        </div>
      </div>
    </div>
  </body>
</html>