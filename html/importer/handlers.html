<!DOCTYPE html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Handlers - DIT Tariff Management Tool</title>
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/javascripts/_analytics.js"></script>
    <script src="../_static/javascripts/_govuk/govuk-frontend-3.10.2.min.js"></script>
    <script src="../_static/javascripts/_govuk/modules.js"></script>
    <script src="../_static/javascripts/_modules/anchored-headings.js"></script>
    <script src="../_static/javascripts/_modules/collapsible-navigation.js"></script>
    <script src="../_static/javascripts/_modules/in-page-navigation.js"></script>
    <script src="../_static/javascripts/_modules/navigation.js"></script>
    <script src="../_static/javascripts/_modules/page-expiry.js"></script>
    <script src="../_static/javascripts/_modules/table-of-contents.js"></script>
    <script src="../_static/javascripts/_start_modules.js"></script>
    <script src="../_static/javascripts/_vendor/fixedsticky.js"></script>
    <script src="../_static/javascripts/_vendor/lodash.js"></script>
    <script src="../_static/javascripts/_vendor/modernizer.js"></script>
    <script src="../_static/javascripts/govuk_tech_docs.js"></script>
    <script src="../_static/javascripts/theme.js"></script>
    <link href="../_static/stylesheets/manifest.css" rel="stylesheet" />
    <link href="../_static/stylesheets/theme.css" rel="stylesheet" />
    <link rel="shortcut icon" href="../_static//favicon.ico"/>
  </head>
  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>
        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
          <div class="govuk-header__container govuk-header__container--full-width">

            <div class="govuk-header__logo">
  <a href="../index.html" class="govuk-header__link govuk-header__link--homepage">
    <span class="govuk-header__logotype">
      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-header__logotype-crown"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 132 97"
        height="30"
        width="36"
        >
        <path
          fill="currentColor" fill-rule="evenodd"
          d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
          ></path>
        <image src="../_static/assets/govuk/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
      </svg>
      
      <span class="govuk-header__logotype-text">DIT</span>
    </span>
    <span class="govuk-header__product-name">Tariff Management Tool</span>
  </a><strong class="govuk-tag">Alpha</strong></div>
            <div class="govuk-header__content" role="navigation">
  <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
  <nav>
    <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
      <li class="govuk-header__navigation-item">
        <a class="govuk-header__link" href="https://github.com/uktrade/tamato">GitHub</a>
        </li>
    </ul>
  </nav>
</div>

          </div>
        </header>
      </div>
      <div id="toc-heading" class="toc-show fixedsticky">
        <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
        Table of contents <span class="toc-show__icon"></span>
        </a>
      </div>
      <div class="app-pane__body" data-module="in-page-navigation">

        <div class="app-pane__toc" role="navigation">
  <div class="toc" data-module="table-of-contents">
    <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>

    <div class="search" data-module="search">
  <form action="../search.html" method="get" role="search">
    <label class="govuk-label search__label" for="search">Search</label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
</div>

    <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">

      
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tariff Management Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../envvars.html">Environment variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adr/index.html">Architectural Decision Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="../business_rules/index.html">Business Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../taric/index.html">TARIC3 Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">The Importer</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="nursery.html">The Nursery</a></li>
<li class="toctree-l2"><a class="reference internal" href="parsers_and_namespaces.html">Parsers and Namespaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="taric.html">Taric</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../exporter/index.html">The Exporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/gherkin.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CODE_OF_CONDUCT.html">Contributor Covenant Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

      <hr size="1">

      
      <h1>On this page</h1>
      <ul>
<li><a class="reference internal" href="#">Handlers</a></li>
</ul>


    </nav>
  </div>
</div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings" role="main">

            
  <section id="module-importer.handlers">
<span id="handlers"></span><h1>Handlers<a class="headerlink" href="#module-importer.handlers" title="Permalink to this headline">¶</a></h1>
<dl class="py class">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">importer.handlers.</span></span><span class="sig-name descname"><span class="pre">BaseHandler</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dispatched_object</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">importer.utils.DispatchedObjectType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nursery</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><a class="reference internal" href="nursery.html#importer.nursery.TariffObjectNursery" title="importer.nursery.TariffObjectNursery"><span class="pre">importer.nursery.TariffObjectNursery</span></a></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler" title="Permalink to this definition">¶</a></dt>
<dd><p>The Base class for import handlers.</p>
<p>Handlers are designed to build objects which are then ready to be entered into the database.
This effectively takes place in 8 stages:</p>
<p>Init:</p>
<ol class="arabic simple">
<li><p>The handler is initialised with the initial data.</p></li>
</ol>
<p>Build:</p>
<ol class="arabic simple" start="2">
<li><p>The handler checks for dependencies and links. If there are none it goes to step 5.</p></li>
<li><p>The handler searches for dependencies which may contain extra required data. If any can’t be found it
asks to be cached and resolved later, the process stops. If they are found it unifies the data.</p></li>
<li><p>The handler searches for any links (foreign keys) that it needs. If any can’t be found it asks to be
cached and resolved later, the process stops. If they are found it stores them.</p></li>
</ol>
<p>Dispatch:</p>
<ol class="arabic simple" start="5">
<li><p>The handler validates the complete data against the serializer.</p></li>
<li><p>The handler runs any pre-save processing, including adding the foreign keys to the validated data.</p></li>
<li><p>The handler saves the object to the database.</p></li>
<li><p>The handler runs any post-save processing.</p></li>
</ol>
<p>Many models are likely to have some specific requirements and so customisation is a focus within this system.
But many use cases should also be workable with just the base.
Most steps within this process can be customised and overridden - every model is likely to have some
specific custom demands.</p>
<p>A few examples of different scenarios follow below.</p>
<p><strong>Example 1</strong></p>
<p>Simple object, no dependencies or links.</p>
<p>For very simple objects there should be almost no work to do, assuming the data comes in clean without
any need for editing. In this case it should be enough to simply define a handler like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleObjectHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SimpleObjectSerializer</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">SimpleObjectParser</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>Any object like this would be immediately processed when run through the nursery as, without any dependencies
or links, there should be nothing it needs to wait on.</p>
<p><strong>Example 2</strong></p>
<p>An object with dependencies:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DependentModelAHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DependentModelSerializer</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">DependentModelAParser</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span>


<span class="nd">@DependentModelAHandler</span><span class="o">.</span><span class="n">register_dependant</span>
<span class="k">class</span> <span class="nc">DependentModelBHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">DependentModelAHandler</span><span class="p">]</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DependentModelSerializer</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">DependentModelBParser</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>Dependencies in this case means two pre-existing models have been merged into one. Sadly the data import
doesn’t account for this and therefore it is expected to receive the complete set of data for this object
over several records. A handler must therefore be created for each expected record type. All records will
then be stored in the nursery cache until they can be collected together for processing.</p>
<p>As dependencies are supposed to all relate to the same model, they must all share the same serializer.</p>
<p>Dependencies cascade. Consequentially if object A depends on object B, but object B depends on object C,
then object A will also depend on object C. However, given the nature of the dependencies, it is more
desirable to have all handlers be explicit about all dependencies they may rely on.</p>
<p>Dependencies are assigned at class level. Due to the way compilation works this creates issues with
forward-referencing. To handle this there are two mechanisms for registering dependencies. The first
is simply a class level dependency list with the dependent classes within them. The latter is with a
decorator which allows a class to decorate itself - therefore inserting itself into the aforementioned
dependency list of a pre-existing class.</p>
<p>With this defined the nursery will collect the data for each dependency. The dependencies can then query
the nursery to collect all the data. If all the data is found the object is dispatched to the database
and the nursery removes the relevant data from the cache.</p>
<p><strong>Example 3</strong></p>
<p>An object with Foreign Key links.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LinkedObjectHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="n">links</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">LinkToModelA</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;link_to_model_a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">LinkToModelB</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;link_to_model_b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;identifying_fields&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;some_field&quot;</span><span class="p">,</span> <span class="s2">&quot;some_other_model_id&quot;</span><span class="p">)</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_link_to_model_b_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">other_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SomeOtherModel</span><span class="p">(</span><span class="n">field2</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">some_other_model_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_latest_version</span><span class="p">(</span><span class="n">other_model</span><span class="o">=</span><span class="n">other_model</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
</pre></div>
</div>
<p>Foreign key links are more flexible than dependencies. Whilst dependencies denote records which hold
part of the data for an object, links denote pre-existing objects which the current object needs to link
to. The difficulty here is there is no guarantee that the pre-existing object has actually been created
yet, nor that the object necessarily _needs_ to exist (the foreign key could be nullable).</p>
<p>Therefore Handlers have the option of adding a <cite>links</cite> attribute, which should be an iterable of <cite>LinksType</cite>
style dictionaries. This must define two keys:</p>
<ol class="arabic simple">
<li><p>model - which is expected to be a <cite>TrackedModel</cite> instance</p></li>
<li><p>name - a string, which is how the link data will be differentiated from the object data, as well as
how it will be named in the data when saved to the database. More specifically incoming data for the
linked field (specifically the models identifying fields) is expected to be prefixed with this name.
So the parser must define fields with this prefix.</p></li>
</ol>
<p>Two other optional keys exist:</p>
<ol class="arabic simple" start="3">
<li><p>optional - defines whether a link is optional. If it is optional the object will be saved even if the
link can’t be found. If it is not optional then the object will be cached until the link can be found.</p></li>
<li><p>identifying_fields - On occasion the identifying fields from model.identifying_fields may not be
appropriate, in this case they can be overridden here.</p></li>
</ol>
<p>With just these the Handler will automatically try to fetch the linked model with the identifying fields of
the model (or those given in the link dictionary). Once fetched it will store the data with the given name.
Once ready to save the links will be added to the object data with the given name and the object will be saved.</p>
<p>In some cases this is not enough and further customisation is needed when fetching links. An example is a link
where one of the identifying fields is a foreign key on that linked field (i.e. the linked field itself has
another link). To allow for this a method can be added to fetch the link appropriately. This method must be named
<cite>get_{link_name}_link</cite> and accept the arguments <cite>model</cite> and <cite>kwargs</cite>. This must then return whatever object is
intended to go into the data with the same name as that given to the link.</p>
<p>All of the above examples can be used together, e.g. a handler can have both dependencies and links.</p>
<dl class="py method">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler.build">
<span class="sig-name descname"><span class="pre">build</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Set</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span></span></span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler.build"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler.build" title="Permalink to this definition">¶</a></dt>
<dd><p>Build up all the data for the object.</p>
<p>This method co-ordinates the attempts to fetch the dependent data as well as the linked
data. If at any point one of these steps fails an empty set returns (signifying failure).</p>
<p>if all steps are deemed successful the object is dispatched to the database automatically.
On success a set of all the keys for any objects used which may be in the cache is returned.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler.clean">
<span class="sig-name descname"><span class="pre">clean</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">dict</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">dict</span></span></span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler.clean"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler.clean" title="Permalink to this definition">¶</a></dt>
<dd><p>Validate the data against the serializer and return the validated
data.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler.dispatch">
<span class="sig-name descname"><span class="pre">dispatch</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="../api/common/common.models.html#common.models.TrackedModel" title="common.models.trackedmodel.TrackedModel"><span class="pre">common.models.trackedmodel.TrackedModel</span></a></span></span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler.dispatch"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler.dispatch" title="Permalink to this definition">¶</a></dt>
<dd><p>Save the data into the database.</p>
<p>This method initially validates all collected data. If valid it then
runs some pre-processing before saving. Once saved an opportunity is
given for post-processing.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler.get_generic_link">
<span class="sig-name descname"><span class="pre">get_generic_link</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler.get_generic_link"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler.get_generic_link" title="Permalink to this definition">¶</a></dt>
<dd><p>Fallback method if no specific method is found for fetching a link.</p>
<p>Raises DoesNotExist if no kwargs passed.</p>
<p>First attempts to retrieve the object PK from the cache (saves queries). If this
is not found a database query is made to find the object.</p>
<p>returns tuple(Object: model, bool: From Cache)</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler.load_link">
<span class="sig-name descname"><span class="pre">load_link</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">identifying_fields</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">optional</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler.load_link"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler.load_link" title="Permalink to this definition">¶</a></dt>
<dd><p>Load a given link for a handler.</p>
<p>This method first attempts to find any custom method existing on the handler
for finding the specific link. The custom method must be named:</p>
<blockquote>
<div><p>get_{LINK_NAME}_link</p>
</div></blockquote>
<p>If no custom method is found then <a class="reference internal" href="#importer.handlers.BaseHandler.get_generic_link" title="importer.handlers.BaseHandler.get_generic_link"><code class="xref py py-meth docutils literal notranslate"><span class="pre">BaseHandler.get_generic_link()</span></code></a> is used.</p>
<p>If no object matching the given link is found and the link is non-optional then a
DoesNotExist error is raised.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler.post_save">
<span class="sig-name descname"><span class="pre">post_save</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">obj</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler.post_save"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler.post_save" title="Permalink to this definition">¶</a></dt>
<dd><p>Post-processing after the object has been saved to the database.</p>
<p>By default this caches any new saved object.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler.pre_save">
<span class="sig-name descname"><span class="pre">pre_save</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">links</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">dict</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">dict</span></span></span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler.pre_save"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler.pre_save" title="Permalink to this definition">¶</a></dt>
<dd><p>Pre-processing before the object is saved to the database.</p>
<p>Generally this is used for adding the links to the object (as these cannot
be easily validated against the serializer).</p>
<p>Return the final dataset to be used when saving to the database.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler.register_dependant">
<em class="property"><span class="pre">classmethod</span> </em><span class="sig-name descname"><span class="pre">register_dependant</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dependant</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">Type</span><span class="p"><span class="pre">[</span></span><a class="reference internal" href="#importer.handlers.BaseHandler" title="importer.handlers.BaseHandler"><span class="pre">importer.handlers.BaseHandler</span></a><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler.register_dependant"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler.register_dependant" title="Permalink to this definition">¶</a></dt>
<dd><p>Allow a handler to retrospectively assign itself to another handlers
list of dependencies.</p>
<p>This solves the issue of forward referencing - where a class cannot reference another class
before that class has been defined.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler.resolve_dependencies">
<span class="sig-name descname"><span class="pre">resolve_dependencies</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bool</span></span></span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler.resolve_dependencies"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler.resolve_dependencies" title="Permalink to this definition">¶</a></dt>
<dd><p>Search the cache for all object dependencies and attempt to resolve
them.</p>
<p>Previously found objects, which are dependent on the current object, should be
stored in the cache. This method loops over the current objects dependencies and
attempts to extract them from the cache. It then also searches for the dependencies
of the extracted objects.</p>
<p>All found dependencies are then merged into the current objects data. If at any point
a dependency is not found the method returns False - to signify the object cannot be resolved.
If all dependencies are found the method returns True.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler.resolve_links">
<span class="sig-name descname"><span class="pre">resolve_links</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bool</span></span></span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler.resolve_links"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler.resolve_links" title="Permalink to this definition">¶</a></dt>
<dd><p>Extract data specific to links and use this to search the database for
the relevant objects.</p>
<p>Once found attach the object to the <cite>resolved_links</cite> dictionary.</p>
<p>If a non-optional object can’t be found return False. This signifies the links cannot be resolved.
If all non-optional objects are found then return True.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="importer.handlers.BaseHandler.serialize">
<span class="sig-name descname"><span class="pre">serialize</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">importer.utils.DispatchedObjectType</span></span></span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandler.serialize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandler.serialize" title="Permalink to this definition">¶</a></dt>
<dd><p>Provides a serializable dict of the object to be stored in the cache.</p>
<p>Should hold all the necessary data required to rebuild the object</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="importer.handlers.BaseHandlerMeta">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">importer.handlers.</span></span><span class="sig-name descname"><span class="pre">BaseHandlerMeta</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bases</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">tuple</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dct</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">dict</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/importer/handlers.html#BaseHandlerMeta"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.BaseHandlerMeta" title="Permalink to this definition">¶</a></dt>
<dd><p>BaseHandler Metaclass to add validation and registration of each new Handler
class.</p>
<p>Handlers have relatively strict requirements for them to function.</p>
<p>Firstly there are two required attributes:</p>
<ol class="arabic simple">
<li><p>“tag” - a string which is what matches the handler against the incoming data.</p></li>
<li><p>“serializer_class” - a ModelSerializer which is used to validate and create the database object.</p></li>
</ol>
<p>Without these attributes the class cannot function properly. To ensure these are defined the metaclass
checks for their existence and type. If they aren’t properly defined then an error is raised at compile
time (i.e. on import).</p>
<p>The second requirement is that handlers need to be attached to the nursery. This is so that the nursery
can match them against the incoming data. To accommodate this all handlers are automatically registered
with the nursery class once validated. This reduces boilerplate code.</p>
</dd></dl>

<dl class="py exception">
<dt class="sig sig-object py" id="importer.handlers.MismatchedSerializerError">
<em class="property"><span class="pre">exception</span> </em><span class="sig-prename descclassname"><span class="pre">importer.handlers.</span></span><span class="sig-name descname"><span class="pre">MismatchedSerializerError</span></span><a class="reference internal" href="../_modules/importer/handlers.html#MismatchedSerializerError"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#importer.handlers.MismatchedSerializerError" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</section>



          </main>

          <aside>
  <ul class="contribution-banner">
    
    <li><a href="https://github.com/uktrade/tamato/blob/main/docs/importer/handlers.rst">View source</a></li>
    <li><a href="https://github.com/uktrade/tamato/issues/new?labels=bug&amp;title=Re:%20'importer/handlers.rst'&amp;body=Problem%20with%20'importer/handlers.rst'%20(docs/)">Report problem</a></li>
    <li><a href="https://github.com/uktrade/tamato">GitHub Repo</a></li>
    
  </ul>
</aside>
          <footer class="govuk-footer app-footer" role="contentinfo">
<div class="govuk-footer__meta">
  <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">
    <ul class="govuk-footer__inline-list">
      <li class="govuk-footer__inline-list-item">
        <a class="govuk-footer__link" href="../accessibility.html">Accessibility</a>
      </li>
      <li class="govuk-footer__inline-list-item">
        Built with <a class="govuk-footer__link" href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0 using the <a class="govuk-footer__link" href="https://www.github.com/ukgovdatascience/govuk-tech-docs-sphinx-theme">GOV.UK Tech Docs Sphinx Theme</a>.
      </li>
    </ul>
    <svg
      aria-hidden="true"
      focusable="false"
      class="govuk-footer__licence-logo"
      xmlns="http://www.w3.org/2000/svg"
      viewbox="0 0 483.2 195.7"
      height="17"
      width="41"
      >
      <path
        fill="currentColor"
        d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
    </svg>
    <span class="govuk-footer__licence-description">
    All content is available under the
    <a
      class="govuk-footer__link"
      href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
      rel="license"
      >Open Government Licence v3.0</a>, except where otherwise stated
    </span>
  </div>
  <div class="govuk-footer__meta-item">
    <a
      class="govuk-footer__link govuk-footer__copyright-logo"
      href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
  </div>
</div>
</footer>

        </div>
      </div>
    </div>
  </body>
</html>