{% from "components/button/macro.njk" import govukButton %}
{% from "components/input/macro.njk" import govukInput %}
{% from "components/table/macro.njk" import govukTable %}

{%- set table_rows = [] -%}

{% for obj in object_list %}

  {# TODO: move into view function / context. #}
  {%- set up_down_cell_content %}
    {% if loop.index != 1 %}
      <button
        class="govuk-link fake-link"
        name="promote_position"
        value="{{ obj.pk }}"
      >
        <img
          class="icon icon-up"
          src="{{ static('/common/images/chevron-up.svg') }}"
          alt="Chevron up"
        >
      </button>
    {% endif %}
    <br>
    {% if loop.index != object_list | length %}
      <button
        class="govuk-link fake-link"
        name="demote_position"
        value="{{ obj.pk }}"
      >
        <img
          class="icon icon-down"
          src="{{ static('/common/images/chevron-down.svg') }}"
          alt="Chevron down"
        >
      </button>
    {% endif %}
  {% endset -%}


  {%- set workbasket_id_cell_content %}
    <a
      href="{{ url('workbaskets:workbasket-ui-changes', args=(obj.workbasket.pk,)) }}"
      class="govuk-link"
    >{{ obj.workbasket.pk }}</a>
  {% endset -%}


  {%- set jira_cell_content %}
    <a
      href="{{ obj.jira_url }}"
      class="govuk-link"
    >{{ obj.workbasket.title }}</a>
  {% endset -%}


  {# TODO: move into view function / context. #}
  {%- set order_cell_content %}
    {# TODO: move into view function / context. #}
    {% if obj.processing_state == "CURRENTLY_PROCESSING" %}
      <span class="tamato-badge-light-purple">CDS DOWNLOADED</span>
    {% elif obj.processing_state == "AWAITING_PROCESSING" and obj.position == 1 %}
      {# TODO: check notification status of instance. #}
      <span class="tamato-badge-light-green">CDS NOTIFIED</span>
    {% elif obj.position == 2 %}
      {# TODO: Correctly implement conditional move down. #}
      <a href="#"></a>
      <button
        class="govuk-link fake-link"
        name="demote_position"
        value="{{ obj.pk }}"
      >
        Move down
      </button>
    {% else %}
      <button
        class="govuk-link fake-link"
        name="promote_to_top_position"
        value="{{ obj.pk }}"
      >
        Move to top to notify CDS
      </button>
    {% endif %}
  {% endset -%}


  {%- set remove_cell_content %}
    {# TODO: move into view function / context. #}
    {% if obj.processing_state != "CURRENTLY_PROCESSING" %}
      <button
        class="govuk-link fake-link"
        name="remove_from_queue"
        value="{{ obj.pk }}"
      >
        Remove from queue
      </button>
    {% endif %}
  {% endset -%}


  {{ table_rows.append([
    {"html": up_down_cell_content},
    {"html": workbasket_id_cell_content},
    {"html": jira_cell_content},
    {"html": "<span>" ~ obj.workbasket.reason ~ "</span>"},
    {"html": order_cell_content},
    {"html": remove_cell_content},
  ]) or "" }}

{% endfor %}

<form method="post" action="">
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  {{ govukTable({
    "head": [
      {"text": ""},
      {"text": "Workbasket ID"},
      {"text": "TOPS/Jira"},
      {"text": "Description"},
      {"text": "Order"},
      {"text": "Remove"},
    ],
    "rows": table_rows,
    "classes": "packaged-workbaskets first-row-highlight",
  }) }}
</form>
