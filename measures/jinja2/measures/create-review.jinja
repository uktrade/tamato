{% extends "measures/create-wizard-step.jinja" %}

{% from "components/summary-list/macro.njk" import govukSummaryList %}

{% set page_title = step_metadata[wizard.steps.current].title %}

{% macro review_step(step) %}
  <h2 class="govuk-heading-m">{{ step_metadata[step].link_text }}</h2>
  {% set rows = [] %}
  {% set data = view.get_cleaned_data_for_step(step) %}
  {% set ignore %}
  {{ caller(rows, data) }}
  {% endset %}
  {% set row_data = [] %}
  {% for label, value in rows %}
    {{ row_data.append({
      "key": {"text": label},
      "value": {"text": value},
      "actions": {
        "items": [
          {
            "text": "Change",
            "visuallyHiddenText": label|lower,
            "href": view.get_step_url(step),
            "attributes": {}
          }
        ]
      }
    }) or "" }}
  {% endfor %}
  {{ govukSummaryList({"rows": row_data, "classes": "govuk-!-margin-bottom-9"}) }}
{% endmacro %}

{% block form %}
  {% call(rows, data) review_step("measure_details") %}
    {{ rows.extend([
      ("Measure type", data["measure_type"] ~ " - " ~ data["measure_type"].description),
      ("Regulation ID", data["generating_regulation"]),
      ("Geographical area", data["geographical_area"].get_description().description|safe),
      ("Quota order number", data["order_number"]),
      ("Measure start date", "{:%d/%m/%Y}".format(data["valid_between"].lower) if data["valid_between"] and data["valid_between"].lower else "-"),
      ("Measure end date", "{:%d/%m/%Y}".format(data["valid_between"].upper) if data["valid_between"] and data["valid_between"].upper else "-"),
    ]) }}
  {% endcall %}

  {% call(rows, data) review_step("commodity") %}
    {{ rows.extend([
      ("Commodity code", data["goods_nomenclature"] ~ " - " ~ data["goods_nomenclature"].get_description().description|safe if data["goods_nomenclature"] else "None"),
      ("Additional code", data["additional_code"] ~ " - " ~ data["additional_code"].get_description().description|safe if data["additional_code"] else "None"),
    ]) }}
  {% endcall %}

  {% call(rows, data) review_step("conditions") %}
    {% for item in data  %}
      {% if not item.DELETE %}
        {{ rows.append(("Condition code", item.condition_code)) }}
      {% endif %}
    {% endfor %}
  {% endcall %}

  {% call(rows, data) review_step("duties") %}
    {{ rows.append(("Duties", data["duties"])) }}
  {% endcall %}

  {% call(rows, data) review_step("footnotes") %}
    {% for item in data %}
      {% if not item.DELETE %}
        {{ rows.append(("Footnote", item.footnote ~ " - " ~ item.footnote.get_description().description|safe)) }}
      {% endif %}
    {% endfor %}
  {% endcall %}

  {{ govukButton({"text": "Create"}) }}
{% endblock %}
