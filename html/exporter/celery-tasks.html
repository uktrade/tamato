<!DOCTYPE html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Celery Tasks - DIT Tariff Management Tool</title>
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/javascripts/_analytics.js"></script>
    <script src="../_static/javascripts/_govuk/govuk-frontend-3.10.2.min.js"></script>
    <script src="../_static/javascripts/_govuk/modules.js"></script>
    <script src="../_static/javascripts/_modules/anchored-headings.js"></script>
    <script src="../_static/javascripts/_modules/collapsible-navigation.js"></script>
    <script src="../_static/javascripts/_modules/in-page-navigation.js"></script>
    <script src="../_static/javascripts/_modules/navigation.js"></script>
    <script src="../_static/javascripts/_modules/page-expiry.js"></script>
    <script src="../_static/javascripts/_modules/table-of-contents.js"></script>
    <script src="../_static/javascripts/_start_modules.js"></script>
    <script src="../_static/javascripts/_vendor/fixedsticky.js"></script>
    <script src="../_static/javascripts/_vendor/lodash.js"></script>
    <script src="../_static/javascripts/_vendor/modernizer.js"></script>
    <script src="../_static/javascripts/govuk_tech_docs.js"></script>
    <script src="../_static/javascripts/theme.js"></script>
    <link href="../_static/stylesheets/manifest.css" rel="stylesheet" />
    <link href="../_static/stylesheets/theme.css" rel="stylesheet" />
    <link rel="shortcut icon" href="../_static//favicon.ico"/>
  </head>
  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>
        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
          <div class="govuk-header__container govuk-header__container--full-width">

            <div class="govuk-header__logo">
  <a href="../index.html" class="govuk-header__link govuk-header__link--homepage">
    <span class="govuk-header__logotype">
      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-header__logotype-crown"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 132 97"
        height="30"
        width="36"
        >
        <path
          fill="currentColor" fill-rule="evenodd"
          d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
          ></path>
        <image src="../_static/assets/govuk/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
      </svg>
      
      <span class="govuk-header__logotype-text">DIT</span>
    </span>
    <span class="govuk-header__product-name">Tariff Management Tool</span>
  </a><strong class="govuk-tag">Alpha</strong></div>
            <div class="govuk-header__content" role="navigation">
  <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
  <nav>
    <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
      <li class="govuk-header__navigation-item">
        <a class="govuk-header__link" href="https://github.com/uktrade/tamato">GitHub</a>
        </li>
    </ul>
  </nav>
</div>

          </div>
        </header>
      </div>
      <div id="toc-heading" class="toc-show fixedsticky">
        <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
        Table of contents <span class="toc-show__icon"></span>
        </a>
      </div>
      <div class="app-pane__body" data-module="in-page-navigation">

        <div class="app-pane__toc" role="navigation">
  <div class="toc" data-module="table-of-contents">
    <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>

    <div class="search" data-module="search">
  <form action="../search.html" method="get" role="search">
    <label class="govuk-label search__label" for="search">Search</label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
</div>

    <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">

      
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tariff Management Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../envvars.html">Environment variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adr/index.html">Architectural Decision Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="../business_rules/index.html">Business Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../taric/index.html">TARIC3 Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../importer/index.html">The Importer</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">The Exporter</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Celery Tasks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#upload-workbaskets">upload_workbaskets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upload-workbasket-envelopes">upload_workbasket_envelopes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#send-upload-notifications">send_upload_notifications</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#database-models">Database models</a></li>
<li class="toctree-l2"><a class="reference internal" href="#other-classes">Other classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#renderedtransactions">RenderedTransactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#uploadtaskresultdata">UploadTaskResultData:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="management-commands.html">Management Commands</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../training/gherkin.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CODE_OF_CONDUCT.html">Contributor Covenant Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

      <hr size="1">

      
      <h1>On this page</h1>
      <ul>
<li><a class="reference internal" href="#">Celery Tasks</a><ul>
<li><a class="reference internal" href="#upload-workbaskets">upload_workbaskets</a></li>
<li><a class="reference internal" href="#upload-workbasket-envelopes">upload_workbasket_envelopes</a></li>
<li><a class="reference internal" href="#send-upload-notifications">send_upload_notifications</a></li>
</ul>
</li>
<li><a class="reference internal" href="#database-models">Database models</a></li>
<li><a class="reference internal" href="#other-classes">Other classes</a><ul>
<li><a class="reference internal" href="#renderedtransactions">RenderedTransactions</a></li>
<li><a class="reference internal" href="#uploadtaskresultdata">UploadTaskResultData:</a></li>
</ul>
</li>
</ul>


    </nav>
  </div>
</div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings" role="main">

            
  <section id="celery-tasks">
<h1>Celery Tasks<a class="headerlink" href="#celery-tasks" title="Permalink to this headline">¶</a></h1>
<p>Celery Tasks for the exporter are triggered on setting Workbaskets READY_FOR_EXPORT, the upload_transactions management command, or via the celery commandline or GUI.</p>
<section id="upload-workbaskets">
<h2>upload_workbaskets<a class="headerlink" href="#upload-workbaskets" title="Permalink to this headline">¶</a></h2>
<p><cite>upload_workbaskets</cite> is the main Task, delegating to two subtasks: <cite>upload_workbasket_envelopes</cite> and <cite>send_upload_notifications</cite>.</p>
<dl class="simple">
<dt>The two tasks are split up the end-point they call, which has some advantages:</dt><dd><ul class="simple">
<li><p>Failure in one task won’t delay the other (and thus the whole task queue).</p></li>
<li><p>Retries, will only retry the affected end-point (e.g. a notification failure won’t result in re-uploading data).</p></li>
</ul>
</dd>
</dl>
<p>The tasks are not split up any further because ordering of data is important, files are also used and under Celery Tasks
may not run on the same machine.</p>
</section>
<section id="upload-workbasket-envelopes">
<h2>upload_workbasket_envelopes<a class="headerlink" href="#upload-workbasket-envelopes" title="Permalink to this headline">¶</a></h2>
<p>Responsibilities:</p>
<blockquote>
<div><ul class="simple">
<li><p>Serialize Workbaskets into XML Envelopes of 40mb or less.</p></li>
<li><p>Upload Envelope XML to the HMRC S3 Bucket.</p></li>
</ul>
</div></blockquote>
<p>Workbaskets with the status READY_FOR_EXPORT are queried for Transactions, which are then serialized into 1 or more
Envelope XML files with a (configurable) maximum size of 40mb.</p>
<p>Data is validated against the TARIC XSD before creating objects in the database (Envelope, EnvelopeTransaction and Upload) and uploading to s3.</p>
<p>Avoiding race conditions:</p>
<p>It is important that transaction ids within envelopes start at a number then iterate continuously from there.
Since data must be output to XML and only later in the Task saved to the database the Envelope table is locked
for writes between writing the XML and saving data to the database.</p>
<p>Failure modes and retries:</p>
<dl class="simple">
<dt>In the case of a failure in <cite>upload_workbasket_envelopes</cite> an exception is raised:</dt><dd><ul class="simple">
<li><p>Connectivity exceptions:  Celery will attempt to retry the Task later [1]</p></li>
<li><p>All other exceptions: Data is rolled back and the task will fail.</p></li>
</ul>
</dd>
</dl>
<p>[1] Retry behaviour due to connectivity failures is configurable, the defaults specifying exponential backoff and jitter (randomisation).</p>
</section>
<section id="send-upload-notifications">
<h2>send_upload_notifications<a class="headerlink" href="#send-upload-notifications" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>Responsibilities:</dt><dd><ul class="simple">
<li><p>Call the HMRC notification API for each uploaded file.</p></li>
</ul>
</dd>
</dl>
<p>send_upload_notifications accepts a sequence of Envelope primary keys[2] that the <cite>upload_workbasket_envelopes</cite> saved to s3.</p>
<p>[2] - Best practice using Celery is to use primary keys, not model instances.</p>
<p>Failure modes and retries:</p>
<p>Retry behaviour due to connectivity failures is configurable, the defaults specifying exponential backoff and jitter (randomisation).
If case all retries fail then the Envelopes Upload objects will be left with the notification_sent field set to null.</p>
</section>
</section>
<section id="database-models">
<h1>Database models<a class="headerlink" href="#database-models" title="Permalink to this headline">¶</a></h1>
<dl class="py class">
<dt class="sig sig-object py" id="taric.models.Envelope">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">taric.models.</span></span><span class="sig-name descname"><span class="pre">Envelope</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/taric/models.html#Envelope"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#taric.models.Envelope" title="Permalink to this definition">¶</a></dt>
<dd><p>Represents a TARIC3 envelope.</p>
<p>An Envelope contains one or more Transactions, listing changes to be applied
to the tariff in the sequence defined by the transaction IDs.</p>
</dd></dl>

<p>Represents one TARIC XML file exported as all or part of a WorkBasket.</p>
<dl class="py class">
<dt class="sig sig-object py" id="taric.models.EnvelopeTransaction">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">taric.models.</span></span><span class="sig-name descname"><span class="pre">EnvelopeTransaction</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/taric/models.html#EnvelopeTransaction"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#taric.models.EnvelopeTransaction" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies a sequence to Transactions contained in an Envelope.</p>
</dd></dl>

<p>Each Envelope has one or more EnvelopeTransactions linking it to the concrete Transactions it contains.</p>
<dl class="py class">
<dt class="sig sig-object py" id="exporter.models.Upload">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">exporter.models.</span></span><span class="sig-name descname"><span class="pre">Upload</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/exporter/models.html#Upload"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#exporter.models.Upload" title="Permalink to this definition">¶</a></dt>
<dd><p>Represents a TARIC differential update file upload to HMRC.</p>
</dd></dl>

<p>Represents whether an upload was successful or not.</p>
</section>
<section id="other-classes">
<h1>Other classes<a class="headerlink" href="#other-classes" title="Permalink to this headline">¶</a></h1>
<p>As well as database models, plain old classes are used to represent ephemeral data.</p>
<section id="renderedtransactions">
<h2>RenderedTransactions<a class="headerlink" href="#renderedtransactions" title="Permalink to this headline">¶</a></h2>
<p>RenderedTransactions link Transaction objects with rendered envelopes in an XML file, before it has been validated or added to the database as Envelope and EnvelopeTransaction objects for upload.</p>
<dl class="simple">
<dt>MultiFileEnvelopeTransactionSerializer.split_render_transactions, generates instances of RenderedTransactions, a namedtuple holding:</dt><dd><ul class="simple">
<li><p>envelope_id: TARIC envelope id, to use when later when Envelope object is created.</p></li>
<li><p>transactions:  Transaction objects rendered in this envelope.</p></li>
<li><p>output: file object envelope</p></li>
<li><p>is_oversize: True if the rendered envelope was above the max size (default 40mb)</p></li>
<li><p>max_envelope_size: The maximum envelope size that was used (default 40mb).</p></li>
</ul>
</dd>
</dl>
</section>
<section id="uploadtaskresultdata">
<h2>UploadTaskResultData:<a class="headerlink" href="#uploadtaskresultdata" title="Permalink to this headline">¶</a></h2>
<p><cite>Uploaded envelope ids, and user readable messages</cite>.</p>
<dl class="simple">
<dt>Responsibilities:</dt><dd><ul class="simple">
<li><p>Save state passed between the upload / notify Tasks</p></li>
<li><p>Save human readable messages for the user on Task completion.</p></li>
<li><p>Serialize data for Celery when passing data between Tasks.</p></li>
</ul>
</dd>
</dl>
<p>Data here is passed between the subtasks of upload_workbaskets including information for the user the triggered the tasks, i.e. from a management command.</p>
</section>
</section>



          </main>

          <aside>
  <ul class="contribution-banner">
    
    <li><a href="https://github.com/uktrade/tamato/blob/main/docs/exporter/celery-tasks.rst">View source</a></li>
    <li><a href="https://github.com/uktrade/tamato/issues/new?labels=bug&amp;title=Re:%20'exporter/celery-tasks.rst'&amp;body=Problem%20with%20'exporter/celery-tasks.rst'%20(docs/)">Report problem</a></li>
    <li><a href="https://github.com/uktrade/tamato">GitHub Repo</a></li>
    
  </ul>
</aside>
          <footer class="govuk-footer app-footer" role="contentinfo">
<div class="govuk-footer__meta">
  <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">
    <ul class="govuk-footer__inline-list">
      <li class="govuk-footer__inline-list-item">
        <a class="govuk-footer__link" href="../accessibility.html">Accessibility</a>
      </li>
      <li class="govuk-footer__inline-list-item">
        Built with <a class="govuk-footer__link" href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0 using the <a class="govuk-footer__link" href="https://www.github.com/ukgovdatascience/govuk-tech-docs-sphinx-theme">GOV.UK Tech Docs Sphinx Theme</a>.
      </li>
    </ul>
    <svg
      aria-hidden="true"
      focusable="false"
      class="govuk-footer__licence-logo"
      xmlns="http://www.w3.org/2000/svg"
      viewbox="0 0 483.2 195.7"
      height="17"
      width="41"
      >
      <path
        fill="currentColor"
        d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
    </svg>
    <span class="govuk-footer__licence-description">
    All content is available under the
    <a
      class="govuk-footer__link"
      href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
      rel="license"
      >Open Government Licence v3.0</a>, except where otherwise stated
    </span>
  </div>
  <div class="govuk-footer__meta-item">
    <a
      class="govuk-footer__link govuk-footer__copyright-logo"
      href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
  </div>
</div>
</footer>

        </div>
      </div>
    </div>
  </body>
</html>