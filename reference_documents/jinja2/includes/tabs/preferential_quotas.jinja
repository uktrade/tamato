{% from "components/table/macro.njk" import govukTable %}
{% from 'macros/create_link.jinja' import create_link %}

<div class="quota__core-data govuk-grid-row">
    <div class="quota__core-data__content govuk-grid-column-three-quarters">
        {% for key, value in reference_document_version_quotas.items() %}
            {% if value["quota_order_number"] != None %}
                <h2 class="govuk-heading-m" id="subsection-title">Order number
                    <a class="govuk-link" href="{{ url("quota-ui-detail", args=[value["quota_order_number"].sid] ) }}">
                        {{ value["quota_order_number"] }}
                    </a>
                </h2>
                <div class="govuk-body">
                    validity: from {{ value["quota_order_number"].valid_between.lower }}
                    {% if value["quota_order_number"].valid_between.upper == None %}
                        no end date defined
                    {% else %}
                        to {{ value["quota_order_number"].valid_between.upper }}
                    {% endif %}
                </div>
            {% else %}
                <h2 class="govuk-heading-m" id="subsection-title">Order number {{ value["quota_order_number_text"] }}</h2>
            {% endif %}
            <div class="govuk-body govuk-!-margin-bottom-2">
                Valid between: {{ value['ref_doc_order_number'].valid_between }}
                {% if value['ref_doc_order_number'].main_order_number %}
                    Sub quota to {{ value['ref_doc_order_number'].main_order_number.quota_order_number }}
                {% endif %}
            </div>
            <div class="govuk-body govuk-!-margin-bottom-2">
                {% if object.editable() %}
                    {% if request.user.has_perm("reference_documents.change_preferentialquotaordernumber") %}
                        <a class="order_number_link" href="{{ url('reference_documents:preferential_quota_order_number_edit', args=[value['ref_doc_order_number'].id]) }}">Edit</a>
                    {% endif %}

                    {% if request.user.has_perm("reference_documents.delete_preferentialquotaordernumber") %}
                        <a class="order_number_link"
                           href="{{ url('reference_documents:preferential_quota_order_number_delete', args=[value['ref_doc_order_number'].id, value['ref_doc_order_number'].reference_document_version.id]) }}">Delete</a>
                    {% endif %}

                    {% if request.user.has_perm("reference_documents.add_preferentialquotatemplate") %}
                        <a class="order_number_link" href="{{ url('reference_documents:preferential-quotas-template-create', args=[object.pk]) }}">Add new quota template</a>
                    {% endif %}

                    {% if request.user.has_perm("reference_documents.add_preferentialquota") %}
                        <a class="order_number_link" href="{{ url('reference_documents:preferential_quotas_create_for_order', args=[object.pk, value['ref_doc_order_number'].pk]) }}">Add quota to order number</a>
                    {% endif %}

                    {% if request.user.has_perm("reference_documents.add_preferentialquota") %}
                        <a class="order_number_link" href="{{ url('reference_documents:preferential_quotas_bulk_create_for_order', kwargs={"pk": object.pk, "order_pk": value['ref_doc_order_number'].pk}) }}">Bulk add
                            quotas</a>
                    {% endif %}

                {% endif %}
            </div>
            {% if value['data_rows'] != [] %}
                <h3 class="govuk-heading-m" id="subsection-title">Quota definitions</h3>
                {{ govukTable({
                "head": reference_document_version_quotas_headers,
                "rows": value['data_rows']
                }) }}
            {% else %}
                <div class="govuk-body govuk-!-margin-bottom-2">
                    <i>No quota definitions defined</i>
                </div>
            {% endif %}

            {% if value['suspension_data_rows'] != [] %}
                <h3 class="govuk-heading-m" id="subsection-title">Quota suspensions</h3>
                {{ govukTable({
                "head": reference_document_version_suspension_headers,
                "rows": value['suspension_data_rows']
                }) }}
            {% else %}
                <div class="govuk-body govuk-!-margin-bottom-2">
                    <i>No quota suspensions defined</i>
                </div>
            {% endif %}

            {% if value['templated_data'].keys() %}
                <h3 class="govuk-heading-m" id="subsection-title">Templated quota definitions</h3>
                {% for k, v in value['templated_data'].items() %}
                    {% for item in v %}
                        <div class="govuk-body govuk-!-margin-bottom-2">
                            Duty Rate: {{ item['preferential_quota_template'].quota_duty_rate }}<br>
                            First years volume : {{ item['preferential_quota_template'].initial_volume }} <br>
                            Incremental yearly change there after : {{ item['preferential_quota_template'].yearly_volume_increment }} <br>
                            Incremental yearly change text : {{ item['preferential_quota_template'].yearly_volume_increment_text }} <br>
                            Yearly period :
                            from {{ item['preferential_quota_template'].start_day }}-{{ item['preferential_quota_template'].start_month }}-20XX to
                            {{ item['preferential_quota_template'].end_day }}-{{ item['preferential_quota_template'].end_month }}-20XX<br>
                            Yearly range : from {{ item['preferential_quota_template'].start_year }}
                            {% if item['preferential_quota_template'].end_year %}
                                to {{ item['preferential_quota_template'].end_year }} <br>
                            {% else %}
                                onwards (no end year)<br>
                            {% endif %}

                        </div>
                        <div class="govuk-body govuk-!-margin-bottom-2">
                            <i>Note: For templated quota definitions that extend longer than three years in the future only the next three years will be displayed.</i>
                        </div>
                        <div class="govuk-body govuk-!-margin-bottom-2">
                            {% if object.editable() %}
                                {% if request.user.has_perm("reference_documents.change_preferentialquotatemplate") %}
                                    <a class="order_number_link" href="{{ url('reference_documents:preferential-quotas-template-edit', args=[item['preferential_quota_template'].id]) }}">Edit</a>
                                {% endif %}

                                {% if request.user.has_perm("reference_documents.delete_preferentialquotatemplate") %}
                                    <a class="order_number_link"
                                       href="{{ url('reference_documents:preferential-quota-template-delete', args=[item['preferential_quota_template'].id, value['ref_doc_order_number'].reference_document_version.id]) }}">Delete</a>
                                {% endif %}
                            {% endif %}
                        </div>
                        {{ govukTable({
                        "head": reference_document_version_quotas_headers,
                        "rows": item['data_rows']
                    }) }}


                    {% endfor %}
                {% endfor %}
            {% else %}
                <div class="govuk-body govuk-!-margin-bottom-2">
                    <i>No templated quota suspensions defined</i>
                </div>
            {% endif %}

            {% if value['templated_suspension_data'].keys() %}
                <h3 class="govuk-heading-m" id="subsection-title">Templated quota suspensions</h3>
                {% for k, v in value['templated_data'].items() %}
                    {% for item in v %}
                        <div class="govuk-body govuk-!-margin-bottom-2">
                            Yearly period :
                            from {{ item['preferential_quota_template'].start_day }}-{{ item['preferential_quota_template'].start_month }}-20XX to
                            {{ item['preferential_quota_template'].end_day }}-{{ item['preferential_quota_template'].end_month }}-20XX<br>
                            Yearly range : from {{ item['preferential_quota_template'].start_year }}
                            {% if item['preferential_quota_template'].end_year %}
                                to {{ item['preferential_quota_template'].end_year }} <br>
                            {% else %}
                                onwards (no end year)<br>
                            {% endif %}

                        </div>
                        <div class="govuk-body govuk-!-margin-bottom-2">
                            <i>Note: For templated quota suspensions that extend longer than three years in the future only the next three years will be displayed.</i>
                        </div>
                        <div class="govuk-body govuk-!-margin-bottom-2">
                            {% if object.editable() %}
                                {% if request.user.has_perm("reference_documents.change_preferentialquotatemplate") %}
                                    <a class="order_number_link" href="{{ url('reference_documents:preferential-quotas-template-edit', args=[item['preferential_quota_template'].id]) }}">Edit</a>
                                {% endif %}

                                {% if request.user.has_perm("reference_documents.delete_preferentialquotatemplate") %}
                                    <a class="order_number_link"
                                       href="{{ url('reference_documents:preferential-quota-template-delete', args=[item['preferential_quota_template'].id, value['ref_doc_order_number'].reference_document_version.id]) }}">Delete</a>
                                {% endif %}
                            {% endif %}
                        </div>
                        {{ govukTable({
                        "head": reference_document_version_quotas_headers,
                        "rows": item['data_rows']
                    }) }}


                    {% endfor %}
                {% endfor %}

            {% else %}
                <div class="govuk-body govuk-!-margin-bottom-2">
                    <i>No templated quota suspensions defined</i>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="govuk-grid-column-one-quarter">
        <div class="app-related-items" role="complementary">
            <h2 class="govuk-heading-s" id="subsection-title">Actions</h2>
            <ul class="govuk-list govuk-!-font-size-16">
                {% if object.editable() %}
                    {% if request.user.has_perm("reference_documents.add_preferentialquotaordernumber") %}
                        <li><a class="govuk-link" href="{{ url('reference_documents:preferential_quota_order_number_create', args=[object.pk]) }}">Add new order number</a></li>
                    {% endif %}

                    {% if request.user.has_perm("reference_documents.add_preferentialquotatemplate") %}
                        <li><a class="govuk-link" href="{{ url('reference_documents:preferential-quotas-template-create', args=[object.pk]) }}">Add new quota template</a></li>
                    {% endif %}

                    {% if request.user.has_perm("reference_documents.add_preferentialquotasuspension") %}
                        <li><a class="govuk-link" href="{{ url('reference_documents:preferential-quotas-suspension-create', args=[object.pk]) }}">Add new quota suspension</a></li>
                    {% endif %}

                    {% if request.user.has_perm("reference_documents.add_preferentialquotasuspensiontemplate") %}
                        <li><a class="govuk-link" href="{{ url('reference_documents:preferential-quotas-suspension-template-create', args=[object.pk]) }}">Add new quota suspension template</a></li>
                    {% endif %}

                    {% if request.user.has_perm("reference_documents.add_preferentialquota") %}
                        <li><a class="govuk-link" href="{{ url('reference_documents:preferential_quotas_create', args=[object.pk]) }}">Add new quota</a></li>
                        <li><a class="govuk-link" href="{{ url('reference_documents:preferential_quotas_bulk_create', args=[object.pk]) }}">Bulk add quotas</a></li>
                    {% endif %}
                {% endif %}
            </ul>
        </div>
    </div>
</div>
