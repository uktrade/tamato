
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>workbaskets.models &#8212; TaMaTo 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../docs/index.html">TaMaTo 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">workbaskets.models</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for workbaskets.models</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;WorkBasket models.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Prefetch</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">QuerySet</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Subquery</span>
<span class="kn">from</span> <span class="nn">django_fsm</span> <span class="kn">import</span> <span class="n">FSMField</span>
<span class="kn">from</span> <span class="nn">django_fsm</span> <span class="kn">import</span> <span class="n">transition</span>

<span class="kn">from</span> <span class="nn">common.models.mixins</span> <span class="kn">import</span> <span class="n">TimestampedMixin</span>
<span class="kn">from</span> <span class="nn">common.models.records</span> <span class="kn">import</span> <span class="n">TrackedModel</span>
<span class="kn">from</span> <span class="nn">common.models.records</span> <span class="kn">import</span> <span class="n">TrackedModelQuerySet</span>
<span class="kn">from</span> <span class="nn">common.models.transactions</span> <span class="kn">import</span> <span class="n">Transaction</span>
<span class="kn">from</span> <span class="nn">common.models.transactions</span> <span class="kn">import</span> <span class="n">TransactionPartition</span>
<span class="kn">from</span> <span class="nn">workbaskets.validators</span> <span class="kn">import</span> <span class="n">WorkflowStatus</span>


<span class="k">class</span> <span class="nc">TransactionPartitionScheme</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TransactionPartitionScheme schemes store settings that change how</span>
<span class="sd">    transactions are partitioned in relation to Workbaskets.</span>

<span class="sd">    This needs references to both Transaction and Workbasket so currently lives</span>
<span class="sd">    in the workbaskets django app.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_approved_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionPartition</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">WorkflowStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionPartition</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SeedFirstTransactionPartitionScheme</span><span class="p">(</span><span class="n">TransactionPartitionScheme</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;In the SeedFirstTransactionPartitionScheme the first approved workbasket</span>
<span class="sd">    maps to SEED_FILE transactions and all following approved workbaskets map to</span>
<span class="sd">    REVISION transactions.&quot;&quot;&quot;</span>

    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;First workbasket contains SEED_FILE transactions, following workbaskets are REVISION.&quot;</span>

    <span class="k">def</span> <span class="nf">get_approved_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionPartition</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return REVISION: if any approved workbaskets exist otherwise SEED_FILE.</span>

<span class="sd">        Implements the policy where approved transactions in the first workbasket are from the seed file</span>
<span class="sd">        and the rest of the approved transactions are revisions.</span>

<span class="sd">        Usage note:   This must to be called before workbasket status is changed otherwise it will only</span>
<span class="sd">                      ever return REVISION.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">WorkBasket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">status__in</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">approved_statuses</span><span class="p">(),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">TransactionPartition</span><span class="o">.</span><span class="n">REVISION</span>
        <span class="k">return</span> <span class="n">TransactionPartition</span><span class="o">.</span><span class="n">SEED_FILE</span>

    <span class="k">def</span> <span class="nf">get_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">WorkflowStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionPartition</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param status:  Workbasket status</span>
<span class="sd">        :return:  TransactionPartition that maps to the workbasket status.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">approved_statuses</span><span class="p">():</span>
            <span class="c1"># Bail out early if not approved and avoid query in the next if block.</span>
            <span class="k">return</span> <span class="n">TransactionPartition</span><span class="o">.</span><span class="n">DRAFT</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_approved_partition</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">UserTransactionPartitionScheme</span><span class="p">(</span><span class="n">TransactionPartitionScheme</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    UserTransactionPartitionScheme allows the caller to specify which partition</span>
<span class="sd">    to map approved workbaskets to.</span>

<span class="sd">    If the user specifies SEED_FILE transaction where a REVISION transactions</span>
<span class="sd">    already exists, a ValueError is raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">approved_partition</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param approved_partition:  TransactionPartition to map approved workbaskets to.</span>
<span class="sd">        :param description: Description of this scheme, displayed on the commandline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">approved_partition</span> <span class="o">=</span> <span class="n">approved_partition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">approved_partition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TransactionPartition</span><span class="o">.</span><span class="n">approved_partitions</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;partition_scheme </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">approved_partition</span><span class="si">}</span><span class="s2"> is not one of </span><span class="si">{</span><span class="n">TransactionPartition</span><span class="o">.</span><span class="n">approved_partitions</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_approved_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionPartition</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return approved_partition, raises a ValueError in the case where</span>
<span class="sd">        approved_partition is SEED_FILE, and a REVISION partition already</span>
<span class="sd">        exists, to avoid changing the global order of transactions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">approved_partition</span> <span class="o">==</span> <span class="n">TransactionPartition</span><span class="o">.</span><span class="n">SEED_FILE</span>
            <span class="ow">and</span> <span class="n">Transaction</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">partition</span><span class="o">=</span><span class="n">TransactionPartition</span><span class="o">.</span><span class="n">REVISION</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Revision transactions exist, extra seed partitions may cause transaction ordering issues.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">approved_partition</span>

    <span class="k">def</span> <span class="nf">get_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">WorkflowStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionPartition</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param status:  Workbasket status</span>
<span class="sd">        :return:  TransactionPartition that maps to the workbasket status.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">approved_statuses</span><span class="p">():</span>
            <span class="c1"># Bail out early if not approved and avoid query in the next if block.</span>
            <span class="k">return</span> <span class="n">TransactionPartition</span><span class="o">.</span><span class="n">DRAFT</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_approved_partition</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="n">UserTransactionPartitionScheme</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">approved_partition</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">approved_partition</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> approved_partition=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">approved_partition</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="p">)</span>


<span class="c1"># SEED_FIRST, REVISION_ONLY, SEED_ONLY can all be specified from the TRANSACTION_SCHEMA setting / environment variable.</span>
<span class="n">SEED_FIRST</span> <span class="o">=</span> <span class="n">SeedFirstTransactionPartitionScheme</span><span class="p">()</span>
<span class="n">REVISION_ONLY</span> <span class="o">=</span> <span class="n">UserTransactionPartitionScheme</span><span class="p">(</span>
    <span class="n">TransactionPartition</span><span class="o">.</span><span class="n">REVISION</span><span class="p">,</span>
    <span class="s2">&quot;Create REVISION transactions&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">SEED_ONLY</span> <span class="o">=</span> <span class="n">UserTransactionPartitionScheme</span><span class="p">(</span>
    <span class="n">TransactionPartition</span><span class="o">.</span><span class="n">SEED_FILE</span><span class="p">,</span>
    <span class="s2">&quot;Create SEED_FILE transactions (disallowed if any REVISION transactions exist)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Dict of transaction partition schemas by keyed name, for reference from management commands.</span>
<span class="n">TRANSACTION_PARTITION_SCHEMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;seed_first&quot;</span><span class="p">:</span> <span class="n">SEED_FIRST</span><span class="p">,</span>
    <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">SEED_ONLY</span><span class="p">,</span>
    <span class="s2">&quot;revision&quot;</span><span class="p">:</span> <span class="n">REVISION_ONLY</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">get_partition_scheme</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">TransactionPartitionScheme</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve transaction schema class from settings.TRANSACTION_SCHEMA, which</span>
<span class="sd">    must contain a fully qualified path to an instance of</span>
<span class="sd">    TransactionPartitionScheme, ie.</span>

<span class="sd">    workbaskets.models.SEED_FIRST, workbaskets.models.SEED_ONLY,</span>
<span class="sd">    workbaskets.models.REVISION</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;settings.TRANSACTION_SCHEMA is not an instance of workbasket.models.TransactionPartitionScheme such as &quot;</span>
        <span class="s2">&quot;workbaskets.models.SEED_FIRST&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;TRANSACTION_SCHEMA&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">TRANSACTION_SCHEMA</span>
    <span class="p">):</span>
        <span class="c1"># Setting must exist and contain a dot.</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="n">module_name</span><span class="p">,</span> <span class="n">class_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">TRANSACTION_SCHEMA</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">TransactionPartitionScheme</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="c1"># All the sane ways this might be mis-configured should have been covered.</span>
    <span class="k">return</span> <span class="n">schema</span>


<span class="k">class</span> <span class="nc">WorkBasketQueryset</span><span class="p">(</span><span class="n">QuerySet</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prefetch_ordered_tracked_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sort tracked_models by record_number, subrecord_number by using</span>
<span class="sd">        prefetch and imposing the order there.&quot;&quot;&quot;</span>

        <span class="n">q_annotate_record_code</span> <span class="o">=</span> <span class="n">TrackedModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate_record_codes</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="s2">&quot;record_code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;subrecord_code&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span>
            <span class="n">Prefetch</span><span class="p">(</span><span class="s2">&quot;tracked_models&quot;</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">q_annotate_record_code</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">ordered_transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This Workbaskets transactions in creation order.</span>

<span class="sd">        Note: tracked_models are ordered by record_code, subrecord_code by TransactionManager</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workbasket_pks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Transaction</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">workbasket__pk__in</span><span class="o">=</span><span class="n">Subquery</span><span class="p">(</span><span class="n">workbasket_pks</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_approved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">status__in</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">approved_statuses</span><span class="p">(),</span>
            <span class="n">approver__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_not_approved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">status__in</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">approved_statuses</span><span class="p">(),</span>
            <span class="n">approver__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>


<div class="viewcode-block" id="WorkBasket"><a class="viewcode-back" href="../../docs/architecture/index.html#workbaskets.models.WorkBasket">[docs]</a><span class="k">class</span> <span class="nc">WorkBasket</span><span class="p">(</span><span class="n">TimestampedMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A WorkBasket groups tariff edits which will be applied at the same time.</span>

<span class="sd">    WorkBasket status is controlled by a state machine:</span>
<span class="sd">    See https://uktrade.atlassian.net/wiki/spaces/TARIFFSALPHA/pages/953581609/a.+Workbasket+workflow</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">WorkBasketQueryset</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>

    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Short name for this workbasket&quot;</span><span class="p">,</span>
        <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">reason</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Reason for the changes to the tariff&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span>
        <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">approver</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span>
        <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;approved_workbaskets&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">FSMField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">EDITING</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span>
        <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1"># Ideally, we would protect the status field from being modified except by the</span>
        <span class="c1"># transition methods, otherwise the workbasket contents can be left in an</span>
        <span class="c1"># invalid state.  Unfortunately if `protected` is True the `clean` method raises</span>
        <span class="c1"># an exception.</span>
        <span class="n">protected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">approved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">approved_statuses</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">) [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="nd">@transition</span><span class="p">(</span>
        <span class="n">field</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">EDITING</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">PROPOSED</span><span class="p">,</span>
        <span class="n">custom</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Submit for approval&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">submit_for_approval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>

    <span class="nd">@transition</span><span class="p">(</span>
        <span class="n">field</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">PROPOSED</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">EDITING</span><span class="p">,</span>
        <span class="n">custom</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Withdraw or reject submission&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Withdraw/reject a proposed workbasket.&quot;&quot;&quot;</span>

    <span class="nd">@transition</span><span class="p">(</span>
        <span class="n">field</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">PROPOSED</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">APPROVED</span><span class="p">,</span>
        <span class="n">custom</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Approve&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">approve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">partition_scheme</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Once a workbasket has been approved all related Tracked Models must</span>
<span class="sd">        be updated to the current versions of themselves.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">approver</span> <span class="o">=</span> <span class="n">user</span>

        <span class="c1"># Move transactions from the DRAFT partition into the REVISION partition.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">save_drafts</span><span class="p">(</span><span class="n">partition_scheme</span><span class="p">)</span>

    <span class="nd">@transition</span><span class="p">(</span>
        <span class="n">field</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">APPROVED</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">SENT</span><span class="p">,</span>
        <span class="n">custom</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Send to HMRC&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">export_to_cds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tariff changes in workbasket have been sent to HMRC CDS.&quot;&quot;&quot;</span>

    <span class="nd">@transition</span><span class="p">(</span>
        <span class="n">field</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">SENT</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">,</span>
        <span class="n">custom</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Publish&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">cds_confirmed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;HMRC CDS has accepted the changes to the tariff.&quot;&quot;&quot;</span>

    <span class="nd">@transition</span><span class="p">(</span>
        <span class="n">field</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">SENT</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">ERRORED</span><span class="p">,</span>
        <span class="n">custom</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Mark as in error&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">cds_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If a workbasket, after approval, is then rejected by CDS it is</span>
<span class="sd">        important to roll back the current models to the previous approved</span>
<span class="sd">        version.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_models</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-pk&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;version_group&quot;</span><span class="p">):</span>
            <span class="n">version_group</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">version_group</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">version_group</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">has_approved_state</span><span class="p">()</span>
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-pk&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">versions</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">version_group</span><span class="o">.</span><span class="n">current_version</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version_group</span><span class="o">.</span><span class="n">current_version</span> <span class="o">=</span> <span class="n">versions</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">version_group</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save_to_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;workbasket&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tracked_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrackedModelQuerySet</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TrackedModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">transaction__workbasket</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_from_session</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;workbasket&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;WorkBasket not in session&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">WorkBasket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;workbasket&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the current workbasket in the session.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;workbasket&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="n">workbasket</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load_from_session</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">workbasket</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="n">WorkflowStatus</span><span class="o">.</span><span class="n">approved_statuses</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;workbasket&quot;</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">workbasket</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_current_transaction</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">workbasket</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">current</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">workbasket</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">workbasket</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">txn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">txn</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">errors</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">new_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new transaction in this workbasket.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="s2">&quot;partition&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># If partition was not specified, choose a partition scheme as configured from</span>
            <span class="c1"># settings and use that to determine which partition this is.</span>
            <span class="n">partition_scheme</span> <span class="o">=</span> <span class="n">get_partition_scheme</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;partition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partition_scheme</span><span class="o">.</span><span class="n">get_partition</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;composite_key&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span>
                <span class="s2">&quot;composite_key&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;partition&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Get Transaction model via transactions.model to avoid circular import.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">workbasket</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../docs/index.html">TaMaTo 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">workbaskets.models</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, DIT.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.0+.
    </div>
  </body>
</html>