{% extends "common/celery_queues.jinja" %}

{% from "macros/inline_filter_links.jinja" import inline_filter_links %}
{% from "components/table/macro.njk" import govukTable %}
{% from "components/button/macro.njk" import govukButton %}

{% macro status_tag(task_status) %}
    <span class="{{ status_tag_generator(task_status).tag_class }}">
            {{ status_tag_generator(task_status).text | upper }}
        </span>
{% endmacro %}

{% macro workbasket_link(workbasket_id) %}
    <a href="{{ url("workbaskets:workbasket-ui-detail", args=[workbasket_id]) }}"> {{ workbasket_id }} </a>
{% endmacro %}
{% set list_include = "includes/measures/create-task-list.jinja"%}

{% set page_title = "Rule check queue" %}

{% block breadcrumb %}
  {{ breadcrumbs(
      request,
      [ {"text": page_title} ],
      with_workbasket=False,
  ) }}
{% endblock %}

{% block tab_content %}
<div class="govuk-grid-row">

  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-xl">{{ page_title }}</h1>

        {{ govukButton({
            "html": refresh_button_content,
            "href": url("workbaskets:rule-check-queue"),
            "classes": "govuk-button--primary align-right govuk-!-margin-bottom-0 refresh-button",
      }) }}
  </div>

 <div class="govuk-grid-column-full">

{% if current_rule_checks %}
  {% set table_head = [
        {"text": "Workbasket ID"},
        {"text": "Checks completed"},
        {"text": "Time started"},
        {"text": "Celery task ID"},
        {"text": "Status"},
      ] %}

{% set table_rows = [] %}

{% for task in current_rule_checks %}
{{ table_rows.append([
                {"text": workbasket_link(task.workbasket_id)},
                {"text": task.checks_completed},
                {"text": task.date_time_start},
                {"text": task.task_id},
                {"html": status_tag(task.status)},
            ]) or "" }}
{% endfor %}


  {{ govukTable({
          "head": table_head,
          "rows": table_rows
      }) }}

    {% else %}
    <p class="govuk-body">There are currently no rule checks running or queued.</p>
    {% endif %}
</div>
</div>
{% endblock %}
