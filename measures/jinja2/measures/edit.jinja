{% extends "layouts/form.jinja" %}

{% from "components/accordion/macro.njk" import govukAccordion %}
{% from "components/details/macro.njk" import govukDetails %}
{% from "components/radios/macro.njk" import govukRadios %}
{% from "components/button/macro.njk" import govukButton %}
{% from "components/input/macro.njk" import govukInput %}
{% from "components/table/macro.njk" import govukTable %}


{% set page_title = "Edit " ~ object._meta.verbose_name ~ " details" %}

{% block beforeContent %}
  {{ govukBreadcrumbs({
    "items": [
      {"text": "Home", "href": url("index")},
      {"text": "Find and edit " ~ object._meta.verbose_name_plural, "href": object.get_url("list")},
      {"text": object._meta.verbose_name|capitalize ~ ": " ~ object.sid, "href": object.get_url()},
      {"text": page_title}
    ]
  }) }}
{% endblock %}

{% set validity_period_html %}
    {{ form.start_date }}
    {{ form.end_date }}
    {{ govukDetails({
      "summaryText": "Help with measure validity period",
      "text": "Enter the start date for the measureâ€™s validity period. The end date will inherit from the measure generating regulation or an earlier end date can be specified."
      }) }}
{% endset %}

{% set geographical_area_html %}
    {{ govukRadios({
        "idPrefix": "geographical_area_choice",
        "name": "geographical_area_choice",
        "fieldset": {
            "legend": {
                "text": "Geographical area",
            }
        },
        "items": [
            {
                "value": "all",
                "text": "Erga Omnes (all countries)",
                "checked": form.initial_geographical_area.is_all_countries(),
            },
            {
                "value": "group",
                "text": "A group of countries",
                "conditional": {
                    "html": form.geographical_area_group 
                },
                "checked": form.initial_geographical_area.is_group() and not form.initial_geographical_area.is_all_countries(),
            },
            {
                "value": "single",
                "text": "A single country or region",
                "conditional": {
                    "html": form.geographical_area_country_or_region 
                },
                "checked": form.initial_geographical_area.is_single_region_or_country(),
            }
        ]
    }) }}
    {{ govukDetails({
      "summaryText": "Help with geography",
      "text": "Choose the geographical area to which the measure applies. This can be a specific country or a group of countries, and exclusions can be specified. The measure will only apply to imports from or exports to the selected area."
    }) }}
{% endset %}

{% set footnotes_html %}
    {% if form.instance.footnotes.all() %}
        {% set table_rows = [] %}
        {% for footnote in form.instance.footnotes.all() %}
            {% set footnote_link -%}
            <a class="govuk-link govuk-!-font-weight-bold" href="{{ footnote.get_url() }}">{{ footnote|string }}</a>
            {%- endset %}
            {% set remove_button -%}
            <a href="#">Remove</a>
            {%- endset %}
            {{ table_rows.append([
            {"html": footnote_link},
            {"text": footnote.get_description().description|default("")},
            {"html": remove_button}
            ]) or "" }}
        {% endfor %}
        {{ govukTable({
            "head": [
            {"text": "ID"},
            {"text": "Description"},
            {"text": ""}
            ],
            "rows": table_rows,
            "caption": "Footnotes currently assigned to the measure",
            "captionClasses": "govuk-table__caption--m"
        }) }}
    {% else %}
        <p class="govuk__para">No footnotes found.</p>
    {% endif %}
    <div class="govuk-form-group">
        <label class="govuk-label">{{ form.footnote.label }}</label>
        <div id="sort-code-hint" class="govuk-hint">{{ form.footnote.help_text }}</div>
        {{ form.footnote }}
    </div>
    <div class="govuk-form-group">
        <a href="#" class="govuk-button govuk-button--secondary">Add another footnote</a>
    </div>
{% endset %}

{% block form %}
  {% call django_form(action=object.get_url("edit")) %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            {{ govukAccordion({
                "id": "accordion-default",
                "items": [
                    {
                        "heading": {"text": "Measure type"},
                        "content": {
                            "html": form.measure_type
                        },
                        "summary": {}
                    },
                    {
                        "heading": {"text": "Measure generating regulation"},
                        "content": {
                            "html": form.generating_regulation
                        },
                        "summary": {}
                    },
                    {
                        "heading": {"text": "Commodity code"},
                        "content": {
                            "html": form.goods_nomenclature
                        },
                        "summary": {}
                    },
                    {
                        "heading": {"text": "Additional code"},
                        "content": {
                            "html": form.additional_code
                        },
                        "summary": {}
                    },
                    {
                        "heading": {"text": "Geographical area"},
                        "content": {
                            "html": geographical_area_html
                        },
                        "summary": {}
                    },
                    {
                        "heading": {"text": "Footnotes"},
                        "content": {
                            "html": footnotes_html
                        },
                        "summary": {}
                    },
                    {
                        "heading": {"text": "Quota order number"},
                        "content": {
                            "html": form.order_number
                        },
                        "summary": {}
                    },
                    {
                        "heading": {"text": "Measure validity period"},
                        "content": {
                            "html": validity_period_html
                        },
                        "summary": {}
                    },
                ]
            }) }}
            {{ govukButton({
                "text":"Save",
            }) }}
        </div>
    </div>
  {% endcall %}
{% endblock %}