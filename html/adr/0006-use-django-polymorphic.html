<!DOCTYPE html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>6. Use Django Polymorphic for Multi-Table Inheritance - DIT Tariff Management Tool</title>
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/javascripts/_analytics.js"></script>
    <script src="../_static/javascripts/_govuk/govuk-frontend-3.10.2.min.js"></script>
    <script src="../_static/javascripts/_govuk/modules.js"></script>
    <script src="../_static/javascripts/_modules/anchored-headings.js"></script>
    <script src="../_static/javascripts/_modules/collapsible-navigation.js"></script>
    <script src="../_static/javascripts/_modules/in-page-navigation.js"></script>
    <script src="../_static/javascripts/_modules/navigation.js"></script>
    <script src="../_static/javascripts/_modules/page-expiry.js"></script>
    <script src="../_static/javascripts/_modules/table-of-contents.js"></script>
    <script src="../_static/javascripts/_start_modules.js"></script>
    <script src="../_static/javascripts/_vendor/fixedsticky.js"></script>
    <script src="../_static/javascripts/_vendor/lodash.js"></script>
    <script src="../_static/javascripts/_vendor/modernizer.js"></script>
    <script src="../_static/javascripts/govuk_tech_docs.js"></script>
    <script src="../_static/javascripts/theme.js"></script>
    <link href="../_static/stylesheets/manifest.css" rel="stylesheet" />
    <link href="../_static/stylesheets/theme.css" rel="stylesheet" />
    <link rel="shortcut icon" href="../_static//favicon.ico"/>
  </head>
  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>
        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
          <div class="govuk-header__container govuk-header__container--full-width">

            <div class="govuk-header__logo">
  <a href="../index.html" class="govuk-header__link govuk-header__link--homepage">
    <span class="govuk-header__logotype">
      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-header__logotype-crown"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 132 97"
        height="30"
        width="36"
        >
        <path
          fill="currentColor" fill-rule="evenodd"
          d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
          ></path>
        <image src="../_static/assets/govuk/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
      </svg>
      
      <span class="govuk-header__logotype-text">DIT</span>
    </span>
    <span class="govuk-header__product-name">Tariff Management Tool</span>
  </a><strong class="govuk-tag">Alpha</strong></div>
            <div class="govuk-header__content" role="navigation">
  <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
  <nav>
    <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
      <li class="govuk-header__navigation-item">
        <a class="govuk-header__link" href="https://github.com/uktrade/tamato">GitHub</a>
        </li>
    </ul>
  </nav>
</div>

          </div>
        </header>
      </div>
      <div id="toc-heading" class="toc-show fixedsticky">
        <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
        Table of contents <span class="toc-show__icon"></span>
        </a>
      </div>
      <div class="app-pane__body" data-module="in-page-navigation">

        <div class="app-pane__toc" role="navigation">
  <div class="toc" data-module="table-of-contents">
    <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>

    <div class="search" data-module="search">
  <form action="../search.html" method="get" role="search">
    <label class="govuk-label search__label" for="search">Search</label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
</div>

    <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">

      
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tariff Management Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../envvars.html">Environment variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Architectural Decision Records</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="0001-record-architecture-decisions.html">1. Record architecture decisions</a></li>
<li class="toctree-l2"><a class="reference internal" href="0002-use-pytest-bdd-for-bdd-testing.html">2. Use pytest-bdd for BDD testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="0003-use-django-rest-framework.html">3. Use Django REST Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="0004-xml-export-and-import.html">4. XML Import and Export</a></li>
<li class="toctree-l2"><a class="reference internal" href="0005-use-model-tracking-and-workbaskets.html">5. Use tracked models and workbaskets</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6. Use Django Polymorphic for Multi-Table Inheritance</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="#decision">Decision</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#what-does-this-actually-mean">What does this actually mean?</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#multi-table-inheritance-mti">Multi-table inheritance (MTI)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#polymorphic-models">Polymorphic models</a></li>
<li class="toctree-l5"><a class="reference internal" href="#alternatives">Alternatives</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#data-model">Data Model</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#column-descriptions">Column Descriptions</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#trackedmodel">TrackedModel</a></li>
<li class="toctree-l6"><a class="reference internal" href="#childmodel">ChildModel</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#consequences">Consequences</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sql">SQL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#query-examples">Query examples</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#getting-all-of-one-child-model">Getting all of one child model</a></li>
<li class="toctree-l5"><a class="reference internal" href="#getting-all-objects-changed-in-a-workbasket">Getting all objects changed in a WorkBasket</a></li>
<li class="toctree-l5"><a class="reference internal" href="#getting-all-of-one-type-of-child-model-from-a-workbasket">Getting all of one type of child model from a WorkBasket</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="0007-changes-go-through-a-stateful-workflow.html">7. Changes go through a stateful workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="0008-simplify-workflow-states.html">8. Simplify workflow states</a></li>
<li class="toctree-l2"><a class="reference internal" href="0009-record-generated-envelopes.html">9. Generate envelope files</a></li>
<li class="toctree-l2"><a class="reference internal" href="0010-convert-the-importer-to-a-pipeline.html">10. Convert the XML importer to a pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="0011-store-and-check-preference-codes.html">11. Store and check business rules around preference codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="0012-ordering-of-tariff-transactions.html">12. Ordering of tariff transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="0013-import-taric-nomenclature-updates.html">13. Import TARIC nomenclature updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="0014-simplify-current-transaction-queries.html">14. Simplification of current transaction queries</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../business_rules/index.html">Business Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../taric/index.html">TARIC3 Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../importer/index.html">The Importer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exporter/index.html">The Exporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CODE_OF_CONDUCT.html">Contributor Covenant Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

      <hr size="1">

      
      <h1>On this page</h1>
      <ul>
<li><a class="reference internal" href="#">6. Use Django Polymorphic for Multi-Table Inheritance</a><ul>
<li><a class="reference internal" href="#status">Status</a></li>
<li><a class="reference internal" href="#context">Context</a></li>
<li><a class="reference internal" href="#decision">Decision</a><ul>
<li><a class="reference internal" href="#what-does-this-actually-mean">What does this actually mean?</a><ul>
<li><a class="reference internal" href="#multi-table-inheritance-mti">Multi-table inheritance (MTI)</a></li>
<li><a class="reference internal" href="#polymorphic-models">Polymorphic models</a></li>
<li><a class="reference internal" href="#alternatives">Alternatives</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-model">Data Model</a><ul>
<li><a class="reference internal" href="#column-descriptions">Column Descriptions</a><ul>
<li><a class="reference internal" href="#trackedmodel">TrackedModel</a></li>
<li><a class="reference internal" href="#childmodel">ChildModel</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#consequences">Consequences</a><ul>
<li><a class="reference internal" href="#sql">SQL</a></li>
<li><a class="reference internal" href="#query-examples">Query examples</a><ul>
<li><a class="reference internal" href="#getting-all-of-one-child-model">Getting all of one child model</a></li>
<li><a class="reference internal" href="#getting-all-objects-changed-in-a-workbasket">Getting all objects changed in a WorkBasket</a></li>
<li><a class="reference internal" href="#getting-all-of-one-type-of-child-model-from-a-workbasket">Getting all of one type of child model from a WorkBasket</a></li>
</ul>
</li>
<li><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
</ul>
</li>
</ul>


    </nav>
  </div>
</div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings" role="main">

            
  <section id="use-django-polymorphic-for-multi-table-inheritance">
<span id="id1"></span><h1>6. Use Django Polymorphic for Multi-Table Inheritance<a class="headerlink" href="#use-django-polymorphic-for-multi-table-inheritance" title="Permalink to this headline">¶</a></h1>
<p>Date: 2020-06-12</p>
<section id="status">
<h2>Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p>Proposed</p>
</section>
<section id="context">
<h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">¶</a></h2>
<p>The Tariff Management Tool (TAMATO) requires a way to track changes
across the system. This is for multiple reasons, one is for auditing
purposes, another is to show progressive diffs of the data set, on
occasion it is also desirable to see data from a historical standpoint
and what changed with it.</p>
<p>To handle this there needs to be a way of connecting all changes to the
data within the system made since a certain point in time. As all
changes are managed through <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code>s the logical conclusion is
to use <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code>s as a basis for finding points of change and
group individual changes on those. Following this logic there must be a
clean method to follow reverse relations from a <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code>.</p>
<p>This is also a problem found within the <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code> system itself
which must manage changes and apply them. So naturally these problems
will be solved together.</p>
<p>In essence:</p>
<ul class="simple">
<li><p>It is required to find a set of changes based on a point of time.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code>s group changes together based on a single point of
time.</p></li>
<li><p>Finding a <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code> at a specific point in time is relatively
simple.</p></li>
<li><p>Finding all the objects grouped together by the <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code> holds
some complexity - this is the problem that this ADR proposes to
solve.</p></li>
</ul>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">¶</a></h2>
<p>This ADR proposes to use <a class="reference external" href="https://docs.djangoproject.com/en/3.0/topics/db/models/#multi-table-inheritance">multi-table inheritance</a> where a polymorphic
parent model holds a Foreign Key to a <code class="docutils literal notranslate"><span class="pre">Workbasket</span></code>. All changeable
data models inherit this polymorphic parent model. This will, as a
result, mask the intermediate (parent) tables on reverse relations to
data models being changed thus simplifying both the queries and code
required to access the data being changed from the <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code>.</p>
<section id="what-does-this-actually-mean">
<h3>What does this actually mean?<a class="headerlink" href="#what-does-this-actually-mean" title="Permalink to this headline">¶</a></h3>
<section id="multi-table-inheritance-mti">
<h4>Multi-table inheritance (MTI)<a class="headerlink" href="#multi-table-inheritance-mti" title="Permalink to this headline">¶</a></h4>
<p>MTI is useful when multiple models have overlapping columns. Instead of
copying these columns across all the tables, one common table is created
that has these specific columns. The more specific tables then have a
key to this common table. In Object oriented terms the common table is a
concrete class which the more specific models inherit as a parent.</p>
<p>Django supports this and, if coming from the child model, obfuscates the
link to a separate table by allowing you to access the parent attributes
straight from the child object (the parent and child rows are joined in
a single query so performance is not affected).</p>
</section>
<section id="polymorphic-models">
<h4>Polymorphic models<a class="headerlink" href="#polymorphic-models" title="Permalink to this headline">¶</a></h4>
<p>MTI solves one half of the problem - giving all the child tables an
efficient way to link to their inherited columns, however this could
also be solved with a mixin. The second half of the problem is not
easily solvable with a mixin - this is having efficient reverse
relations from the parent model to the child models. i.e. finding all
the child objects when we only have the parent objects. This is where polymorphism comes in.</p>
<p>Polymorphism of a database object is described as the ability for that
object to take on multiple forms. In this case it is better described as
the parent object having a self-awareness of which child object it
represents. To achieve this in django the parent table has an additional
column holding the content type (essentially the table) of the child
object. In doing this it is possible to group all parent rows by their
child object type. Once grouped a single query can be made for each
child object type to add the child columns to the objects.</p>
<p>The result of this is that, when starting with a list of the parent
objects, the total number of queries to collect all the data is <code class="docutils literal notranslate"><span class="pre">N+1</span></code>,
where <code class="docutils literal notranslate"><span class="pre">N</span></code> represents <em>the number of types of children in the query</em>
and <code class="docutils literal notranslate"><span class="pre">1</span></code> is the initial query to get all the parent objects.</p>
</section>
<section id="alternatives">
<h4>Alternatives<a class="headerlink" href="#alternatives" title="Permalink to this headline">¶</a></h4>
<p>One alternative is to use a mixin instead of MTI and polymorphism. This
gives the child objects all the necessary columns without a join being
required, however it removes the convenience of having a single table
other objects can link to. Specifically in TAMATO, it makes it difficult
to go from a <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code> to all the possible connected models. It is
necessary to either have a list of all the connected children types in
the <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code> model - which represents more work and weaker support
across databases - or to have a query against every possible linking
table to check if there is a link - which is inefficient.</p>
<p>Another alternative is single-table inheritance. This is where we have a
single table which can hold multiple models - in this case the
separation of the models from the table data is done in code. This
allows for everything to be done in a single query and it is easy to
work through reverse relations. However validation becomes increasingly
complex and, due to most columns having to be nullable, indexing takes a
significant hit.</p>
</section>
</section>
<section id="data-model">
<h3>Data Model<a class="headerlink" href="#data-model" title="Permalink to this headline">¶</a></h3>
<p><img alt="Tracked Model Schema" src="../_images/tracked_model_schema.png" /></p>
<section id="column-descriptions">
<h4>Column Descriptions<a class="headerlink" href="#column-descriptions" title="Permalink to this headline">¶</a></h4>
<section id="trackedmodel">
<h5>TrackedModel<a class="headerlink" href="#trackedmodel" title="Permalink to this headline">¶</a></h5>
<p>N.B. “related record” is used to describe the child model inheriting the
<code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ID</span></code> - Primary Key</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">workbasket</span></code> - the related <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">predecessor</span></code> - A foreign key to another <code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code> which
represents the previous iteration of the related record.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">polymorphic_ctype</span></code> - A foreign key to Djangos content type system,
which stores the details of the table being linked to.</p></li>
</ul>
</section>
<section id="childmodel">
<h5>ChildModel<a class="headerlink" href="#childmodel" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code> - Both the primary key of the table, and a foreign
key to the <code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code> table - as a result the ChildModel and
relevant <code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code> share the same primary key.</p></li>
</ul>
</section>
</section>
</section>
</section>
<section id="consequences">
<h2>Consequences<a class="headerlink" href="#consequences" title="Permalink to this headline">¶</a></h2>
<section id="sql">
<h3>SQL<a class="headerlink" href="#sql" title="Permalink to this headline">¶</a></h3>
<p>As discussed there are some performance costs and benefits to weigh up.</p>
<p>Cons:</p>
<ul class="simple">
<li><p>The number of queries in reverse relations will always be <code class="docutils literal notranslate"><span class="pre">N+1</span></code>.</p></li>
<li><p>The use of an <code class="docutils literal notranslate"><span class="pre">IN</span></code> statement has some performance costs, although
these are generally negligible.</p></li>
<li><p>Some code is required between the initial query fetching
<code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code>s to generate appropriate queries for the related
tables.</p></li>
</ul>
<p>Pros:</p>
<ul class="simple">
<li><p>Most of the above performance hits are incredibly difficult to avoid,
in relation to other solutions this is rather efficient.</p></li>
<li><p>The only obviously more efficient solution (single-table inheritance,
requires 1 query only) lacks significant options for constraining
data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">N</span></code> should never be very large given the limited number of models
to be changed.</p></li>
<li><p>Likewise the number of objects included in an <code class="docutils literal notranslate"><span class="pre">IN</span></code> clause is
unlikely to ever be very high.</p></li>
<li><p>The code for this option is surprisingly clean.</p></li>
</ul>
<p>To further exemplify how this works some example queries are below.</p>
</section>
<section id="query-examples">
<h3>Query examples<a class="headerlink" href="#query-examples" title="Permalink to this headline">¶</a></h3>
<section id="getting-all-of-one-child-model">
<h4>Getting all of one child model<a class="headerlink" href="#getting-all-of-one-child-model" title="Permalink to this headline">¶</a></h4>
<p>This query gets all Commodity models as an example:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">polymorphic_ctype_id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">workbasket_id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"></span>
<span class="w">       </span><span class="n">commodity</span><span class="p">.</span><span class="n">trackedmodel_ptr_id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">commodity</span><span class="w"></span>
<span class="w"> </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">trackedmodel</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">commodity</span><span class="p">.</span><span class="n">trackedmodel_ptr_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">id</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="getting-all-objects-changed-in-a-workbasket">
<h4>Getting all objects changed in a WorkBasket<a class="headerlink" href="#getting-all-objects-changed-in-a-workbasket" title="Permalink to this headline">¶</a></h4>
<p>This set of queries gets all the models changed in a single
<code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code>. In this case a footnote type and 2 commodities were
changed.</p>
<p>This first query gets all the <code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code>s:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">polymorphic_ctype_id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">workbasket_id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">trackedmodel</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">workbasket_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>The next two queries are generated in code and then executed.</p>
<p>This one gets all the commodities:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">polymorphic_ctype_id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">workbasket_id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"></span>
<span class="w">       </span><span class="n">commodity</span><span class="p">.</span><span class="n">trackedmodel_ptr_id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">commodity</span><span class="w"></span>
<span class="w"> </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">trackedmodel</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">commodity</span><span class="p">.</span><span class="n">trackedmodel_ptr_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">id</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">commodity</span><span class="p">.</span><span class="n">trackedmodel_ptr_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>This one gets all the footnote types:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">polymorphic_ctype_id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">workbasket_id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"></span>
<span class="w">       </span><span class="n">footnotetype</span><span class="p">.</span><span class="n">trackedmodel_ptr_id</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">footnotetype</span><span class="w"></span>
<span class="w"> </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">trackedmodel</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">footnotetype</span><span class="p">.</span><span class="n">trackedmodel_ptr_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">id</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">footnotetype</span><span class="p">.</span><span class="n">trackedmodel_ptr_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="getting-all-of-one-type-of-child-model-from-a-workbasket">
<h4>Getting all of one type of child model from a WorkBasket<a class="headerlink" href="#getting-all-of-one-type-of-child-model-from-a-workbasket" title="Permalink to this headline">¶</a></h4>
<p>This could be done directly in SQL as one query, however the Django ORM
does it by default in 2 (and sometimes by more depending on the code
implementation). The 2 query method uses the following queries:</p>
<p>This first query gets all the tracked models which are commodities.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="w"></span>
<span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">trackedmodel</span><span class="w"></span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">content_type</span><span class="w"></span>
<span class="w">   </span><span class="k">ON</span><span class="w"> </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">polymorphic_ctype_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">content_type</span><span class="p">.</span><span class="n">id</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">workbasket_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">content_type</span><span class="p">.</span><span class="n">app_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;commodities&quot;</span><span class="w"></span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">content_type</span><span class="p">.</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;commodity&quot;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>This second query gets all the commodity details from the
<code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code> details.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="w"></span>
<span class="w">      </span><span class="n">commodity</span><span class="p">.</span><span class="n">trackedmodel_ptr_id</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="w"></span>
<span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">commodity</span><span class="w"></span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">trackedmodel</span><span class="w"></span>
<span class="w">   </span><span class="k">ON</span><span class="w"> </span><span class="n">commodity</span><span class="p">.</span><span class="n">trackedmodel_ptr_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trackedmodel</span><span class="p">.</span><span class="n">id</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">commodity</span><span class="p">.</span><span class="n">trackedmodel_ptr_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="code">
<h3>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h3>
<p>There are numerous benefits of this option in the context of code.</p>
<p>Foremost is that this solution only requires the use of a single extra
library which makes use of an MTI mechanism already natively to Django.
This library is django-polymorphic.</p>
<p>The models classes as a result are quite simple, looking like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TrackedModel</span><span class="p">(</span><span class="n">PolymorphicModel</span><span class="p">):</span>
    <span class="n">workbasket</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;workbaskets.WorkBasket&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">draft</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">live</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">predecessor</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span>
        <span class="s2">&quot;self&quot;</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;successor&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">FootnoteType</span><span class="p">(</span><span class="n">TrackedModel</span><span class="p">,</span> <span class="n">ValidityMixin</span><span class="p">):</span>
   <span class="n">footnote_type_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
       <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">valid_footnote_type_id</span><span class="p">]</span>
   <span class="p">)</span>
   <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
<p>Accessing a child object is also no different than accessing a normal
django object. On the other hand accessing a <code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code> directly
automatically returns you the child instance it represents. As a result
getting all <code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code>s connected to a <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code>
automatically returns the relevant actual models:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">w</span> <span class="o">=</span> <span class="n">WorkBasket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">w</span><span class="o">.</span><span class="n">tracked_models</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="c1"># Prints:</span>
<span class="c1"># &lt;PolymorphicQuerySet [</span>
<span class="c1">#   &lt;Commodity: Commodity object (1)&gt;,</span>
<span class="c1">#   &lt;FootnoteType: FootnoteType object (2)&gt;,</span>
<span class="c1">#   &lt;Commodity: Commodity object (3)&gt;</span>
<span class="c1"># ]&gt;</span>
</pre></div>
</div>
<p>This is due to Django-Polymorphic overriding the default queryset class
to fetch the child classes and return those instead. Because of this the
code is always dealing with the child model and not directly with the
<code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code> unless explicitly stated. The project therefore is
allowed to lean into the template method design pattern. Most of the
generic requirements of <code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code>s can be handled in the
<code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code> itself. The children will inherit this common code and
can override it with any specific requirements the child model has. An
example would be generating TARIC3 components which could look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">w</span> <span class="o">=</span> <span class="n">WorkBasket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">taric_components</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tracked_object</span><span class="o">.</span><span class="n">generate_taric</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tracked_object</span> <span class="ow">in</span> <span class="n">w</span><span class="o">.</span><span class="n">tracked_models</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The same can be said for any operation that needs to be applied across
all objects tracked in a <code class="docutils literal notranslate"><span class="pre">WorkBasket</span></code>. As the code deals with the
child models by default it will, by default, run the code relevant to
that child.</p>
<p>This approach does force the <code class="docutils literal notranslate"><span class="pre">N+1</span></code> queries to be made by default. But
cases where the <code class="docutils literal notranslate"><span class="pre">TrackedModel</span></code> needs to be interacted with directly
will be rare.</p>
<p>In summary this keeps the number of queries to a relative minimum with
each query itself being performant. It simplifies the code base and
makes it easier for the developers to rapidly create generic solutions
across the system.</p>
</section>
</section>
</section>



          </main>

          <aside>
  <ul class="contribution-banner">
    
    <li><a href="https://github.com/uktrade/tamato/blob/main/docs/adr/0006-use-django-polymorphic.rst">View source</a></li>
    <li><a href="https://github.com/uktrade/tamato/issues/new?labels=bug&amp;title=Re:%20'adr/0006-use-django-polymorphic.rst'&amp;body=Problem%20with%20'adr/0006-use-django-polymorphic.rst'%20(docs/)">Report problem</a></li>
    <li><a href="https://github.com/uktrade/tamato">GitHub Repo</a></li>
    
  </ul>
</aside>
          <footer class="govuk-footer app-footer" role="contentinfo">
<div class="govuk-footer__meta">
  <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">
    <ul class="govuk-footer__inline-list">
      <li class="govuk-footer__inline-list-item">
        <a class="govuk-footer__link" href="../accessibility.html">Accessibility</a>
      </li>
      <li class="govuk-footer__inline-list-item">
        Built with <a class="govuk-footer__link" href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0 using the <a class="govuk-footer__link" href="https://www.github.com/ukgovdatascience/govuk-tech-docs-sphinx-theme">GOV.UK Tech Docs Sphinx Theme</a>.
      </li>
    </ul>
    <svg
      aria-hidden="true"
      focusable="false"
      class="govuk-footer__licence-logo"
      xmlns="http://www.w3.org/2000/svg"
      viewbox="0 0 483.2 195.7"
      height="17"
      width="41"
      >
      <path
        fill="currentColor"
        d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
    </svg>
    <span class="govuk-footer__licence-description">
    All content is available under the
    <a
      class="govuk-footer__link"
      href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
      rel="license"
      >Open Government Licence v3.0</a>, except where otherwise stated
    </span>
  </div>
  <div class="govuk-footer__meta-item">
    <a
      class="govuk-footer__link govuk-footer__copyright-logo"
      href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
  </div>
</div>
</footer>

        </div>
      </div>
    </div>
  </body>
</html>