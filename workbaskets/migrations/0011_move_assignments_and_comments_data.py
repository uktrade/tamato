# Generated by Django 4.2.18 on 2025-03-04 17:31

from django.db import migrations


def forwards_move_assignments_and_comments(apps, schema_editor):
    """
    Forward migration operation:
    1. Move TaskAssignment instances with their associated Task data
       (i.e. WorkBasket) from the tasks package to instances of their new,
       simplified equivalent workbaskets.models.WorkBasketAssignment.
    2. Move Comment instances with their associated Task data
       (i.e. WorkBasket) from the tasks package to instances of their new,
       simplified equivalent workbaskets.models.WorkBasketComment.

    Notes:
       This migration moves both task.models.TaskAssignee and
       task.models.Comment instances because they both reference instances of
       the task.models.Task, which must all be cleaned up / deleted. Other
       approaches are possible, decomposing the two, but the current approach
       has the benefit of cleaning Task instances in a single, relatively
       simple atomic operation.
    """

    Comment = apps.get_model("tasks", "Comment")
    TaskAssignment = apps.get_model("tasks", "TaskAssignee")
    Task = apps.get_model("tasks", "Task")
    WorkBasketAssignment = apps.get_model("workbaskets", "WorkBasketAssignment")
    WorkBasketComment = apps.get_model("workbaskets", "WorkBasketComment")

    task_assignment_qs = TaskAssignment.objects.all()
    for task_assignment in task_assignment_qs:
        WorkBasketAssignment.objects.create(
            # created_at is an auto_now_add field so can't be copied.
            # updated_at is an auto_now field so can't be copied.
            workbasket=task_assignment.task.workbasket,
            user=task_assignment.user,
            assigned_by=task_assignment.user,
            assignment_type=task_assignment.assignment_type,
            unassigned_at=task_assignment.unassigned_at,
        )

    comments_qs = Comment.objects.all()
    for comment in comments_qs:
        WorkBasketComment.objects.create(
            # created_at is an auto_now_add field so can't be copied.
            # updated_at is an auto_now field so can't be copied.
            author=comment.author,
            content=comment.content,
            workbasket=comment.task.workbasket,
        )

    tasks_qs = Task.objects.all()

    tasks_qs.delete()
    task_assignment_qs.delete()
    comments_qs.delete()


class Migration(migrations.Migration):

    dependencies = [
        ("workbaskets", "0010_workbasketcomment_workbasketassignment"),
        ("tasks", "0002_comment"),
    ]

    operations = [
        migrations.RunPython(forwards_move_assignments_and_comments),
    ]
